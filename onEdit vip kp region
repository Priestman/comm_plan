function onEdit(e) {
  var sheet = e.source.getActiveSheet();
  var sheetName = sheet.getName();

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –ª–∏—Å—Ç–∞ —Ñ–æ—Ä–º–∞—Ç—É "–ú–µ—Å—è—Ü_–ì–æ–¥"
  var monthYearPattern = /^(January|February|March|April|May|June|July|August|September|October|November|December)_(\d{4})$/;
  if (!monthYearPattern.test(sheetName)) return;

var timeZone = Session.getScriptTimeZone();
var today = new Date();
var currentMonth = Utilities.formatDate(today, timeZone, "MMMM_yyyy");

var nextMonthDate = new Date(today.getFullYear(), today.getMonth() + 1, 1);
var nextMonth = Utilities.formatDate(nextMonthDate, timeZone, "MMMM_yyyy");
var previousMonthDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
var previousMonth = Utilities.formatDate(previousMonthDate, timeZone, "MMMM_yyyy");

if (![currentMonth, nextMonth].includes(sheetName)) return;

  // ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ —Ç–µ–∫—É—â–µ–º –∏ —Å–ª–µ–¥—É—é—â–µ–º –º–µ—Å—è—Ü–µ
  if (![currentMonth, nextMonth].includes(sheetName)) return;

  var range = e.range;
  var row = range.getRow();
  var column = range.getColumn();

  if (row === 1) {
    protectHeaders(e);
    return;
  }

  var sheet = e.source.getActiveSheet();
  var headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];

  var statusCol = headers.indexOf("–°—Ç–∞—Ç—É—Å —Ä–∞—Å—Å—ã–ª–∫–∏") + 1;
  var trackCol = headers.indexOf("–¢—Ä–µ–∫") + 1;
  var geoCol = headers.indexOf("–ì–ï–û") + 1;
  var mirrorCol = headers.indexOf("–ó–µ—Ä–∫–∞–ª–æ") + 1;
  var dateCol = headers.indexOf("–î–∞—Ç–∞") + 1;
  var dayOfWeekCol = headers.indexOf("–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏") + 1;
  var pathCol = headers.indexOf("–ü—É—Ç—å") + 1;
  var linkTrackCol = headers.indexOf("–°—Å—ã–ª–∫–∞ + —Ç—Ä–µ–∫") + 1;
  var refTimeCol = headers.indexOf("–í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ –ú–°–ö") + 1;
  var geoNCol = headers.indexOf("–ì–ï–û_N") + 1;
  var channelNCol = headers.indexOf("–ö–∞–Ω–∞–ª_N") + 1;
  var timeNCol = headers.indexOf("–í—Ä–µ–º—è_N") + 1;
  var refChannelCol = headers.indexOf("–ö–∞–Ω–∞–ª") + 1;
  const notifTypeCol = headers.indexOf("–¢–∏–ø –Ω–æ—Ç–∏—Ñ–∞") + 1;
  const testCol = headers.indexOf("–¢–µ—Å—Ç—ã") + 1;
  const cdpCol = headers.indexOf("–ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ–≥–º–µ–Ω—Ç–∞ –≤ CDP") + 1;
  const channelCol = headers.indexOf("–ö–∞–Ω–∞–ª") + 1;
  const dutyCampaign = headers.indexOf("–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –∫–∞–º–ø–µ–π–Ω–µ—Ä") + 1;

  // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ/—Ä–∞—Å—Ç—è–≥–∏–≤–∞–Ω–∏–∏ "–ö–∞–Ω–∞–ª–∞"
  if (channelCol > 0 && row > 1 && column === channelCol) {
    const numRows = range.getNumRows();
    const channelValues = range.getValues();

    const notifTypeValues = notifTypeCol > 0 ? sheet.getRange(row, notifTypeCol, numRows, 1).getValues() : [];
    const testValues = testCol > 0 ? sheet.getRange(row, testCol, numRows, 1).getValues() : [];
    const cdpValues = cdpCol > 0 ? sheet.getRange(row, cdpCol, numRows, 1).getValues() : [];
    const campaignValues = dutyCampaign > 0 ? sheet.getRange(row, dutyCampaign, numRows, 1).getValues() : [];

    const updatedNotif = [];
    const updatedTests = [];
    const updatedCdp = [];
    const updateCampaign = [];

    for (let i = 0; i < numRows; i++) {
      const channel = (channelValues[i][0] || "").toString().trim();

      // –¢–∏–ø –Ω–æ—Ç–∏—Ñ–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è Notification)
      if (notifTypeCol > 0) {
        const currentNotif = (notifTypeValues[i]?.[0] || "").toString().trim();
        updatedNotif.push([!currentNotif && channel === "Notification" ? "–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π" : currentNotif]);
      }

      // –¢–µ—Å—Ç—ã (–¥–ª—è –≤—Å–µ—Ö –∫–∞–Ω–∞–ª–æ–≤, –µ—Å–ª–∏ –ø—É—Å—Ç–æ)
      if (testCol > 0) {
        const currentTest = (testValues[i]?.[0] || "").toString().trim();
        updatedTests.push([!currentTest ? "no" : currentTest]);
      }

      if (dutyCampaign > 0) {
        const currentDuty = (campaignValues[i]?.[0] || "").toString().trim();
        updateCampaign.push([!currentDuty ? "–°–∞—à–∞" : currentDuty]);
      }

      // –ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ–≥–º–µ–Ω—Ç–∞ –≤ CDP (–µ—Å–ª–∏ –ø—É—Å—Ç–æ)
      if (cdpCol > 0) {
        const currentCdp = (cdpValues[i]?.[0] || "").toString().trim();
        updatedCdp.push([!currentCdp ? "–≤—ã–≥—Ä—É–∑–∫–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–º" : currentCdp]);
      }
    }

    if (notifTypeCol > 0) sheet.getRange(row, notifTypeCol, numRows, 1).setValues(updatedNotif);
    if (testCol > 0) sheet.getRange(row, testCol, numRows, 1).setValues(updatedTests);
    if (cdpCol > 0) sheet.getRange(row, cdpCol, numRows, 1).setValues(updatedCdp);
    if (dutyCampaign > 0) sheet.getRange(row, dutyCampaign, numRows, 1).setValues(updateCampaign);
  }

  // ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–µ–∫–æ–≤ ‚Äî —Ç–µ–∫—É—â–∏–π + —Å–ª–µ–¥—É—é—â–∏–π + –ø—Ä–µ–¥—ã–¥—É—â–∏–π –º–µ—Å—è—Ü
  var previousMonthDate = new Date(today);
  previousMonthDate.setMonth(today.getMonth() - 1);
  var previousMonth = Utilities.formatDate(previousMonthDate, timeZone, "MMMM_yyyy");

  if ([statusCol, trackCol].includes(column)) {
    validateUniqueTrack(e, headers, [previousMonth, currentMonth, nextMonth]);
  }

  // ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–µ—Ä–∫–∞–ª–∞ –ø–æ –ì–ï–û
  if (geoCol > 0 && mirrorCol > 0 && (column === geoCol || range.getNumRows() > 1)) {
    updateMirrorColumn(sheet, range, geoCol, mirrorCol);
  }

  // ‚úÖ –î–µ–Ω—å –Ω–µ–¥–µ–ª–∏ –ø–æ –¥–∞—Ç–µ
  if (column === dateCol && dayOfWeekCol > 0) {
    updateDayOfWeek(sheet, range, dayOfWeekCol);
  }

    // ‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è/–ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è process_lable (–º–∞—Å—Å–æ–≤–æ –∏ –±—ã—Å—Ç—Ä–æ)
  generateProcessLabels(e, headers);

  // ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ "–°—Å—ã–ª–∫–∞ + —Ç—Ä–µ–∫"
  if ([mirrorCol, pathCol, trackCol].includes(column) && linkTrackCol > 0) {
    updateLinkAndTrack(sheet, range, mirrorCol, pathCol, trackCol, linkTrackCol);
  }

  // –û—Å—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
  clearStatusOnEdit(sheet, row, headers);
  validateDateAndDay(e, headers);
  validateGeo(e, headers);
  validatePathAndTrack(e, headers);
  validateNotificationType(e, headers);
  validateProcessLable(e, headers);
}

function generateProcessLabels(e, headers) {
  const sheet = e.source.getActiveSheet();
  const range = e.range;

  const dateCol   = headers.indexOf("–î–∞—Ç–∞") + 1;
  const chanCol   = headers.indexOf("–ö–∞–Ω–∞–ª") + 1;
  const statusCol = headers.indexOf("–°—Ç–∞—Ç—É—Å —Ä–∞—Å—Å—ã–ª–∫–∏") + 1;
  const labelCol  = headers.indexOf("process_lable") + 1;

  if (Math.min(dateCol, chanCol, statusCol, labelCol) < 1) return;

  // –¢—Ä–∏–≥–≥–µ—Ä—ã: –º–µ–Ω—è–ª–∞—Å—å –¥–∞—Ç–∞/–∫–∞–Ω–∞–ª/—Å—Ç–∞—Ç—É—Å/—Å–∞–º–∞ –º–µ—Ç–∫–∞ –∏–ª–∏ –º–∞—Å—Å–æ–≤–∞—è –≤—Å—Ç–∞–≤–∫–∞
  const editedCols = [dateCol, chanCol, statusCol, labelCol];
  if (!editedCols.includes(range.getColumn()) && range.getNumRows() === 1) return;

  const FIRST_ROW = 2;
  const lastRow = sheet.getLastRow();
  if (lastRow < FIRST_ROW) return;

  const nRows = lastRow - FIRST_ROW + 1;

  // –ß–∏—Ç–∞–µ–º –Ω—É–∂–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –æ–¥–Ω–∏–º –º–∞—Ö–æ–º (–º–∏–Ω–∏–º—É–º –∑–∞–ø—Ä–æ—Å–æ–≤)
  const dateVals   = sheet.getRange(FIRST_ROW, dateCol,   nRows, 1).getValues();
  const chanVals   = sheet.getRange(FIRST_ROW, chanCol,   nRows, 1).getValues();
  const statusVals = sheet.getRange(FIRST_ROW, statusCol, nRows, 1).getValues();
  const labelVals  = sheet.getRange(FIRST_ROW, labelCol,  nRows, 1).getValues();

  const tz = Session.getScriptTimeZone();

  const isEligibleChannel = (ch) => {
    const s = (ch || "").toString().trim().toLowerCase();
    return s === "wa/tg/sms" || s === "sms" || s === "whatsapp" || s === "telegram";
  };

  const isFrozen = (st) => {
    const s = (st || "").toString().trim().toLowerCase();
    return s === "—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∞" || s === "–≤—ã–ø–æ–ª–Ω–µ–Ω–∞" || s === "–æ—Ç–º–µ–Ω–µ–Ω–∞";
  };

  const toDDMM = (v) => {
    if (Object.prototype.toString.call(v) === "[object Date]") {
      return Utilities.formatDate(v, tz, "dd.MM");
    }
    return null;
  };

  const parseNum = (lbl) => {
    const m = /^4_\d{2}\.\d{2}_(\d+)$/.exec((lbl || "").toString().trim());
    return m ? parseInt(m[1], 10) : null;
  };

  const ddmmFromLabel = (lbl) => {
    const m = /^4_(\d{2}\.\d{2})_\d+$/.exec((lbl || "").toString().trim());
    return m ? m[1] : null;
  };

  // –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–µ—Ç–æ–∫ (–±—É–¥–µ–º –º–µ–Ω—è—Ç—å –∫–æ–ø–∏—é –∏ —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å)
  const newLabels = labelVals.map(r => [r[0]]);
  let changedAny = false;

  // 0) –û—á–∏—Å—Ç–∫–∞ —É –Ω–µ–∑–∞–º–æ—Ä–æ–∂–µ–Ω–Ω—ã—Ö: –Ω–µ—Ü–µ–ª–µ–≤–æ–π –∫–∞–Ω–∞–ª –∏–ª–∏ –Ω–µ—Ç –¥–∞—Ç—ã ‚Üí –ø—É—Å—Ç–æ
  for (let i = 0; i < nRows; i++) {
    const ddmm = toDDMM(dateVals[i][0]);
    const eligible = isEligibleChannel(chanVals[i][0]);
    const frozen = isFrozen(statusVals[i][0]);

    if (!frozen) {
      if (!eligible || !ddmm) {
        if (newLabels[i][0] !== "") {
          newLabels[i][0] = "";
          changedAny = true;
        }
      }
    }
  }

  // 1) –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ –¥–∞—Ç—ã:
  //    - –¥–∞—Ç—ã –∏–∑ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–≥–æ –±–ª–æ–∫–∞
  //    - –ø–ª—é—Å –ø—Ä–µ–¥—ã–¥—É—â–∞—è –¥–∞—Ç–∞ –∏–∑ —Å—Ç–∞—Ä–æ–π –º–µ—Ç–∫–∏ (–µ—Å–ª–∏ –¥–∞—Ç–∞ —Å–º–µ–Ω–∏–ª–∞—Å—å)
  const affected = new Set();

  const addAffectedByRange = () => {
    const start = range.getRow() - FIRST_ROW;              // –∏–Ω–¥–µ–∫—Å –≤ 0-–±–∞–∑–µ
    const count = range.getNumRows();
    for (let k = 0; k < count; k++) {
      const i = start + k;
      if (i < 0 || i >= nRows) continue;
      const nowD = toDDMM(dateVals[i][0]);
      if (nowD) affected.add(nowD);
      const oldD = ddmmFromLabel(labelVals[i][0]);
      if (oldD && oldD !== nowD) affected.add(oldD);
    }
  };

  // –ï—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–ª–∏ –∫–æ–ª–æ–Ω–∫—É –¥–∞—Ç—ã ‚Äî –±–µ—Ä—ë–º —Ä–µ–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ –Ω–µ—ë
  if (editedCols.includes(dateCol)) {
    addAffectedByRange();
  } else {
    // –ú–µ–Ω—è–ª–∏ –∫–∞–Ω–∞–ª/—Å—Ç–∞—Ç—É—Å/–º–∞—Å—Å–æ–≤–æ –≤—Å—Ç–∞–≤–ª—è–ª–∏ ‚Äî –±–µ—Ä—ë–º –¥–∞—Ç—ã —Å—Ç—Ä–æ–∫ –∏–∑ –¥–∏–∞–ø–∞–∑–æ–Ω–∞
    addAffectedByRange();
  }

  // –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–∏–ª–∏ (—Ä–µ–¥–∫–∞—è —Å–∏—Ç—É–∞—Ü–∏—è) ‚Äî –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –≤—ã—Ö–æ–¥
  if (affected.size === 0) {
    if (changedAny) {
      sheet.getRange(FIRST_ROW, labelCol, nRows, 1).setValues(newLabels);
    }
    return;
  }

  // 2) –î–ª—è –∫–∞–∂–¥–æ–π –∑–∞—Ç—Ä–æ–Ω—É—Ç–æ–π –¥–∞—Ç—ã:
  //    - —Å–æ–±–∏—Ä–∞–µ–º –∑–∞–Ω—è—Ç—ã–µ –Ω–æ–º–µ—Ä–∞ (–∑–∞–º–æ—Ä–æ–∂–µ–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏)
  //    - —Ñ–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –Ω–µ–∑–∞–º–æ—Ä–æ–∂–µ–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫ —Ü–µ–ª–µ–≤—ã—Ö –∫–∞–Ω–∞–ª–æ–≤
  affected.forEach(ddmm => {
    const used = new Set();    // –Ω–æ–º–µ—Ä–∞, –∑–∞–Ω—è—Ç—ã–µ –∑–∞–º–æ—Ä–æ–∂–µ–Ω–Ω—ã–º–∏
    const activeRows = [];     // –∏–Ω–¥–µ–∫—Å—ã –Ω–µ–∑–∞–º–æ—Ä–æ–∂–µ–Ω–Ω—ã—Ö –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è

    for (let i = 0; i < nRows; i++) {
      const d = toDDMM(dateVals[i][0]);
      if (d !== ddmm) continue;
      if (!isEligibleChannel(chanVals[i][0])) continue;

      if (isFrozen(statusVals[i][0])) {
        const num = parseNum(labelVals[i][0]);
        if (num != null) used.add(num); // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–º–µ—Ä–∞ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å—Ç—Ä–æ–∫
      } else {
        activeRows.push(i);
      }
    }

    // –ù—É–º–µ—Ä–∞—Ü–∏—è —Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑, —Å –ø—Ä–æ–ø—É—Å–∫–æ–º –∑–∞–Ω—è—Ç—ã—Ö –Ω–æ–º–µ—Ä–æ–≤
    let next = 1;
    const nextFree = () => {
      while (used.has(next)) next++;
      const ret = next;
      used.add(ret);
      next++;
      return ret;
    };

    for (const i of activeRows) {
      const newVal = `4_${ddmm}_${nextFree()}`;
      if (newLabels[i][0] !== newVal) {
        newLabels[i][0] = newVal;
        changedAny = true;
      }
    }
  });

  // 3) –û–¥–Ω–∞ –º–∞—Å—Å–æ–≤–∞—è –∑–∞–ø–∏—Å—å (–µ—Å–ª–∏ –µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è)
  if (changedAny) {
    sheet.getRange(FIRST_ROW, labelCol, nRows, 1).setValues(newLabels);
  }
}


function validateDateAndDay(e, headers) {
  var sheet = e.source.getActiveSheet();
  var sheetName = sheet.getName();
  var range = e.range;
  var column = range.getColumn();
  var row = range.getRow();

  var dateCol = headers.indexOf("–î–∞—Ç–∞") + 1;
  var dayOfWeekCol = headers.indexOf("–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏") + 1;

  if (column !== dateCol) return;

  var dateValue = range.getValue();

  if (Object.prototype.toString.call(dateValue) === "[object Date]") {
    var daysShort = ["–≤—Å", "–ø–Ω", "–≤—Ç", "—Å—Ä", "—á—Ç", "–ø—Ç", "—Å–±"];
    var dayShort = daysShort[dateValue.getDay()];
    sheet.getRange(row, dayOfWeekCol).setValue(dayShort); // –≤—Å—Ç–∞–≤–ª—è–µ–º –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏

    // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –ª–∏—Å—Ç–∞ –∏ –º–µ—Å—è—Ü –∏–∑ –¥–∞—Ç—ã
    var timeZone = Session.getScriptTimeZone();
    var monthFromDate = Utilities.formatDate(dateValue, timeZone, "MMMM_yyyy");

    if (monthFromDate !== sheetName) {
      range.setBackground("#FFCDD2");
      range.setNote("–û—à–∏–±–∫–∞: –¥–∞—Ç–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö " + sheetName);
    } else {
      range.setBackground(null);
      range.setNote("");
    }
  } else {
    sheet.getRange(row, dayOfWeekCol).setValue(""); // –µ—Å–ª–∏ –¥–∞—Ç–∞ —É–¥–∞–ª–µ–Ω–∞ ‚Äî –æ—á–∏—â–∞–µ–º
  }
}



function validateGeo(e, headers) {
    var sheet = e.source.getActiveSheet();
    var range = e.range;
    var column = range.getColumn();
    var row = range.getRow();

    var geoCol = headers.indexOf("–ì–ï–û") + 1;
    if (column !== geoCol) return;

    var scriptProperties = PropertiesService.getScriptProperties();
    var geoDataJson = scriptProperties.getProperty("geo_list_data");

    if (!geoDataJson) {
        Logger.log("‚ö† geo_list_data –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω.");
        return;
    }

    var geoData = JSON.parse(geoDataJson);
    var allowedGeo = new Set(geoData.allowedGeo);
    var geoGroups = geoData.geoGroups;

    var cellValue = range.getValue().trim();
    if (!cellValue) return;

    var geoValues = cellValue.split(",").map(s => s.trim());
    var isValid = true;
    var invalidValues = [];

    geoValues.forEach(value => {
        if (value === "ALL") {
            if (geoValues.length > 1) {
                isValid = false;
                invalidValues.push(value + " (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º)");
            }
        } else if (!allowedGeo.has(value) && !geoGroups[value]) {
            isValid = false;
            invalidValues.push(value);
        }
    });

    if (!isValid) {
        range.setBackground("#FFCDD2");
        range.setNote("–û—à–∏–±–∫–∞: –≤—ã –≤–≤–µ–ª–∏ –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (–Ω–µ—Ç –≤ –º–∞—Å—Å–∏–≤–µ –¥–ª—è –ö–ü) –∏–ª–∏ –Ω–µ–≤–µ—Ä–Ω—ã–µ –ì–ï–û ‚Üí " + invalidValues.join(", "));
    } else {
        range.setBackground(null);
        range.setNote("");
    }
}


function validatePathAndTrack(e, headers) {
  const sheet = e.source.getActiveSheet();
  const range = e.range;
  const column = range.getColumn();
  const startRow = range.getRow();
  const numRows = range.getNumRows();

  const pathCol = headers.indexOf("–ü—É—Ç—å") + 1;
  const trackCol = headers.indexOf("–¢—Ä–µ–∫") + 1;

  if (![pathCol, trackCol].includes(column)) return;

  const pathValues = sheet.getRange(startRow, pathCol, numRows, 1).getValues();
  const trackValues = sheet.getRange(startRow, trackCol, numRows, 1).getValues();

  const updatedTrackValues = [];
  let needsUpdate = false;

  for (let i = 0; i < numRows; i++) {
    let path = (pathValues[i][0] || "").toString().trim();
    let track = (trackValues[i][0] || "").toString().trim();

    if (!track) {
      // –ù–∏—á–µ–≥–æ –Ω–µ –∑–∞—Ç–∏—Ä–∞–µ–º, –ø—Ä–æ—Å—Ç–æ –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å
      updatedTrackValues.push([track]);
      continue;
    }

    const originalTrack = track;

    // –ï—Å–ª–∏ track ‚Äî —ç—Ç–æ ID –±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
    if (!track.includes("?") && !track.includes("&") && !track.includes("=")) {
      const prefix = path.includes("?") ? "&trid=" : "?trid=";
      track = prefix + track;
    }

    // –ü—Ä–∏–≤–æ–¥–∏–º –∫ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–º—É –≤–∏–¥—É –Ω–∞—á–∞–ª–∞
    const expectedStart = path.includes("?") ? "&" : "?";
    if (!track.startsWith("?") && !track.startsWith("&")) {
      track = expectedStart + track.replace(/^[^a-zA-Z0-9]/, "");
    }

    if (track !== originalTrack) needsUpdate = true;

    updatedTrackValues.push([track]);
  }

  if (needsUpdate) {
    sheet.getRange(startRow, trackCol, numRows, 1).setValues(updatedTrackValues);
  }
}




function validateNotificationType(e, headers) {
    var sheet = e.source.getActiveSheet();
    var range = e.range;
    var row = range.getRow();
    var column = range.getColumn();
  
    var channelCol = headers.indexOf("–ö–∞–Ω–∞–ª") + 1;
    var notifTypeCol = headers.indexOf("–¢–∏–ø –Ω–æ—Ç–∏—Ñ–∞") + 1;

    if (channelCol < 1 || notifTypeCol < 1) return; // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å—Ç–æ–ª–±—Ü—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç
    if (![channelCol, notifTypeCol].includes(column)) return; // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —ç—Ç–∏—Ö –∫–æ–ª–æ–Ω–∫–∞—Ö

    var rowData = sheet.getRange(row, 1, 1, sheet.getLastColumn()).getValues()[0];
    var channelValue = rowData[channelCol - 1]?.trim();
    var notifTypeCell = sheet.getRange(row, notifTypeCol);
    var notifTypeValue = notifTypeCell.getValue()?.trim();

    if (channelValue === "Notification") {
        if (!notifTypeValue) {
            notifTypeCell.setBackground("#FFCDD2"); // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –∫—Ä–∞—Å–Ω—ã–º
            notifTypeCell.setNote("‚ùå –û—à–∏–±–∫–∞: –ø–æ–ª–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è Notification");
        } else {
            notifTypeCell.setBackground(null); // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –æ—à–∏–±–∫–∏
            notifTypeCell.setNote("");
        }
    } else {
        if (notifTypeValue) {
            notifTypeCell.setValue(""); // –û—á–∏—â–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ
        }
        notifTypeCell.setBackground(null); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ–Ω
        notifTypeCell.setNote(""); // –û—á–∏—â–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
    }
}

function protectHeaders(e) {
    var sheet = e.source.getActiveSheet();
    var range = e.range;
    var row = range.getRow();

    if (row !== 1) return; // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—É—é —Å—Ç—Ä–æ–∫—É (–∑–∞–≥–æ–ª–æ–≤–∫–∏)

    var protectedHeaders = [
        "communication_id", "–î–∞—Ç–∞", "–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏", "–°—Ç–∞—Ç—É—Å —Ä–∞—Å—Å—ã–ª–∫–∏", "–í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ –ú–°–ö", 
        "–ö–∞–Ω–∞–ª", "–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ", "–¢–µ–º–∞ —Ä–∞—Å—Å—ã–ª–∫–∏", "–ì–ï–û", "–ì–ï–û –ø–µ—Ä–µ–≤–æ–¥—ã", "–ì—Ä—É–ø–ø–∞ —Å–µ–≥–º–µ–Ω—Ç–æ–≤", 
        "–ü–æ–¥—Å–µ–≥–º–µ–Ω—Ç", "–¢–µ—Å—Ç—ã", "–¢–∏–ø –Ω–æ—Ç–∏—Ñ–∞", "–ü—É—Ç—å", "–¢—Ä–µ–∫","–ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ–≥–º–µ–Ω—Ç–∞ –≤ CDP", "process_lable", "–í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ –ú–°–ö", 
        "–°—Å—ã–ª–∫–∞ + —Ç—Ä–µ–∫", "–ó–µ—Ä–∫–∞–ª–æ", "–ü—É—Ç—å"
    ];

    var headersRange = sheet.getRange(1, 1, 1, sheet.getLastColumn());
    var currentHeaders = headersRange.getValues()[0]; // –ë–µ—Ä—ë–º —Ç–µ–∫—É—â–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏
    var oldHeaders = JSON.parse(PropertiesService.getScriptProperties().getProperty("saved_headers") || "{}");

    var column = range.getColumn();
    var newValue = range.getValue().trim();
    var oldValue = oldHeaders[column] || "";

    if (protectedHeaders.includes(oldValue) && newValue !== oldValue) {
        Browser.msgBox("‚ö†Ô∏è –û—à–∏–±–∫–∞: '" + oldValue + "' –Ω–µ–ª—å–∑—è –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞—Ç—å.");
        sheet.getRange(1, column).setValue(oldValue); // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ (–µ—Å–ª–∏ –≤—Å—ë —Ö–æ—Ä–æ—à–æ)
    var updatedHeaders = {};
    for (var i = 0; i < currentHeaders.length; i++) {
        if (currentHeaders[i]) { // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏
            updatedHeaders[i + 1] = currentHeaders[i].trim();
        }
    }
    PropertiesService.getScriptProperties().setProperty("saved_headers", JSON.stringify(updatedHeaders));
}

function validateProcessLable(e, headers) {
    var sheet = e.source.getActiveSheet();
    var range = e.range;
    var row = range.getRow();
    var column = range.getColumn();

    var channelCol = headers.indexOf("–ö–∞–Ω–∞–ª") + 1;
    var processLabelCol = headers.indexOf("process_lable") + 1;

    if (channelCol < 1 || processLabelCol < 1) return;
    if (![channelCol, processLabelCol].includes(column)) return; // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —ç—Ç–∏—Ö –∫–æ–ª–æ–Ω–∫–∞—Ö

    var channelValue = sheet.getRange(row, channelCol).getValue().toString().trim();
    var processLabelCell = sheet.getRange(row, processLabelCol);
    var processLabelValue = processLabelCell.getValue().toString().trim();

    if ((channelValue === "Whatsapp" || channelValue === "SMS" || channelValue === "WA/TG/SMS") && !processLabelValue) {
        processLabelCell.setBackground("#FFCDD2");
        processLabelCell.setNote("‚ùå –û—à–∏–±–∫–∞: 'process_lable' –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è " + channelValue);
    } else if (channelValue !== "Whatsapp" && channelValue !== "SMS" && channelValue !== "WA/TG/SMS" && processLabelValue) {
        processLabelCell.setBackground("#FFCDD2");
        processLabelCell.setNote("‚ùå –û—à–∏–±–∫–∞: 'process_lable' –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—É—Å—Ç—ã–º –¥–ª—è " + channelValue);
    } else {
        processLabelCell.setBackground(null);
        processLabelCell.setNote(""); // –û—á–∏—â–∞–µ–º note –ø—Ä–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –æ—à–∏–±–∫–∏
    }
}

function clearStatusOnEdit(sheet, row, headers) {
    var statusCol = headers.indexOf("–ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Å—Ç—Ä–æ–∫–∏") + 1;
    if (statusCol < 1) return; // –ï—Å–ª–∏ –Ω–µ—Ç —Å—Ç–æ–ª–±—Ü–∞, –≤—ã—Ö–æ–¥–∏–º

    var statusCell = sheet.getRange(row, statusCol);
    var statusValue = statusCell.getValue().toString().trim();

    if (statusValue && statusValue !== "–ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –≤ –ë–î") {
        statusCell.setValue(""); // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ç—É—Å, –µ—Å–ª–∏ –æ–Ω –Ω–µ "–ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –≤ –ë–î"
    }
}

function validateUniqueTrack(e, headers, months) {
    var sheet = e.source.getActiveSheet();
    var range = e.range;
    var row = range.getRow();

    var statusCol = headers.indexOf("–°—Ç–∞—Ç—É—Å —Ä–∞—Å—Å—ã–ª–∫–∏") + 1;
    var trackCol = headers.indexOf("–¢—Ä–µ–∫") + 1;

    if (trackCol < 1 || statusCol < 1) return;

    var statusValue = sheet.getRange(row, statusCol).getValue();
    var trackValue = sheet.getRange(row, trackCol).getValue().trim();

    if (!trackValue ) return;

    function extractTrackId(track) {
        if (!track) return "";
        var match = track.match(/=(.+)$/);
        return match ? match[1].trim() : track.trim();
    }

    var normalizedTrack = extractTrackId(trackValue);
    var spreadsheet = sheet.getParent();
    var allTracks = new Map(); // –ò—Å–ø–æ–ª—å–∑—É–µ–º Map –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è {—Ç—Ä–µ–∫: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—Ö–æ–∂–¥–µ–Ω–∏–π}

    Logger.log("üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–µ–∫–∞: " + trackValue + " ‚Üí –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π: " + normalizedTrack);

    months.forEach(month => {
        var sheetByMonth = spreadsheet.getSheetByName(month);
        if (sheetByMonth) {
            var lastRow = sheetByMonth.getLastRow();
            Logger.log("üìÑ –õ–∏—Å—Ç: " + month + " | –ü–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç—Ä–æ–∫–∞: " + lastRow);

            if (lastRow > 1) {
                var rangeValues = sheetByMonth.getRange(2, trackCol, lastRow - 1, 1).getValues();

                rangeValues.flat().forEach((track, index) => {
                    if (track) {
                        var normalized = extractTrackId(track.toString());

                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –Ω–∞—à–∞ –ª–∏ —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞
                        var trackRow = index + 2; // +2, –ø–æ—Ç–æ–º—É —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å–æ 2-–π —Å—Ç—Ä–æ–∫–∏
                        if (month === sheet.getName() && trackRow === row) return; 

                        // –î–æ–±–∞–≤–ª—è–µ–º —Ç—Ä–µ–∫ –≤ Map, —É–≤–µ–ª–∏—á–∏–≤–∞—è —Å—á–µ—Ç—á–∏–∫
                        allTracks.set(normalized, (allTracks.get(normalized) || 0) + 1);
                    }
                });

                Logger.log("üìå –¢—Ä–µ–∫–∏ –Ω–∞ –ª–∏—Å—Ç–µ " + month + ": " + JSON.stringify([...allTracks]));
            }
        } else {
            Logger.log("‚ö† –õ–∏—Å—Ç '" + month + "' –Ω–µ –Ω–∞–π–¥–µ–Ω.");
        }
    });

    Logger.log("‚úÖ –§–∏–Ω–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ç—Ä–µ–∫–æ–≤ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è: " + JSON.stringify([...allTracks]));

    var trackCell = sheet.getRange(row, trackCol);

    if (allTracks.has(normalizedTrack)) {
        Logger.log("‚ùå –ù–∞–π–¥–µ–Ω –¥—É–±–ª–∏–∫–∞—Ç —Ç—Ä–µ–∫–∞: " + normalizedTrack);
        trackCell.setBackground("#FFCDD2");
        trackCell.setNote("–û—à–∏–±–∫–∞: –¥—É–±–ª–∏—Ä—É—é—â–∏–π—Å—è —Ç—Ä–µ–∫ –≤ –æ–¥–Ω–æ–º –∏–∑ –º–µ—Å—è—Ü–µ–≤.");
    } else {
        Logger.log("‚úÖ –¢—Ä–µ–∫ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π: " + normalizedTrack);
        trackCell.setBackground(null);
        trackCell.setNote("");
    }
}

function updateMirrorColumn(sheet, range, geoCol, mirrorCol) {
    var numRows = range.getNumRows();
    var startRow = range.getRow();
    var geoValues = sheet.getRange(startRow, geoCol, numRows, 1).getValues();
    var mirrorValues = sheet.getRange(startRow, mirrorCol, numRows, 1).getValues();
    var outputValues = [];

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫—ç—à –∑–µ—Ä–∫–∞–ª –∏–∑ ScriptProperties (—á—Ç–æ–±—ã –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞—Ç—å —Ñ–∞–π–ª)
    var cachedMirrors = getCachedMirrors();

    for (var i = 0; i < numRows; i++) {
        var geoValue = geoValues[i][0] ? geoValues[i][0].toString().trim() : "";
        var mirrorValue = mirrorValues[i][0] ? mirrorValues[i][0].toString().trim() : "";

        // üõ† **–§–∏–∫—Å –±–∞–≥–∞:** –ï—Å–ª–∏ –ì–ï–û –ø—É—Å—Ç–æ–µ, –æ—á–∏—â–∞–µ–º "–ó–µ—Ä–∫–∞–ª–æ"
        if (!geoValue) {
            outputValues.push([""]); 
            continue;
        }

        // –ï—Å–ª–∏ –ì–ï–û —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–Ω–∞—á–µ–Ω–∏–π ‚Äì –Ω–µ –∑–∞–ø–æ–ª–Ω—è–µ–º –∑–µ—Ä–∫–∞–ª–æ
        if (geoValue.includes(",")) {
            outputValues.push([""]);
            continue;
        }

        var newMirror = cachedMirrors[geoValue] || "";

        // –ï—Å–ª–∏ –∑–µ—Ä–∫–∞–ª–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å, –æ–±–Ω–æ–≤–ª—è–µ–º
        if (newMirror !== mirrorValue) {
            outputValues.push([newMirror]);
        } else {
            outputValues.push([mirrorValue]); // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
        }
    }

    // üîπ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —Ä–∞–∑–æ–º (–±—ã—Å—Ç—Ä–µ–µ)
    sheet.getRange(startRow, mirrorCol, outputValues.length, 1).setValues(outputValues);
}



// üìå –ó–∞–≥—Ä—É–∂–∞–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∑–µ—Ä–∫–∞–ª
function getCachedMirrors() {
    var cachedData = PropertiesService.getScriptProperties().getProperty("geo_mirror_cache");
    if (!cachedData) return {};

    return JSON.parse(cachedData);
}




function updateDayOfWeek(sheet, range, dayOfWeekCol) {
    var editedValues = range.getValues(); // –ü–æ–ª—É—á–∞–µ–º –º–∞—Å—Å–∏–≤ –∑–Ω–∞—á–µ–Ω–∏–π
    var outputValues = [];
    
    var daysShort = ["–≤—Å", "–ø–Ω", "–≤—Ç", "—Å—Ä", "—á—Ç", "–ø—Ç", "—Å–±"];

    for (var i = 0; i < editedValues.length; i++) {
        var dateValue = editedValues[i][0];

        if (Object.prototype.toString.call(dateValue) === "[object Date]") {
            var dayShort = daysShort[dateValue.getDay()];
            outputValues.push([dayShort]); // –î–æ–±–∞–≤–ª—è–µ–º –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏
        } else {
            outputValues.push([""]); // –ï—Å–ª–∏ –¥–∞—Ç–∞ —É–¥–∞–ª–µ–Ω–∞ ‚Äì –æ—á–∏—â–∞–µ–º "–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏"
        }
    }

    // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è —Ä–∞–∑–æ–º
    sheet.getRange(range.getRow(), dayOfWeekCol, outputValues.length, 1).setValues(outputValues);
}

function updateLinkAndTrack(sheet, range, mirrorCol, pathCol, trackCol, linkTrackCol) {
    var numRows = range.getNumRows();
    var startRow = range.getRow();

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è)
    var mirrorValues = sheet.getRange(startRow, mirrorCol, numRows, 1).getValues();
    var pathValues = sheet.getRange(startRow, pathCol, numRows, 1).getValues();
    var trackValues = sheet.getRange(startRow, trackCol, numRows, 1).getValues();
    var existingLinkValues = sheet.getRange(startRow, linkTrackCol, numRows, 1).getValues();

    var outputValues = [];
    var needsUpdate = false;

    for (var i = 0; i < numRows; i++) {
        // –ó–¥–µ—Å—å –º—ã –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º mirrorValues - –î–æ—Ä–∞–±–æ—Ç–∫–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è VIP KP - https://01tech.atlassian.net/browse/CRMVIP-1744
        // var mirror = mirrorValues[i][0] ? mirrorValues[i][0].toString().trim() : "";
        var path = pathValues[i][0] ? pathValues[i][0].toString().trim() : "";
        var track = trackValues[i][0] ? trackValues[i][0].toString().trim() : "";

        // üîπ –§–æ—Ä–º–∏—Ä—É–µ–º "–°—Å—ã–ª–∫–∞ + —Ç—Ä–µ–∫" –±–µ–∑ "–ó–µ—Ä–∫–∞–ª–∞"
        var newLinkTrack = path + track;

        // üîπ –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ
        if (newLinkTrack !== existingLinkValues[i][0]) {
            outputValues.push([newLinkTrack]);
            needsUpdate = true;
        } else {
            outputValues.push([existingLinkValues[i][0]]); // –û—Å—Ç–∞–≤–ª—è–µ–º –ø—Ä–µ–∂–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
        }
    }

    // üîπ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
    if (needsUpdate) {
        sheet.getRange(startRow, linkTrackCol, outputValues.length, 1).setValues(outputValues);
    }
}



function updateDuplicateColumns(sheet, row, refGeoCol, refChannelCol, refTimeCol, geoNCol, channelNCol, timeNCol) {
    var refGeo = sheet.getRange(row, refGeoCol).getValue();
    var refChannel = sheet.getRange(row, refChannelCol).getValue();
    var refTime = sheet.getRange(row, refTimeCol).getValue();

    if (geoNCol > 0) sheet.getRange(row, geoNCol).setValue(refGeo);
    if (channelNCol > 0) sheet.getRange(row, channelNCol).setValue(refChannel);
    if (timeNCol > 0) sheet.getRange(row, timeNCol).setValue(refTime);
}



function updateDuplicateColumns(sheet, row, refGeoCol, refChannelCol, refTimeCol, geoNCol, channelNCol, timeNCol) {
    var refGeo = sheet.getRange(row, refGeoCol).getValue();
    var refChannel = sheet.getRange(row, refChannelCol).getValue();
    var refTime = sheet.getRange(row, refTimeCol).getValue();

    if (geoNCol > 0) sheet.getRange(row, geoNCol).setValue(refGeo);
    if (channelNCol > 0) sheet.getRange(row, channelNCol).setValue(refChannel);
    if (timeNCol > 0) sheet.getRange(row, timeNCol).setValue(refTime);
}


function extractTrackIdId(rawTrack) {
  if (!rawTrack) return "";
  const match = rawTrack.match(/(?:\?|&)trid=([^&]+)/);
  return match ? match[1].trim() : rawTrack.trim();
}
