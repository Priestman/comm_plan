/**
 * –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤—ã–ø–∞–¥–∞—é—â–∏–º–∏ —Å–ø–∏—Å–∫–∞–º–∏ –¥–ª—è –ö–ü —Ñ–∞–π–ª–æ–≤
 * –ò—Å—Ç–æ—á–Ω–∏–∫: 1JHFCWOj4A82dSNeLHb68B5JHHPxfvHHxg8_e4tjjQtY, –ª–∏—Å—Ç content_type 
 */

// –ö–û–ù–°–¢–ê–ù–¢–´
const CONFIG_update = {
  SOURCE_FILE_ID: '1JHFCWOj4A82dSNeLHb68B5JHHPxfvHHxg8_e4tjjQtY',
  SOURCE_SHEET_NAME: 'content_type',
  VALIDATION_SHEET_NAME: '_ValidationLists',
  
  COLUMNS_TO_VALIDATE: ['GENERAL', 'TYPE', 'SUBJECT'],
  
  // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
  MAX_VALIDATION_ROWS: 2000,  // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
  BUFFER_ROWS: 50,            // –ë—É—Ñ–µ—Ä–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
  DEBUG_MODE: false           // –û—Ç–∫–ª—é—á–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏
};

// –ö–µ—à –¥–ª—è –æ—Ç–∫—Ä—ã—Ç—ã—Ö —Ñ–∞–π–ª–æ–≤
const fileCache = new Map();

/**
 * –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø - –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –Ω–æ–º–µ—Ä–∞ –∫–æ–ª–æ–Ω–∫–∏ –≤ –±—É–∫–≤—É
 */
function columnToLetter(column) {
  let temp, letter = '';
  while (column > 0) {
    temp = (column - 1) % 26;
    letter = String.fromCharCode(temp + 65) + letter;
    column = (column - temp - 1) / 26;
  }
  return letter;
}

/**
 * –ö–ï–®–ò–†–û–í–ê–ù–ò–ï –§–ê–ô–õ–û–í - –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Ñ–∞–π–ª —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
 */
function getWorkFile(kpId) {
  if (!fileCache.has(kpId)) {
    try {
      const file = SpreadsheetApp.openById(kpId);
      fileCache.set(kpId, file);
    } catch (error) {
      throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª ${kpId}: ${error.message}`);
    }
  }
  return fileCache.get(kpId);
}

/**
 * –û–ß–ò–°–¢–ö–ê –ö–ï–®–ê - –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ –∫–æ–Ω—Ü–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
 */
function clearFileCache() {
  fileCache.clear();
}

/**
 * –°–û–ó–î–ê–ù–ò–ï –ö–ê–°–¢–û–ú–ù–û–ì–û –ú–ï–ù–Æ
 */
function onOpen() {
  const ui = SpreadsheetApp.getUi();
  ui.createMenu('üìã –ö–ü –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ')
    .addItem('üîÑ –û–±–Ω–æ–≤–∏—Ç—å –≤—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏', 'showUpdateSidebar')
    .addItem('‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å', 'showUniquenessCheck')
    .addItem('üìä –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É', 'showStatistics')
    .addToUi();
}

/**
 * –ì–õ–ê–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤ (–û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–ê–Ø)
 */
function updateValidationLists() {
  const logs = [];
  const startTime = Date.now();
  
  try {
    logs.push('üöÄ –ù–∞—á–∞–ª–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤');
    
    // –û—á–∏—â–∞–µ–º –∫–µ—à —Ñ–∞–π–ª–æ–≤
    clearFileCache();
    
    // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    const validationData = loadAndProcessSourceData();
    logs.push(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${validationData.general.length} GENERAL, ${validationData.type.length} TYPE, ${Object.keys(validationData.subjects).length} —Ä–µ–≥–∏–æ–Ω–æ–≤ SUBJECT`);
    
    // 2. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Å–ª—É–∂–µ–±–Ω—ã–π –ª–∏—Å—Ç
    saveValidationDataToSheet(validationData);
    logs.push('‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ —Å–ª—É–∂–µ–±–Ω—ã–π –ª–∏—Å—Ç');
    
    // 3. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Å—è—Ü—ã –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
    const months = getCurrentAndNextMonth();
    logs.push(`üìÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–µ—Å—è—Ü–µ–≤: ${months.current}, ${months.next}`);
    
    // 4. –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ö–ü
    const activeKPs = GetActiveKPs();
    logs.push(`üìã –ó–∞–≥—Ä—É–∂–µ–Ω–æ –ö–ü: ${activeKPs.length}`);
    
    // 5. –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª—ã –ö–ü
    const validKPs = activeKPs.filter(kp => validationData.subjects[kp.name]);
    logs.push(`üìÅ –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∂–∞–µ–º ${validKPs.length} —Ñ–∞–π–ª–æ–≤ –ö–ü...`);
    
    const preloadStart = Date.now();
    validKPs.forEach(kp => {
      try {
        getWorkFile(kp.id_work); // –ö–µ—à–∏—Ä—É–µ–º —Ñ–∞–π–ª
      } catch (error) {
        logs.push(`‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª –ö–ü ${kp.name}: ${error.message}`);
      }
    });
    logs.push(`‚úÖ –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –∑–∞ ${Date.now() - preloadStart}ms`);
    
    // 6. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—ã–π –ö–ü (–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ)
    let processedCount = 0;
    let skippedCount = 0;
    
    for (const kp of activeKPs) {
      try {
        const kpLogs = processKPOptimized(kp, months, validationData);
        logs.push(...kpLogs);
        
        if (kpLogs.some(log => log.includes('‚úÖ'))) {
          processedCount++;
        } else {
          skippedCount++;
        }
        
      } catch (error) {
        logs.push(`‚ùå –û—à–∏–±–∫–∞ –ö–ü ${kp.name}: ${error.message}`);
        skippedCount++;
      }
    }
    
    // 7. –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    const totalTime = Date.now() - startTime;
    logs.push('');
    logs.push('=== –ò–¢–û–ì–û–í–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê ===');
    logs.push(`–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: ${totalTime}ms`);
    logs.push(`–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –ö–ü: ${processedCount}`);
    logs.push(`–ü—Ä–æ–ø—É—â–µ–Ω–æ –ö–ü: ${skippedCount}`);
    logs.push(`–û–±–Ω–æ–≤–ª–µ–Ω–æ —Å–ø–∏—Å–∫–æ–≤: GENERAL (${validationData.general.length}), TYPE (${validationData.type.length}), SUBJECT (${Object.keys(validationData.subjects).length} —Ä–µ–≥–∏–æ–Ω–æ–≤)`);
    logs.push('‚úÖ –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û');
    
  } catch (error) {
    logs.push(`‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: ${error.message}`);
    console.error('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:', error);
  } finally {
    // –û—á–∏—â–∞–µ–º –∫–µ—à –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ
    clearFileCache();
  }
  
  return logs;
}

/**
 * –ó–∞–≥—Ä—É–∑–∫–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
 */
function loadAndProcessSourceData() {
  const sourceFile = SpreadsheetApp.openById(CONFIG_update.SOURCE_FILE_ID);
  const sourceSheet = sourceFile.getSheetByName(CONFIG_update.SOURCE_SHEET_NAME);
  
  if (!sourceSheet) {
    throw new Error(`–õ–∏—Å—Ç "${CONFIG_update.SOURCE_SHEET_NAME}" –Ω–µ –Ω–∞–π–¥–µ–Ω`);
  }
  
  const data = sourceSheet.getDataRange().getValues();
  const headers = data[0];
  
  // –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å—ã –∫–æ–ª–æ–Ω–æ–∫
  const indices = {
    general: headers.indexOf('GENERAL'),
    type: headers.indexOf('TYPE'),
    subject: headers.indexOf('SUBJECT_UNIQ'),
    regions: headers.indexOf('REGIONS')
  };
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –≤—Å–µ—Ö –∫–æ–ª–æ–Ω–æ–∫
  if (Object.values(indices).includes(-1)) {
    throw new Error('–ù–µ –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –Ω–∞–π–¥–µ–Ω—ã –≤ –∏—Å—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö');
  }
  
  // –°–æ–±–∏—Ä–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
  const generalSet = new Set();
  const typeSet = new Set();
  const subjectsByRegion = {};
  
  for (let i = 1; i < data.length; i++) {
    const row = data[i];
    
    const general = String(row[indices.general] || '').trim();
    const type = String(row[indices.type] || '').trim();
    const subject = String(row[indices.subject] || '').trim();
    const regions = String(row[indices.regions] || '').trim();
    
    if (general) generalSet.add(general);
    if (type) typeSet.add(type);
    
    if (subject && regions) {
      // –†–∞–∑–±–∏–≤–∞–µ–º —Ä–µ–≥–∏–æ–Ω—ã –ø–æ –∑–∞–ø—è—Ç—ã–º
      const regionList = regions.split(',').map(r => r.trim());
      
      regionList.forEach(region => {
        if (!subjectsByRegion[region]) {
          subjectsByRegion[region] = new Set();
        }
        subjectsByRegion[region].add(subject);
      });
    }
  }
  
  // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–∞—Å—Å–∏–≤—ã
  const result = {
    general: Array.from(generalSet).sort(),
    type: Array.from(typeSet).sort(),
    subjects: {}
  };
  
  Object.keys(subjectsByRegion).forEach(region => {
    result.subjects[region] = Array.from(subjectsByRegion[region]).sort();
  });
  
  return result;
}

/**
 * –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤ —Å–ª—É–∂–µ–±–Ω—ã–π –ª–∏—Å—Ç
 */
function saveValidationDataToSheet(validationData) {
  const sourceFile = SpreadsheetApp.openById(CONFIG_update.SOURCE_FILE_ID);
  
  // –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Å–ª—É–∂–µ–±–Ω—ã–π –ª–∏—Å—Ç –µ—Å–ª–∏ –µ—Å—Ç—å
  const existingSheet = sourceFile.getSheetByName(CONFIG_update.VALIDATION_SHEET_NAME);
  if (existingSheet) {
    sourceFile.deleteSheet(existingSheet);
  }
  
  // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —Å–ª—É–∂–µ–±–Ω—ã–π –ª–∏—Å—Ç
  const validationSheet = sourceFile.insertSheet(CONFIG_update.VALIDATION_SHEET_NAME);
  validationSheet.hideSheet();
  
  // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∑–∞–ø–∏—Å–∏
  const sheetData = [
    ['LIST_TYPE', 'VALUE', 'REGION_FILTER', 'LAST_UPDATE']
  ];
  
  const timestamp = new Date().toISOString();
  
  // GENERAL –¥–∞–Ω–Ω—ã–µ
  validationData.general.forEach(value => {
    sheetData.push(['GENERAL', value, 'ALL', timestamp]);
  });
  
  // TYPE –¥–∞–Ω–Ω—ã–µ
  validationData.type.forEach(value => {
    sheetData.push(['TYPE', value, 'ALL', timestamp]);
  });
  
  // SUBJECT –¥–∞–Ω–Ω—ã–µ –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º
  Object.keys(validationData.subjects).forEach(region => {
    validationData.subjects[region].forEach(value => {
      sheetData.push(['SUBJECT', value, region, timestamp]);
    });
  });
  
  // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ batch –æ–ø–µ—Ä–∞—Ü–∏–µ–π
  if (sheetData.length > 1) {
    const range = validationSheet.getRange(1, 1, sheetData.length, 4);
    range.setValues(sheetData);
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
    const headerRange = validationSheet.getRange(1, 1, 1, 4);
    headerRange.setBackground('#4285F4');
    headerRange.setFontColor('white');
    headerRange.setFontWeight('bold');
  }
}

/**
 * –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –∏ —Å–ª–µ–¥—É—é—â–µ–≥–æ –º–µ—Å—è—Ü–∞
 */
function getCurrentAndNextMonth() {
  const now = new Date();
  now.setDate(1);    
  const timeZone = Session.getScriptTimeZone();
  const currentMonth = Utilities.formatDate(now, timeZone, "MMMM_yyyy");
  
  // –°–ª–µ–¥—É—é—â–∏–π –º–µ—Å—è—Ü
  const nextDate = new Date(now);
  nextDate.setDate(1);    
  nextDate.setMonth(nextDate.getMonth() + 1);
  const nextMonth = Utilities.formatDate(nextDate, timeZone, "MMMM_yyyy");
  
  return {
    current: currentMonth,
    next: nextMonth
  };
}

/**
 * –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ö–ü
 */
function GetActiveKPs() {
  const activeKPsString = PropertiesService.getScriptProperties().getProperty('active_kps');
  if (!activeKPsString) {
    throw new Error('–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è active_kps –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ Script Properties');
  }
  
  return JSON.parse(activeKPsString);
}

/**
 * –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–ê–Ø –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ–¥–Ω–æ–≥–æ –ö–ü - –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ–±–∞ –º–µ—Å—è—Ü–∞ –≤ –æ–¥–Ω–æ–º —Ü–∏–∫–ª–µ
 */
function processKPOptimized(kp, months, validationData) {
  const logs = [];
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —ç—Ç–æ–≥–æ –ö–ü
  if (!validationData.subjects[kp.name]) {
    logs.push(`‚è≠Ô∏è –ö–ü ${kp.name} - –Ω–µ—Ç –≤ REGIONS, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º`);
    return logs;
  }
  
  logs.push(`üîÑ –ö–ü ${kp.name} (${validationData.subjects[kp.name].length} SUBJECT)`);
  
  try {
    const workFile = getWorkFile(kp.id_work); // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–∞–π–ª
    
    // –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ–±–∞ –º–µ—Å—è—Ü–∞ –ø–æ–¥—Ä—è–¥ –¥–ª—è –æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
    const monthsToProcess = [months.current, months.next];
    let totalUpdated = 0;
    
    monthsToProcess.forEach(monthName => {
      const monthResult = processKPMonthOptimized(workFile, monthName, kp.name, validationData);
      logs.push(...monthResult);
      
      // –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏
      const updatedMatch = monthResult.find(log => log.includes('–∫–æ–ª–æ–Ω–æ–∫:'));
      if (updatedMatch) {
        const match = updatedMatch.match(/(\d+) –∫–æ–ª–æ–Ω–æ–∫/);
        if (match) totalUpdated += parseInt(match[1]);
      }
    });
    
    if (totalUpdated > 0) {
      logs.push(`‚úÖ –ö–ü ${kp.name} - –í–°–ï–ì–û –æ–±–Ω–æ–≤–ª–µ–Ω–æ: ${totalUpdated} –∫–æ–ª–æ–Ω–æ–∫`);
    }
    
  } catch (error) {
    logs.push(`‚ùå –ö–ü ${kp.name} - –æ—à–∏–±–∫–∞: ${error.message}`);
  }
  
  return logs;
}

/**
 * –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–ê–Ø –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ–¥–Ω–æ–≥–æ –º–µ—Å—è—Ü–∞ –≤ –ö–ü
 */
function processKPMonthOptimized(file, monthName, kpName, validationData) {
  const logs = [];
  
  try {
    const sheet = file.getSheetByName(monthName);
    if (!sheet) {
      logs.push(`‚ö†Ô∏è ${monthName} –Ω–µ –Ω–∞–π–¥–µ–Ω`);
      return logs;
    }
    
    // –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: –ü–æ–ª—É—á–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –æ–¥–Ω–∏–º –≤—ã–∑–æ–≤–æ–º
    const lastColumn = sheet.getLastColumn();
    const lastRow = sheet.getLastRow();
    
    if (lastRow === 0) {
      logs.push(`‚ö†Ô∏è ${monthName} –ø—É—Å—Ç`);
      return logs;
    }
    
    const headers = sheet.getRange(1, 1, 1, lastColumn).getValues()[0];
    
    // –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: –£–º–Ω—ã–π —Ä–∞—Å—á–µ—Ç –¥–∏–∞–ø–∞–∑–æ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
    const dataRows = Math.max(lastRow, 2); // –ú–∏–Ω–∏–º—É–º 2 —Å—Ç—Ä–æ–∫–∏
    const validationRows = Math.min(
      dataRows + CONFIG_update.BUFFER_ROWS, 
      CONFIG_update.MAX_VALIDATION_ROWS
    );
    
    // Batch –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –≤—Å–µ—Ö –≤–∞–ª–∏–¥–∞—Ü–∏–π
    const validationUpdates = [];
    
    CONFIG_update.COLUMNS_TO_VALIDATE.forEach(columnName => {
      const columnIndex = headers.indexOf(columnName);
      
      if (columnIndex === -1) {
        if (CONFIG_update.DEBUG_MODE) {
          logs.push(`‚ö†Ô∏è ${monthName} - –Ω–µ—Ç –∫–æ–ª–æ–Ω–∫–∏ ${columnName}`);
        }
        return;
      }
      
      const rule = createValidationRule(columnName, kpName, validationData);
      if (!rule) {
        if (CONFIG_update.DEBUG_MODE) {
          logs.push(`‚ö†Ô∏è ${monthName} - –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è ${columnName}`);
        }
        return;
      }
      
      validationUpdates.push({
        columnName,
        columnIndex,
        rule,
        range: sheet.getRange(2, columnIndex + 1, validationRows - 1, 1)
      });
    });
    
    // –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: –ü—Ä–∏–º–µ–Ω—è–µ–º –≤—Å–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø–æ–¥—Ä—è–¥ –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–æ–∫
    let successCount = 0;
    validationUpdates.forEach(update => {
      try {
        // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –∏ –ø—Ä–∏–º–µ–Ω—è–µ–º –Ω–æ–≤—ã–µ (–ë–ï–ó–û–ü–ê–°–ù–û - –Ω–µ –∑–∞—Ç–∏—Ä–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ)
        update.range.setDataValidation(null);
        update.range.setDataValidation(update.rule);
        successCount++;
        
        if (CONFIG_update.DEBUG_MODE) {
          const colLetter = columnToLetter(update.columnIndex + 1);
          logs.push(`‚úÖ ${update.columnName} (${colLetter}2:${colLetter}${validationRows})`);
        }
      } catch (error) {
        logs.push(`‚ùå ${monthName} - –æ—à–∏–±–∫–∞ ${update.columnName}: ${error.message}`);
      }
    });
    
    if (successCount > 0) {
      logs.push(`‚úÖ ${monthName}: ${successCount} –∫–æ–ª–æ–Ω–æ–∫ (${validationRows-1} —Å—Ç—Ä–æ–∫)`);
    } else if (validationUpdates.length > 0) {
      logs.push(`‚ùå ${monthName}: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫–∏`);
    }
    
  } catch (error) {
    logs.push(`‚ùå ${monthName} - –æ–±—â–∞—è –æ—à–∏–±–∫–∞: ${error.message}`);
  }
  
  return logs;
}

/**
 * –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–ª—è –∫–æ–ª–æ–Ω–∫–∏
 */
function createValidationRule(columnName, kpName, validationData) {
  let values = [];
  
  switch (columnName) {
    case 'GENERAL':
      values = validationData.general;
      break;
    case 'TYPE':
      values = validationData.type;
      break;
    case 'SUBJECT':
      values = validationData.subjects[kpName] || [];
      break;
    default:
      return null;
  }
  
  if (values.length === 0) {
    return null;
  }
  
  try {
    const rule = SpreadsheetApp.newDataValidation()
      .requireValueInList(values, true)
      .setAllowInvalid(false)
      .setHelpText(`${columnName}: ${values.length} –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤`)
      .build();
    
    return rule;
  } catch (error) {
    console.error(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–∞–≤–∏–ª–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–ª—è ${columnName}:`, error);
    return null;
  }
}

/**
 * –¢–ï–°–¢–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø –¥–ª—è NIGERIA
 */
function testNigeriaSpecific() {
  try {
    console.log('=== –¢–ï–°–¢ NIGERIA ===');
    
    const validationData = loadAndProcessSourceData();
    console.log('–í—Å–µ —Ä–µ–≥–∏–æ–Ω—ã:', Object.keys(validationData.subjects));
    console.log('NIGERIA –≤ subjects:', validationData.subjects.hasOwnProperty('NIGERIA'));
    
    if (validationData.subjects['NIGERIA']) {
      console.log('NIGERIA –∑–Ω–∞—á–µ–Ω–∏–π:', validationData.subjects['NIGERIA'].length);
      console.log('–ü–µ—Ä–≤—ã–µ 5 NIGERIA –∑–Ω–∞—á–µ–Ω–∏–π:', validationData.subjects['NIGERIA'].slice(0, 5));
    }
    
    const activeKPs = GetActiveKPs();
    const nigeriaKP = activeKPs.find(kp => kp.name === 'NIGERIA');
    
    if (nigeriaKP) {
      console.log('NIGERIA –ö–ü –Ω–∞–π–¥–µ–Ω, ID:', nigeriaKP.id_work);
      
      try {
        const workFile = SpreadsheetApp.openById(nigeriaKP.id_work);
        const sheet = workFile.getSheetByName('September_2025');
        
        if (sheet) {
          const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
          console.log('–ó–∞–≥–æ–ª–æ–≤–∫–∏ –ª–∏—Å—Ç–∞:', headers);
          
          const subjectIndex = headers.indexOf('SUBJECT');
          if (subjectIndex !== -1) {
            console.log('SUBJECT –∫–æ–ª–æ–Ω–∫–∞ –Ω–∞–π–¥–µ–Ω–∞ –≤ –ø–æ–∑–∏—Ü–∏–∏:', subjectIndex + 1);
            
            // –ü—Ä–æ–±—É–µ–º –ø—Ä–∏–º–µ–Ω–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –∫ –æ–¥–Ω–æ–π —è—á–µ–π–∫–µ –¥–ª—è —Ç–µ—Å—Ç–∞
            const testRange = sheet.getRange(2, subjectIndex + 1);
            const rule = createValidationRule('SUBJECT', 'NIGERIA', validationData);
            
            if (rule) {
              testRange.setDataValidation(rule);
              console.log('–¢–µ—Å—Ç–æ–≤–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞');
            }
          }
        }
      } catch (fileError) {
        console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª—É NIGERIA:', fileError.message);
      }
    }
    
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∞ NIGERIA:', error);
  }
}

/**
 * SIDEBAR –î–õ–Ø –û–ë–ù–û–í–õ–ï–ù–ò–Ø –°–ü–ò–°–ö–û–í
 */
function showUpdateSidebar() {
  const htmlTemplate = HtmlService.createTemplateFromFile('updateSidebar');
  const html = htmlTemplate.evaluate()
    .setWidth(400)
    .setTitle('üìã –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤');
  
  SpreadsheetApp.getUi().showSidebar(html);
}

/**
 * –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–∑–æ–≤–∞ –∏–∑ sidebar
 */
function runUpdateValidationLists() {
  return updateValidationLists();
}

/**
 * –ü–†–û–í–ï–†–ö–ê –£–ù–ò–ö–ê–õ–¨–ù–û–°–¢–ò
 */
function checkUniqueness() {
  const logs = [];
  
  try {
    logs.push('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –∑–Ω–∞—á–µ–Ω–∏–π');
    
    const validationData = loadAndProcessSourceData();
    const suspiciousPairs = [];
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–π —Ç–∏–ø –¥–∞–Ω–Ω—ã—Ö
    ['general', 'type'].forEach(dataType => {
      const items = validationData[dataType];
      for (let i = 0; i < items.length; i++) {
        for (let j = i + 1; j < items.length; j++) {
          const similarity = calculateSimilarity(items[i], items[j]);
          if (similarity >= 0.8) {
            suspiciousPairs.push({
              type: dataType.toUpperCase(),
              item1: items[i],
              item2: items[j],
              similarity: Math.round(similarity * 100)
            });
          }
        }
      }
    });
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º SUBJECT –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–µ–≥–∏–æ–Ω–∞
    Object.keys(validationData.subjects).forEach(region => {
      const items = validationData.subjects[region];
      for (let i = 0; i < items.length; i++) {
        for (let j = i + 1; j < items.length; j++) {
          const similarity = calculateSimilarity(items[i], items[j]);
          if (similarity >= 0.8) {
            suspiciousPairs.push({
              type: `SUBJECT (${region})`,
              item1: items[i],
              item2: items[j],
              similarity: Math.round(similarity * 100)
            });
          }
        }
      }
    });
    
    // –í—ã–≤–æ–¥–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    if (suspiciousPairs.length === 0) {
      logs.push('‚úÖ –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
    } else {
      logs.push(`‚ö†Ô∏è –ù–∞–π–¥–µ–Ω–æ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–∞—Ä: ${suspiciousPairs.length}`);
      logs.push('');
      suspiciousPairs.forEach(pair => {
        logs.push(`üîç ${pair.type}: "${pair.item1}" ‚Üî "${pair.item2}" (${pair.similarity}% –ø–æ—Ö–æ–∂–µ—Å—Ç—å)`);
      });
    }
    
  } catch (error) {
    logs.push(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏: ${error.message}`);
  }
  
  return logs;
}

/**
 * –†–∞—Å—á–µ—Ç –ø–æ—Ö–æ–∂–µ—Å—Ç–∏ —Å—Ç—Ä–æ–∫ (Levenshtein distance)
 */
function calculateSimilarity(str1, str2) {
  const s1 = str1.toLowerCase();
  const s2 = str2.toLowerCase();
  
  if (s1 === s2) return 1.0;
  
  const longer = s1.length > s2.length ? s1 : s2;
  const shorter = s1.length > s2.length ? s2 : s1;
  
  if (longer.length === 0) return 1.0;
  
  const distance = levenshteinDistance(longer, shorter);
  return (longer.length - distance) / longer.length;
}

/**
 * Levenshtein distance
 */
function levenshteinDistance(str1, str2) {
  const matrix = [];
  
  for (let i = 0; i <= str2.length; i++) {
    matrix[i] = [i];
  }
  
  for (let j = 0; j <= str1.length; j++) {
    matrix[0][j] = j;
  }
  
  for (let i = 1; i <= str2.length; i++) {
    for (let j = 1; j <= str1.length; j++) {
      if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
        matrix[i][j] = matrix[i - 1][j - 1];
      } else {
        matrix[i][j] = Math.min(
          matrix[i - 1][j - 1] + 1,
          matrix[i][j - 1] + 1,
          matrix[i - 1][j] + 1
        );
      }
    }
  }
  
  return matrix[str2.length][str1.length];
}

/**
 * –ü–û–ö–ê–ó–ê–¢–¨ –ü–†–û–í–ï–†–ö–£ –£–ù–ò–ö–ê–õ–¨–ù–û–°–¢–ò
 */
function showUniquenessCheck() {
  const logs = checkUniqueness();
  
  const htmlContent = `
    <div style="font-family: Arial, sans-serif; padding: 10px;">
      <h3>üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏</h3>
      <div style="background: #f5f5f5; padding: 10px; border-radius: 5px; max-height: 400px; overflow-y: auto;">
        ${logs.map(log => `<div style="margin: 5px 0; font-family: monospace;">${log}</div>`).join('')}
      </div>
      <button onclick="google.script.run.showUniquenessCheck()" style="margin-top: 10px; padding: 8px 15px;">üîÑ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–Ω–æ–≤–∞</button>
    </div>
  `;
  
  const html = HtmlService.createHtmlOutput(htmlContent)
    .setWidth(500)
    .setHeight(400)
    .setTitle('–ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏');
  
  SpreadsheetApp.getUi().showModalDialog(html, '–ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏');
}

/**
 * –ü–û–ö–ê–ó–ê–¢–¨ –°–¢–ê–¢–ò–°–¢–ò–ö–£
 */
function showStatistics() {
  try {
    const validationData = loadAndProcessSourceData();
    const activeKPs = GetActiveKPs();
    
    const stats = {
      totalGeneral: validationData.general.length,
      totalType: validationData.type.length,
      totalRegions: Object.keys(validationData.subjects).length,
      totalKPs: activeKPs.length,
      validKPs: activeKPs.filter(kp => validationData.subjects[kp.name]).length
    };
    
    const htmlContent = `
      <div style="font-family: Arial, sans-serif; padding: 15px;">
        <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã</h3>
        
        <h4>üìã –î–∞–Ω–Ω—ã–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏:</h4>
        <ul>
          <li>GENERAL –∑–Ω–∞—á–µ–Ω–∏–π: ${stats.totalGeneral}</li>
          <li>TYPE –∑–Ω–∞—á–µ–Ω–∏–π: ${stats.totalType}</li>
          <li>–†–µ–≥–∏–æ–Ω–æ–≤ —Å SUBJECT: ${stats.totalRegions}</li>
        </ul>
        
        <h4>üè¢ –ö–ü —Ñ–∞–π–ª—ã:</h4>
        <ul>
          <li>–í—Å–µ–≥–æ –ö–ü –≤ —Å–∏—Å—Ç–µ–º–µ: ${stats.totalKPs}</li>
          <li>–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º—ã—Ö –ö–ü: ${stats.validKPs}</li>
          <li>–ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º—ã—Ö –ö–ü: ${stats.totalKPs - stats.validKPs}</li>
        </ul>
        
        <h4>üéØ –†–µ–≥–∏–æ–Ω—ã SUBJECT:</h4>
        <ul>
          ${Object.keys(validationData.subjects).map(region => 
            `<li>${region}: ${validationData.subjects[region].length} –∑–Ω–∞—á–µ–Ω–∏–π</li>`
          ).join('')}
        </ul>
        
        <h4>‚ö° –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏:</h4>
        <ul>
          <li>–ú–∞–∫—Å. —Å—Ç—Ä–æ–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏: ${CONFIG_update.MAX_VALIDATION_ROWS}</li>
          <li>–ë—É—Ñ–µ—Ä–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏: ${CONFIG_update.BUFFER_ROWS}</li>
          <li>–†–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏: ${CONFIG_update.DEBUG_MODE ? '–í–∫–ª—é—á–µ–Ω' : '–í—ã–∫–ª—é—á–µ–Ω'}</li>
        </ul>
      </div>
    `;
    
    const html = HtmlService.createHtmlOutput(htmlContent)
      .setWidth(400)
      .setHeight(600)
      .setTitle('–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã');
    
    SpreadsheetApp.getUi().showModalDialog(html, '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞');
    
  } catch (error) {
    SpreadsheetApp.getUi().alert('–û—à–∏–±–∫–∞', `–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É: ${error.message}`, SpreadsheetApp.getUi().ButtonSet.OK);
  }
}
