function cacheCleanCommunicationIds() {
  const cleanFileId = '1WfslprOxh0UTQhkr1qjTRIEeTG56moyAlAK3NAnffrg';
  const timeZone = Session.getScriptTimeZone();

  const now = new Date();
  const currentMonth = Utilities.formatDate(now, timeZone, "MMMM_yyyy");
  const prevDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
  const previousMonth = Utilities.formatDate(prevDate, timeZone, "MMMM_yyyy");

  const monthsToKeep = new Set([currentMonth, previousMonth]);
  const properties = PropertiesService.getScriptProperties();

  [currentMonth, previousMonth].forEach(month => {
    const sheet = SpreadsheetApp.openById(cleanFileId).getSheetByName(month);
    if (!sheet) {
      Logger.log(`‚ö†Ô∏è –õ–∏—Å—Ç '${month}' –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –ø—Ä–æ–ø—É—â–µ–Ω.`);
      return;
    }

    const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    const idCol = headers.indexOf("communication_id") + 1;
    const trackCol = headers.indexOf("–¢—Ä–µ–∫") + 1;
    const dateCol = headers.indexOf("moving_date") + 1;

    if (idCol < 1 || trackCol < 1 || dateCol < 1) {
      Logger.log(`‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–æ–ª–±—Ü—ã –≤ '${month}'.`);
      return;
    }

    const numRows = sheet.getLastRow() - 1;
    if (numRows < 1) {
      Logger.log(`‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ –ª–∏—Å—Ç–µ '${month}' –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è.`);
      return;
    }

    const data = sheet.getRange(2, 1, numRows, sheet.getLastColumn()).getValues();
    const cache = {};

    data.forEach(row => {
      const id = row[idCol - 1]?.toString().trim();
      const track = row[trackCol - 1]?.toString().trim();

      let dateCell = row[dateCol - 1];
      let formattedDate = "";
      if (Object.prototype.toString.call(dateCell) === "[object Date]") {
        formattedDate = Utilities.formatDate(dateCell, timeZone, "dd.MM.yyyy HH:mm:ss");
      } else {
        formattedDate = dateCell?.toString().trim();
      }

      if (!id || !track || !formattedDate) return;
      cache[id] = { track, date: formattedDate };
    });

    properties.setProperty(`clean_ids_${month}`, JSON.stringify(cache));
    Logger.log(`‚úÖ –ö—ç—à–∏—Ä–æ–≤–∞–Ω–æ ${Object.keys(cache).length} ID –≤ clean_ids_${month}`);
  });

  // üßπ –£–¥–∞–ª–µ–Ω–∏–µ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
  const allProps = properties.getProperties();
  Object.keys(allProps).forEach(key => {
    if (key.startsWith("clean_ids_")) {
      const monthKey = key.replace("clean_ids_", "");
      if (!monthsToKeep.has(monthKey)) {
        properties.deleteProperty(key);
        Logger.log(`üóë –£–¥–∞–ª–µ–Ω–∞ —É—Å—Ç–∞—Ä–µ–≤—à–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è: ${key}`);
      }
    }
  });

  Logger.log("üéØ –ö—ç—à –æ–±–Ω–æ–≤–ª—ë–Ω. –•—Ä–∞–Ω–∏–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â–∏–π –∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–π –º–µ—Å—è—Ü.");
}
