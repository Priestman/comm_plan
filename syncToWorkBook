function syncToWorkBook(kpName) {
  const kps = JSON.parse(PropertiesService.getScriptProperties().getProperty("active_kps") || "[]");
  const kp = kps.find(k => k.name === kpName);
  if (!kp) return Logger.log(`‚ö† –ö–ü '${kpName}' –Ω–µ –Ω–∞–π–¥–µ–Ω.`);

  const currentMonth = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), "MMMM_yyyy");

  try {
    const cleanSheet = SpreadsheetApp.openById(kp.id_clean).getSheetByName(currentMonth);
    const workSheet = SpreadsheetApp.openById(kp.id_work).getSheetByName(currentMonth);
    if (!cleanSheet || !workSheet) return Logger.log(`‚ö† –ù–µ—Ç –ª–∏—Å—Ç–∞ ${currentMonth} –≤ ${kpName}`);

    const cleanHeaders = cleanSheet.getRange(1, 1, 1, cleanSheet.getLastColumn()).getValues()[0];
    const workHeaders = workSheet.getRange(1, 1, 1, workSheet.getLastColumn()).getValues()[0];

    const idColClean = cleanHeaders.indexOf("communication_id");
    const idColWork = workHeaders.indexOf("communication_id");
    const channelColWork = workHeaders.indexOf("–ö–∞–Ω–∞–ª");

    if (idColClean === -1 || idColWork === -1 || channelColWork === -1) {
      return Logger.log(`‚ö† –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –∫–ª—é—á–µ–≤—ã–µ —Å—Ç–æ–ª–±—Ü—ã –≤ ${kpName}`);
    }

    const cleanData = cleanSheet.getDataRange().getValues().slice(1);
    const workData = workSheet.getDataRange().getValues();

    const cleanMap = new Map();
    cleanData.forEach(row => {
      const id = row[idColClean];
      if (id) cleanMap.set(id, row);
    });

    const firstPool = [
      "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ", "–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ", "–ü—Ä–æ—á–∏—Ç–∞–Ω–æ", "–°–ø–µ–Ω–¥", "–ö–ª–∏–∫–∏",
      "–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —é–∑–µ—Ä–æ–≤ —Å –¥–µ–ø–æ–∑–∏—Ç–æ–º", "–ö–æ–ª-–≤–æ –¥–µ–ø–æ–≤", "–°—É–º–º–∞ –¥–µ–ø–æ–≤",
      "–°—É–º–º–∞ –ø–µ—Ä–≤—ã—Ö –¥–µ–ø–æ–∑–∏—Ç–æ–≤ –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ö–æ–¥–∞ –ø–æ —Ç—Ä–µ–∫—É", "ClickToDep",
      "–∫–æ–ª-–≤–æ –Ω–µ—É–¥ –¥–µ–ø–æ–≤", "—Å—É–º–º–∞ –Ω–µ—É–¥ –¥–µ–ø–æ–≤", "–°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ –Ω–µ—É–¥ –∫ —É–¥ –¥–µ–ø—ã",
      "–°—É–º–º–∞ HOLD (—Ä–∞–∑–Ω–∏—Ü–∞ dep - cashout)", "–î–∞—Ç–∞ –¥–æ –∫–æ—Ç–æ—Ä–æ–π –Ω—É–∂–Ω–æ —Å–æ–±–∏—Ä–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ –∫–∞–Ω–∞–ª–∞–º"
    ];
    const secondPool = [
      "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ –≥—Ä—É–ø–ø–∞–º", "–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ –ø–æ –≥—Ä—É–ø–ø–∞–º", "–ü—Ä–æ—á–∏—Ç–∞–Ω–æ –ø–æ –≥—Ä—É–ø–ø–∞–º", "–°–ø–µ–Ω–¥ –ø–æ –≥—Ä—É–ø–ø–∞–º", "–ö–ª–∏–∫–∏ –ø–æ –≥—Ä—É–ø–ø–∞–º",
      "–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —é–∑–µ—Ä–æ–≤ —Å –¥–µ–ø–æ–∑–∏—Ç–æ–º –ø–æ –≥—Ä—É–ø–ø–∞–º", "–ö–æ–ª-–≤–æ –¥–µ–ø–æ–≤ –ø–æ –≥—Ä—É–ø–ø–∞–º", "–°—É–º–º–∞ –¥–µ–ø–æ–≤ –ø–æ –≥—Ä—É–ø–ø–∞–º",
      "–°—É–º–º–∞ –ø–µ—Ä–≤—ã—Ö –¥–µ–ø–æ–∑–∏—Ç–æ–≤ –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ö–æ–¥–∞ –ø–æ —Ç—Ä–µ–∫—É –ø–æ –≥—Ä—É–ø–ø–∞–º", "ClickToDep –ø–æ –≥—Ä—É–ø–ø–∞–º",
      "–∫–æ–ª-–≤–æ –Ω–µ—É–¥ –¥–µ–ø–æ–≤ –ø–æ –≥—Ä—É–ø–ø–∞–º", "—Å—É–º–º–∞ –Ω–µ—É–¥ –¥–µ–ø–æ–≤ –ø–æ –≥—Ä—É–ø–ø–∞–º",
      "–°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ –Ω–µ—É–¥ –∫ —É–¥ –¥–µ–ø—ã –ø–æ –≥—Ä—É–ø–ø–∞–º", "–°—É–º–º–∞ HOLD (—Ä–∞–∑–Ω–∏—Ü–∞ dep - cashout) –ø–æ –≥—Ä—É–ø–ø–∞–º",
      "–î–∞—Ç–∞ –¥–æ –∫–æ—Ç–æ—Ä–æ–π –Ω—É–∂–Ω–æ —Å–æ–±–∏—Ä–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ –≥—Ä—É–ø–ø–∞–º"
    ];
    const allColumns = firstPool.concat(secondPool);

    const workIndexes = allColumns.map(col => workHeaders.indexOf(col));
    const cleanIndexes = allColumns.map(col => cleanHeaders.indexOf(col));

    const firstIdx = Math.min(...workIndexes.filter(i => i !== -1));
    const lastIdx = Math.max(...workIndexes.filter(i => i !== -1));
    const numColsToUpdate = lastIdx - firstIdx + 1;

    const excludedColumns = ["–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ", "–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ", "–°–ø–µ–Ω–¥"];
    const workIndexesSet = new Set(workIndexes.filter(i => i !== -1));

    const workMap = new Map();
    for (let i = 1; i < workData.length; i++) {
      const id = workData[i][idColWork];
      if (id) workMap.set(id, i);
    }

    const updates = [];
    cleanMap.forEach((cleanRow, commId) => {
      const workRowIndex = workMap.get(commId);
      if (workRowIndex === undefined) return;

      const channel = workData[workRowIndex][channelColWork];
      const isExcludedChannel = channel === "Whatsapp" || channel === "SMS" || channel === "WA/TG/SMS" || channel === "Telegram BOT" ;

      const rowValues = [];

      for (let k = 0; k < numColsToUpdate; k++) {
        const colIdx = firstIdx + k;
        if (!workIndexesSet.has(colIdx)) {
          rowValues.push(workData[workRowIndex][colIdx]);
          continue;
        }

        const colName = workHeaders[colIdx];
        const cleanIdx = cleanHeaders.indexOf(colName);
        const cleanValue = cleanIdx !== -1 ? cleanRow[cleanIdx] : "";
        const workValue = workData[workRowIndex][colIdx];

        if (isExcludedChannel && excludedColumns.includes(colName)) {
          // üîí –ù–µ —Ç—Ä–æ–≥–∞–µ–º SMS/Whatsapp –ø–æ–ª—è "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ", "–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ", "–°–ø–µ–Ω–¥"
          rowValues.push(workValue);
        } else {
          rowValues.push(cleanValue);
        }
      }

      updates.push({ rowIndex: workRowIndex + 1, values: rowValues });
    });

    updates.sort((a, b) => a.rowIndex - b.rowIndex);

    const groupedUpdates = [];
    let currentGroup = [];
    updates.forEach((update, index) => {
      if (index === 0 || update.rowIndex === currentGroup[currentGroup.length - 1].rowIndex + 1) {
        currentGroup.push(update);
      } else {
        groupedUpdates.push(currentGroup);
        currentGroup = [update];
      }
    });
    if (currentGroup.length > 0) groupedUpdates.push(currentGroup);

    groupedUpdates.forEach(group => {
      const startRow = group[0].rowIndex;
      const values = group.map(u => u.values);
      workSheet.getRange(startRow, firstIdx + 1, values.length, numColsToUpdate).setValues(values);
    });

    Logger.log(`‚úÖ ${kpName}: –û–±–Ω–æ–≤–ª–µ–Ω–æ —Å—Ç—Ä–æ–∫: ${updates.length}`);
  } catch (e) {
    Logger.log(`‚ùå –û—à–∏–±–∫–∞ –≤ ${kpName}: ${e}`);
  }
}
