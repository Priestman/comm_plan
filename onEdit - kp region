function onEdit(e) {
    var sheet = e.source.getActiveSheet();
    var sheetName = sheet.getName();

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –ª–∏—Å—Ç–∞ —Ñ–æ—Ä–º–∞—Ç—É "–ú–µ—Å—è—Ü_–ì–æ–¥"
    var monthYearPattern = /^(January|February|March|April|May|June|July|August|September|October|November|December)_(\d{4})$/;
    if (!monthYearPattern.test(sheetName)) return;

    var timeZone = Session.getScriptTimeZone();

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â–∏–π, –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∏ —Å–ª–µ–¥—É—é—â–∏–π –º–µ—Å—è—Ü, –∏–∑–±–µ–≥–∞—è –æ—à–∏–±–æ–∫ —Å setMonth()
var timeZone = Session.getScriptTimeZone();
var today = new Date();
var currentMonth = Utilities.formatDate(today, timeZone, "MMMM_yyyy");

var nextMonthDate = new Date(today.getFullYear(), today.getMonth() + 1, 1);
var nextMonth = Utilities.formatDate(nextMonthDate, timeZone, "MMMM_yyyy");
var previousMonthDate = new Date(today.getFullYear(), today.getMonth() - 1, 1);
var previousMonth = Utilities.formatDate(previousMonthDate, timeZone, "MMMM_yyyy");

if (![currentMonth, nextMonth].includes(sheetName)) return;

    var range = e.range;
    var row = range.getRow();
    var column = range.getColumn();

    // –ï—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è –ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ (–∑–∞–≥–æ–ª–æ–≤–∫–∏) ‚Äî –∑–∞—â–∏—â–∞–µ–º –∏—Ö
    if (row === 1) {
        protectHeaders(e);
        return;
    }

    var headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];

    var statusCol = headers.indexOf("–°—Ç–∞—Ç—É—Å —Ä–∞—Å—Å—ã–ª–∫–∏") + 1;
    var trackCol = headers.indexOf("–¢—Ä–µ–∫") + 1;

    var geoCol = headers.indexOf("–ì–ï–û") + 1;
    var mirrorCol = headers.indexOf("–ó–µ—Ä–∫–∞–ª–æ") + 1;
    var dateCol = headers.indexOf("–î–∞—Ç–∞") + 1;
    var dayOfWeekCol = headers.indexOf("–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏") + 1;
    var pathCol = headers.indexOf("–ü—É—Ç—å") + 1;
    var linkTrackCol = headers.indexOf("–°—Å—ã–ª–∫–∞ + —Ç—Ä–µ–∫") + 1;
    var refTimeCol = headers.indexOf("–í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ –ú–°–ö") + 1;
    var geoNCol = headers.indexOf("–ì–ï–û_N") + 1;
    var channelNCol = headers.indexOf("–ö–∞–Ω–∞–ª_N") + 1;
    var timeNCol = headers.indexOf("–í—Ä–µ–º—è_N") + 1;
    var refChannelCol = headers.indexOf("–ö–∞–Ω–∞–ª") + 1;
    var idCol = headers.indexOf("communication_id") + 1;

    
    if ([statusCol, trackCol].includes(column)) {
        validateUniqueTrack(e, headers, [previousMonth, currentMonth, nextMonth]);
    }
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ "–ó–µ—Ä–∫–∞–ª–æ" –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ "–ì–ï–û"
      if (geoCol > 0 && mirrorCol > 0 && ([geoCol].includes(column) || range.getNumRows() > 1)) {
                  updateMirrorColumn(sheet, range, geoCol, mirrorCol);
      }  

        // –í—ã–∑—ã–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ "–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏", –µ—Å–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∞ "–î–∞—Ç–∞"
    if (column === dateCol && dayOfWeekCol > 0) {
        updateDayOfWeek(sheet, range, dayOfWeekCol);
    }

        if ([mirrorCol, pathCol, trackCol].includes(column) && linkTrackCol > 0) {
        updateLinkAndTrack(sheet, range, mirrorCol, pathCol, trackCol, linkTrackCol);
    }

    // –í—ã–∑—ã–≤–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –æ—á–∏—Å—Ç–∫—É —Å—Ç–∞—Ç—É—Å–∞
    clearStatusOnEdit(sheet, row, headers);
    validateDateAndDay(e, headers);
    validateGeo(e, headers);
    validatePathAndTrack(e, headers);
    validateNotificationType(e, headers);
    validateProcessLable(e, headers);
   // checkAndResetDuplicatedTransferredIds(e, headers);
}


function validateDateAndDay(e, headers) {
    var sheet = e.source.getActiveSheet();
    var sheetName = sheet.getName(); // –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –ª–∏—Å—Ç–∞
    var range = e.range;
    var column = range.getColumn();
    var row = range.getRow();

    var dateCol = headers.indexOf("–î–∞—Ç–∞") + 1;
    var dayOfWeekCol = headers.indexOf("–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏") + 1;

    if (column !== dateCol) return;

    var dateValue = range.getValue();

    if (Object.prototype.toString.call(dateValue) === "[object Date]") {
        var daysShort = ["–≤—Å", "–ø–Ω", "–≤—Ç", "—Å—Ä", "—á—Ç", "–ø—Ç", "—Å–±"];
        var dayShort = daysShort[dateValue.getDay()];
        sheet.getRange(row, dayOfWeekCol).setValue(dayShort); // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ "–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏"

        // –ü—Ä–æ–≤–µ—Ä–∫–∞: –≤—Ö–æ–¥–∏—Ç –ª–∏ –¥–∞—Ç–∞ –≤ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü
        var formattedMonth = Utilities.formatDate(dateValue, Session.getScriptTimeZone(), "MMMM_yyyy");
        if (formattedMonth !== sheetName) {
            range.setBackground("#FFCDD2");
            range.setNote("–û—à–∏–±–∫–∞: –¥–∞—Ç–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö " + sheetName);
        } else {
            range.setBackground(null);
            range.setNote("");
        }
    } else {
        sheet.getRange(row, dayOfWeekCol).setValue(""); // –ï—Å–ª–∏ –¥–∞—Ç–∞ —É–¥–∞–ª–µ–Ω–∞ ‚Äì –æ—á–∏—â–∞–µ–º "–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏"
    }
}


function validateGeo(e, headers) {
    var sheet = e.source.getActiveSheet();
    var range = e.range;
    var column = range.getColumn();
    var row = range.getRow();

    var geoCol = headers.indexOf("–ì–ï–û") + 1;
    if (column !== geoCol) return;

    var scriptProperties = PropertiesService.getScriptProperties();
    var geoDataJson = scriptProperties.getProperty("geo_list_data");

    if (!geoDataJson) {
        Logger.log("‚ö† geo_list_data –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω.");
        return;
    }

    var geoData = JSON.parse(geoDataJson);
    var allowedGeo = new Set(geoData.allowedGeo);
    var geoGroups = geoData.geoGroups;

    var cellValue = range.getValue().trim();
    if (!cellValue) return;

    var geoValues = cellValue.split(",").map(s => s.trim());
    var isValid = true;
    var invalidValues = [];

    geoValues.forEach(value => {
        if (value === "ALL") {
            if (geoValues.length > 1) {
                isValid = false;
                invalidValues.push(value + " (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏–µ–º)");
            }
        } else if (!allowedGeo.has(value) && !geoGroups[value]) {
            isValid = false;
            invalidValues.push(value);
        }
    });

    if (!isValid) {
        range.setBackground("#FFCDD2");
        range.setNote("–û—à–∏–±–∫–∞: –≤—ã –≤–≤–µ–ª–∏ –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (–Ω–µ—Ç –≤ –º–∞—Å—Å–∏–≤–µ –¥–ª—è –ö–ü) –∏–ª–∏ –Ω–µ–≤–µ—Ä–Ω—ã–µ –ì–ï–û ‚Üí " + invalidValues.join(", "));
    } else {
        range.setBackground(null);
        range.setNote("");
    }
}


function validatePathAndTrack(e, headers) {
    var sheet = e.source.getActiveSheet();
    var range = e.range;
    var column = range.getColumn();
    var startRow = range.getRow();
    var numRows = range.getNumRows();

    var pathCol = headers.indexOf("–ü—É—Ç—å") + 1;
    var trackCol = headers.indexOf("–¢—Ä–µ–∫") + 1;

    if (column !== pathCol && column !== trackCol) return; // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º–µ–Ω—è–ª—Å—è "–ü—É—Ç—å" –∏–ª–∏ "–¢—Ä–µ–∫"

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —Ä–∞–∑–æ–º
    var pathValues = sheet.getRange(startRow, pathCol, numRows, 1).getValues();
    var trackValues = sheet.getRange(startRow, trackCol, numRows, 1).getValues();

    var updatedTrackValues = [];
    var needsUpdate = false;

    for (var i = 0; i < numRows; i++) {
        var pathValue = pathValues[i][0] ? pathValues[i][0].toString().trim() : "";
        var trackValue = trackValues[i][0] ? trackValues[i][0].toString().trim() : "";

        if (!trackValue) {
            updatedTrackValues.push([trackValue]); // –û—Å—Ç–∞–≤–ª—è–µ–º –ø—É—Å—Ç—ã–º, –µ—Å–ª–∏ "–¢—Ä–µ–∫" –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω
            continue;
        }

        var expectedStart = pathValue.includes("?") ? "&" : "?";

        if (!trackValue.startsWith(expectedStart)) {
            needsUpdate = true;
            trackValue = expectedStart + trackValue.replace(/^[&?]/, ""); // –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø–µ—Ä–≤—ã–π —Å–∏–º–≤–æ–ª
        }

        updatedTrackValues.push([trackValue]);
    }

    // –ï—Å–ª–∏ –±—ã–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è, –æ–±–Ω–æ–≤–ª—è–µ–º –æ–¥–Ω–∏–º –≤—ã–∑–æ–≤–æ–º setValues()
    if (needsUpdate) {
        sheet.getRange(startRow, trackCol, numRows, 1).setValues(updatedTrackValues);
    }
}


function validateNotificationType(e, headers) {
    var sheet = e.source.getActiveSheet();
    var range = e.range;
    var row = range.getRow();
    var column = range.getColumn();
  
    var channelCol = headers.indexOf("–ö–∞–Ω–∞–ª") + 1;
    var notifTypeCol = headers.indexOf("–¢–∏–ø –Ω–æ—Ç–∏—Ñ–∞") + 1;

    if (channelCol < 1 || notifTypeCol < 1) return; // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å—Ç–æ–ª–±—Ü—ã —Å—É—â–µ—Å—Ç–≤—É—é—Ç
    if (![channelCol, notifTypeCol].includes(column)) return; // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —ç—Ç–∏—Ö –∫–æ–ª–æ–Ω–∫–∞—Ö

    var rowData = sheet.getRange(row, 1, 1, sheet.getLastColumn()).getValues()[0];
    var channelValue = rowData[channelCol - 1]?.trim();
    var notifTypeCell = sheet.getRange(row, notifTypeCol);
    var notifTypeValue = notifTypeCell.getValue()?.trim();

    if (channelValue === "Notification") {
        if (!notifTypeValue) {
            notifTypeCell.setBackground("#FFCDD2"); // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –∫—Ä–∞—Å–Ω—ã–º
            notifTypeCell.setNote("‚ùå –û—à–∏–±–∫–∞: –ø–æ–ª–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è Notification");
        } else {
            notifTypeCell.setBackground(null); // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –æ—à–∏–±–∫–∏
            notifTypeCell.setNote("");
        }
    } else {
        if (notifTypeValue) {
            notifTypeCell.setValue(""); // –û—á–∏—â–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ
        }
        notifTypeCell.setBackground(null); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ–Ω
        notifTypeCell.setNote(""); // –û—á–∏—â–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
    }
}

function protectHeaders(e) {
    var sheet = e.source.getActiveSheet();
    var range = e.range;
    var row = range.getRow();

    if (row !== 1) return; // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—É—é —Å—Ç—Ä–æ–∫—É (–∑–∞–≥–æ–ª–æ–≤–∫–∏)

    var protectedHeaders = [
        "communication_id", "–î–∞—Ç–∞", "–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏", "–°—Ç–∞—Ç—É—Å —Ä–∞—Å—Å—ã–ª–∫–∏", "–í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ –ú–°–ö", 
        "–ö–∞–Ω–∞–ª", "–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ", "–¢–µ–º–∞ —Ä–∞—Å—Å—ã–ª–∫–∏", "–ì–ï–û", "–ì–ï–û –ø–µ—Ä–µ–≤–æ–¥—ã", "–ì—Ä—É–ø–ø–∞ —Å–µ–≥–º–µ–Ω—Ç–æ–≤", 
        "–ü–æ–¥—Å–µ–≥–º–µ–Ω—Ç", "–¢–µ—Å—Ç—ã", "–¢–∏–ø –Ω–æ—Ç–∏—Ñ–∞", "–ü—É—Ç—å", "–¢—Ä–µ–∫","–ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ–≥–º–µ–Ω—Ç–∞ –≤ CDP", "process_lable", "–í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ –ú–°–ö", 
        "–°—Å—ã–ª–∫–∞ + —Ç—Ä–µ–∫", "–ó–µ—Ä–∫–∞–ª–æ", "–ü—É—Ç—å"
    ];

    var headersRange = sheet.getRange(1, 1, 1, sheet.getLastColumn());
    var currentHeaders = headersRange.getValues()[0]; // –ë–µ—Ä—ë–º —Ç–µ–∫—É—â–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏
    var oldHeaders = JSON.parse(PropertiesService.getScriptProperties().getProperty("saved_headers") || "{}");

    var column = range.getColumn();
    var newValue = range.getValue().trim();
    var oldValue = oldHeaders[column] || "";

    if (protectedHeaders.includes(oldValue) && newValue !== oldValue) {
        Browser.msgBox("‚ö†Ô∏è –û—à–∏–±–∫–∞: '" + oldValue + "' –Ω–µ–ª—å–∑—è –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞—Ç—å.");
        sheet.getRange(1, column).setValue(oldValue); // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ
    }

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ (–µ—Å–ª–∏ –≤—Å—ë —Ö–æ—Ä–æ—à–æ)
    var updatedHeaders = {};
    for (var i = 0; i < currentHeaders.length; i++) {
        if (currentHeaders[i]) { // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏
            updatedHeaders[i + 1] = currentHeaders[i].trim();
        }
    }
    PropertiesService.getScriptProperties().setProperty("saved_headers", JSON.stringify(updatedHeaders));
}

function validateProcessLable(e, headers) {
    var sheet = e.source.getActiveSheet();
    var range = e.range;
    var row = range.getRow();
    var column = range.getColumn();

    var channelCol = headers.indexOf("–ö–∞–Ω–∞–ª") + 1;
    var processLabelCol = headers.indexOf("process_lable") + 1;

    if (channelCol < 1 || processLabelCol < 1) return;
    if (![channelCol, processLabelCol].includes(column)) return; // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —ç—Ç–∏—Ö –∫–æ–ª–æ–Ω–∫–∞—Ö

    var channelValue = sheet.getRange(row, channelCol).getValue().toString().trim();
    var processLabelCell = sheet.getRange(row, processLabelCol);
    var processLabelValue = processLabelCell.getValue().toString().trim();

    // –°–ø–∏—Å–æ–∫ –∫–∞–Ω–∞–ª–æ–≤, –¥–ª—è –∫–æ—Ç–æ—Ä—ã—Ö process_lable –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω (–≤–∫–ª—é—á–∞–µ–º KakaoTalk)
    var requiredProcessLabelChannels = ["Whatsapp", "SMS", "WA/TG/SMS", "Viber", "KakaoTalk"];

    if (requiredProcessLabelChannels.includes(channelValue) && !processLabelValue) {
        // –û–±—è–∑–∞—Ç–µ–ª–µ–Ω, –Ω–æ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω
        processLabelCell.setBackground("#FFCDD2");
        processLabelCell.setNote("‚ùå –û—à–∏–±–∫–∞: 'process_lable' –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è " + channelValue);
    } else if (!requiredProcessLabelChannels.includes(channelValue) && processLabelValue) {
        // –ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è, –Ω–æ –∑–∞–ø–æ–ª–Ω–µ–Ω
        processLabelCell.setBackground("#FFCDD2");
        processLabelCell.setNote("‚ùå –û—à–∏–±–∫–∞: 'process_lable' –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—É—Å—Ç—ã–º –¥–ª—è " + channelValue);
    } else {
        // –í—Å–µ —Ö–æ—Ä–æ—à–æ (–∑–∞–ø–æ–ª–Ω–µ–Ω, –∫–æ–≥–¥–∞ –Ω—É–∂–Ω–æ, –∏–ª–∏ –ø—É—Å—Ç–æ–π, –∫–æ–≥–¥–∞ –Ω–µ –Ω—É–∂–Ω–æ)
        processLabelCell.setBackground(null);
        processLabelCell.setNote(""); 
    }
}

function clearStatusOnEdit(sheet, row, headers) {
    var statusCol = headers.indexOf("–ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Å—Ç—Ä–æ–∫–∏") + 1;
    if (statusCol < 1) return; // –ï—Å–ª–∏ –Ω–µ—Ç —Å—Ç–æ–ª–±—Ü–∞, –≤—ã—Ö–æ–¥–∏–º

    var statusCell = sheet.getRange(row, statusCol);
    var statusValue = statusCell.getValue().toString().trim();

    if (statusValue && statusValue !== "–ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –≤ –ë–î") {
        statusCell.setValue(""); // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ç—É—Å, –µ—Å–ª–∏ –æ–Ω –Ω–µ "–ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –≤ –ë–î"
    }
}

function validateUniqueTrack(e, headers, months) {
    var sheet = e.source.getActiveSheet();
    var range = e.range;
    var row = range.getRow();

    var statusCol = headers.indexOf("–°—Ç–∞—Ç—É—Å —Ä–∞—Å—Å—ã–ª–∫–∏") + 1;
    var trackCol = headers.indexOf("–¢—Ä–µ–∫") + 1;

    if (trackCol < 1 || statusCol < 1) return;

    var statusValue = sheet.getRange(row, statusCol).getValue();
    var trackValue = sheet.getRange(row, trackCol).getValue().trim();

    if (!trackValue ) return;

    function extractTrackId(track) {
        if (!track) return "";
        var match = track.match(/=(.+)$/);
        return match ? match[1].trim() : track.trim();
    }

    var normalizedTrack = extractTrackId(trackValue);
    var spreadsheet = sheet.getParent();
    var allTracks = new Map(); // –ò—Å–ø–æ–ª—å–∑—É–µ–º Map –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è {—Ç—Ä–µ–∫: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—Ö–æ–∂–¥–µ–Ω–∏–π}

    Logger.log("üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–µ–∫–∞: " + trackValue + " ‚Üí –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π: " + normalizedTrack);

    months.forEach(month => {
        var sheetByMonth = spreadsheet.getSheetByName(month);
        if (sheetByMonth) {
            var lastRow = sheetByMonth.getLastRow();
            Logger.log("üìÑ –õ–∏—Å—Ç: " + month + " | –ü–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç—Ä–æ–∫–∞: " + lastRow);

            if (lastRow > 1) {
                var rangeValues = sheetByMonth.getRange(2, trackCol, lastRow - 1, 1).getValues();

                rangeValues.flat().forEach((track, index) => {
                    if (track) {
                        var normalized = extractTrackId(track.toString());

                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –Ω–∞—à–∞ –ª–∏ —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞
                        var trackRow = index + 2; // +2, –ø–æ—Ç–æ–º—É —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å–æ 2-–π —Å—Ç—Ä–æ–∫–∏
                        if (month === sheet.getName() && trackRow === row) return; 

                        // –î–æ–±–∞–≤–ª—è–µ–º —Ç—Ä–µ–∫ –≤ Map, —É–≤–µ–ª–∏—á–∏–≤–∞—è —Å—á–µ—Ç—á–∏–∫
                        allTracks.set(normalized, (allTracks.get(normalized) || 0) + 1);
                    }
                });

                Logger.log("üìå –¢—Ä–µ–∫–∏ –Ω–∞ –ª–∏—Å—Ç–µ " + month + ": " + JSON.stringify([...allTracks]));
            }
        } else {
            Logger.log("‚ö† –õ–∏—Å—Ç '" + month + "' –Ω–µ –Ω–∞–π–¥–µ–Ω.");
        }
    });

    Logger.log("‚úÖ –§–∏–Ω–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ç—Ä–µ–∫–æ–≤ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è: " + JSON.stringify([...allTracks]));

    var trackCell = sheet.getRange(row, trackCol);

    if (allTracks.has(normalizedTrack)) {
        Logger.log("‚ùå –ù–∞–π–¥–µ–Ω –¥—É–±–ª–∏–∫–∞—Ç —Ç—Ä–µ–∫–∞: " + normalizedTrack);
        trackCell.setBackground("#FFCDD2");
        trackCell.setNote("–û—à–∏–±–∫–∞: –¥—É–±–ª–∏—Ä—É—é—â–∏–π—Å—è —Ç—Ä–µ–∫ –≤ –æ–¥–Ω–æ–º –∏–∑ –º–µ—Å—è—Ü–µ–≤.");
    } else {
        Logger.log("‚úÖ –¢—Ä–µ–∫ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π: " + normalizedTrack);
        trackCell.setBackground(null);
        trackCell.setNote("");
    }
}

function updateMirrorColumn(sheet, range, geoCol, mirrorCol) {
  const numRows = range.getNumRows();
  const startRow = range.getRow();

  const geoValues = sheet.getRange(startRow, geoCol, numRows, 1).getValues();
  const currentMirrorValues = sheet.getRange(startRow, mirrorCol, numRows, 1).getValues();

  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
  const channelCol = headers.indexOf("–ö–∞–Ω–∞–ª") + 1;
  const pathCol = headers.indexOf("–ü—É—Ç—å") + 1;
  const autoMirrorCol = headers.indexOf("auto_mirror") + 1;

  const channelValues = channelCol > 0
    ? sheet.getRange(startRow, channelCol, numRows, 1).getValues()
    : Array(numRows).fill(['']);
  const pathValues = pathCol > 0
    ? sheet.getRange(startRow, pathCol, numRows, 1).getValues()
    : Array(numRows).fill(['']);
  const autoMirrorValues = autoMirrorCol > 0
    ? sheet.getRange(startRow, autoMirrorCol, numRows, 1).getValues()
    : Array(numRows).fill([false]);

  const cachedMirrors = getCachedMirrors();
  const outputValues = [];

  for (let i = 0; i < numRows; i++) {
    const autoMirror = autoMirrorValues[i][0] === true;
    const geoValue = geoValues[i][0]?.toString().trim() || "";
    const mirrorValue = currentMirrorValues[i][0]?.toString().trim() || "";

    let newMirror = mirrorValue;

    if (autoMirror) {
      if (!geoValue || geoValue.includes(",")) {
        newMirror = "";
      } else {
        newMirror = cachedMirrors[geoValue] || "";
      }
    }

    outputValues.push([newMirror]);
  }

  sheet.getRange(startRow, mirrorCol, outputValues.length, 1).setValues(outputValues);
}






// üìå –ó–∞–≥—Ä—É–∂–∞–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∑–µ—Ä–∫–∞–ª
function getCachedMirrors() {
    var cachedData = PropertiesService.getScriptProperties().getProperty("geo_mirror_cache");
    if (!cachedData) return {};

    return JSON.parse(cachedData);
}




function updateDayOfWeek(sheet, range, dayOfWeekCol) {
    var editedValues = range.getValues(); // –ü–æ–ª—É—á–∞–µ–º –º–∞—Å—Å–∏–≤ –∑–Ω–∞—á–µ–Ω–∏–π
    var outputValues = [];
    
    var daysShort = ["–≤—Å", "–ø–Ω", "–≤—Ç", "—Å—Ä", "—á—Ç", "–ø—Ç", "—Å–±"];

    for (var i = 0; i < editedValues.length; i++) {
        var dateValue = editedValues[i][0];

        if (Object.prototype.toString.call(dateValue) === "[object Date]") {
            var dayShort = daysShort[dateValue.getDay()];
            outputValues.push([dayShort]); // –î–æ–±–∞–≤–ª—è–µ–º –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏
        } else {
            outputValues.push([""]); // –ï—Å–ª–∏ –¥–∞—Ç–∞ —É–¥–∞–ª–µ–Ω–∞ ‚Äì –æ—á–∏—â–∞–µ–º "–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏"
        }
    }

    // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤—Å–µ –∑–Ω–∞—á–µ–Ω–∏—è —Ä–∞–∑–æ–º
    sheet.getRange(range.getRow(), dayOfWeekCol, outputValues.length, 1).setValues(outputValues);
}

function updateLinkAndTrack(sheet, range, mirrorCol, pathCol, trackCol, linkTrackCol) {
    var numRows = range.getNumRows();
    var startRow = range.getRow();

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è)
    var mirrorValues = sheet.getRange(startRow, mirrorCol, numRows, 1).getValues();
    var pathValues = sheet.getRange(startRow, pathCol, numRows, 1).getValues();
    var trackValues = sheet.getRange(startRow, trackCol, numRows, 1).getValues();
    var existingLinkValues = sheet.getRange(startRow, linkTrackCol, numRows, 1).getValues();

    var outputValues = [];
    var needsUpdate = false;

    for (var i = 0; i < numRows; i++) {
        var mirror = mirrorValues[i][0] ? mirrorValues[i][0].toString().trim() : "";
        var path = pathValues[i][0] ? pathValues[i][0].toString().trim() : "";
        var track = trackValues[i][0] ? trackValues[i][0].toString().trim() : "";

        // üîπ –§–æ—Ä–º–∏—Ä—É–µ–º "–°—Å—ã–ª–∫–∞ + —Ç—Ä–µ–∫" –ø–æ –ª–æ–≥–∏–∫–µ —Ñ–æ—Ä–º—É–ª—ã
        var newLinkTrack = (mirror ? mirror : "") + path + track;

        // üîπ –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ
        if (newLinkTrack !== existingLinkValues[i][0]) {
            outputValues.push([newLinkTrack]);
            needsUpdate = true;
        } else {
            outputValues.push([existingLinkValues[i][0]]); // –û—Å—Ç–∞–≤–ª—è–µ–º –ø—Ä–µ–∂–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
        }
    }

    // üîπ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è: –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
    if (needsUpdate) {
        sheet.getRange(startRow, linkTrackCol, outputValues.length, 1).setValues(outputValues);
    }
}



function updateDuplicateColumns(sheet, row, refGeoCol, refChannelCol, refTimeCol, geoNCol, channelNCol, timeNCol) {
    var refGeo = sheet.getRange(row, refGeoCol).getValue();
    var refChannel = sheet.getRange(row, refChannelCol).getValue();
    var refTime = sheet.getRange(row, refTimeCol).getValue();

    if (geoNCol > 0) sheet.getRange(row, geoNCol).setValue(refGeo);
    if (channelNCol > 0) sheet.getRange(row, channelNCol).setValue(refChannel);
    if (timeNCol > 0) sheet.getRange(row, timeNCol).setValue(refTime);
}

function checkAndResetDuplicatedTransferredIds(e, headers) {
  const sheet = e.range.getSheet();
  const sheetName = sheet.getName();
  const range = e.range;
  const numRows = range.getNumRows();
  const startRow = range.getRow();

  const idCol = headers.indexOf("communication_id") + 1;
  const statusCol = headers.indexOf("–ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Å—Ç—Ä–æ–∫–∏") + 1;
  const trackCol = headers.indexOf("–¢—Ä–µ–∫") + 1;
  if (idCol < 1 || statusCol < 1 || trackCol < 1) return;

  const cacheRaw = PropertiesService.getScriptProperties().getProperty(`clean_ids_${sheetName}`);
  if (!cacheRaw) return;

  const cache = JSON.parse(cacheRaw);
  const idValues = sheet.getRange(startRow, idCol, numRows, 1).getValues();
  const statusValues = sheet.getRange(startRow, statusCol, numRows, 1).getValues();
  const trackValues = sheet.getRange(startRow, trackCol, numRows, 1).getValues();

  const clearedRows = [];

  for (let i = 0; i < numRows; i++) {
    const id = idValues[i][0]?.toString().trim();
    const status = statusValues[i][0]?.toString().trim();
    const track = extractTrackId(trackValues[i][0]);

    const cached = cache[id];
    if (!id || status !== "–ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –≤ –ë–î" || !cached) continue;

    if (cached.track === track) {
      clearedRows.push(i);
    }
  }

  if (clearedRows.length === 0) return;

  const emptyValues = clearedRows.map(() => [""]);
  sheet.getRange(startRow + clearedRows[0], idCol, clearedRows.length, 1).setValues(emptyValues);
  sheet.getRange(startRow + clearedRows[0], statusCol, clearedRows.length, 1).setValues(emptyValues);
}

function extractTrackId(rawTrack) {
  if (!rawTrack) return "";
  const match = rawTrack.match(/(?:\?|&)trid=([^&]+)/);
  return match ? match[1].trim() : rawTrack.trim();
}

