/**
 * –ñ—ë—Å—Ç–∫–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å –¥—É–±–ª–µ–π:
 * - –ï—Å–ª–∏ –∏ comm_id, –∏ track —É–∂–µ –µ—Å—Ç—å –≤ —á–∏—Å—Ç–æ–≤–æ–º ‚Üí —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ —Å—Ç—Ä–æ–∫–∞ —É–∂–µ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞: —Å—Ç–∞–≤–∏–º "–ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –≤ –ë–î".
 * - –ï—Å–ª–∏ comm_id —É–∂–µ –µ—Å—Ç—å, –Ω–æ track –¥—Ä—É–≥–æ–π ‚Üí –û–®–ò–ë–ö–ê, –Ω–µ –ø–µ—Ä–µ–Ω–æ—Å–∏–º.
 * - –ï—Å–ª–∏ track —É–∂–µ –µ—Å—Ç—å, –Ω–æ comm_id –¥—Ä—É–≥–æ–π ‚Üí –û–®–ò–ë–ö–ê, –Ω–µ –ø–µ—Ä–µ–Ω–æ—Å–∏–º.
 * - –ï—Å–ª–∏ –Ω–∏ comm_id, –Ω–∏ track –Ω–µ—Ç ‚Üí –ø–µ—Ä–µ–Ω–æ—Å–∏–º.
 * –í–æ –≤—Å–µ—Ö —Å—Ä–∞–≤–Ω–µ–Ω–∏—è—Ö track –±–µ—Ä—ë–º –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏ (normalizeTrackId).
 * –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ: –≤ –ø—Ä–æ–≥–æ–Ω –ø–æ–ø–∞–¥–∞—é—Ç –≤—Å–µ —Å—Ç—Ä–æ–∫–∏, –ö–†–û–ú–ï —É–∂–µ –ø–æ–º–µ—á–µ–Ω–Ω—ã—Ö "–ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –≤ –ë–î".
 * * –ù–û–í–´–ï –ü–†–û–í–ï–†–ö–ò:
 * - –û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø–æ–ª–µ–π
 * - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–Ω–∞–ª–∞ –ø–æ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫—É
 * - –£—Å–∏–ª–µ–Ω–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è —Å email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
 */
function transferCompletedRowsFor(kpName) {
  // 0) –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–ø—Ä–∞–≤–æ—á–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –∫–∞–Ω–∞–ª—ã
  const validChannels = loadValidChannels();
  
  // 1) –ê–∫—Ç—É–∞–ª–∏–∑–∏—Ä—É–µ–º –∫—ç—à —á–∏—Å—Ç–æ–≤–æ–≥–æ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–Ω–æ—Å–æ–º
  cacheCleanCommunicationIds();

  const SP = PropertiesService.getScriptProperties();
  const kps = JSON.parse(SP.getProperty("active_kps") || "[]");
  const kp = kps.find(k => k.name === kpName);
  if (!kp) return Logger.log(`‚ö† –ö–ü '${kpName}' –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ ScriptProperties.`);

  const tz = Session.getScriptTimeZone();
  const now = new Date();
  const currentSheetName = Utilities.formatDate(now, tz, "MMMM_yyyy");
  const prevDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
  const previousSheetName = Utilities.formatDate(prevDate, tz, "MMMM_yyyy");

  const sheetNamesToProcess = [currentSheetName, previousSheetName];

  sheetNamesToProcess.forEach(sheetName => {
    // 2) —á–∏—Ç–∞–µ–º –∫—ç—à —á–∏—Å—Ç–æ–≤–æ–≥–æ –ø–æ –º–µ—Å—è—Ü—É: { comm_id: {track, date}, ... }
    let enrichedCache = {};
    try {
      const raw = SP.getProperty(`clean_ids_${sheetName}`);
      enrichedCache = raw ? JSON.parse(raw) : {};
    } catch (e) {
      Logger.log(`‚ö† –ë–∏—Ç—ã–π JSON –≤ clean_ids_${sheetName}: ${e}. –ò—Å–ø–æ–ª—å–∑—É—é –ø—É—Å—Ç–æ–π –∫—ç—à.`);
      enrichedCache = {};
    }
    // id –∏ track –Ω–∞–±–æ—Ä—ã –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫
    const cachedIds = new Set(Object.keys(enrichedCache));
    const cachedTracks = new Set(
      Object.values(enrichedCache)
        .map(e => normalizeTrackId(e && e.track))
        .filter(Boolean)
    );

    try {
      const workBook = SpreadsheetApp.openById(kp.id_work);
      const cleanBook = SpreadsheetApp.openById(kp.id_clean);

      const workSheet = workBook.getSheetByName(sheetName);
      let cleanSheet = cleanBook.getSheetByName(sheetName);
      if (!workSheet) return Logger.log(`‚ö† –õ–∏—Å—Ç '${sheetName}' –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ —Ä–∞–±–æ—á–µ–º –ö–ü ${kpName}`);
      if (!cleanSheet) cleanSheet = cleanBook.insertSheet(sheetName);

      const workHeaders = workSheet.getRange(1, 1, 1, workSheet.getLastColumn()).getValues()[0];
      const cleanHeaders = cleanSheet.getRange(1, 1, 1, cleanSheet.getLastColumn()).getValues()[0];

      // 3) –ù–û–í–ê–Ø –ü–†–û–í–ï–†–ö–ê: –°—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å—Ç–æ–ª–±—Ü–æ–≤
      const criticalColumns = ["–î–∞—Ç–∞", "–°—Ç–∞—Ç—É—Å —Ä–∞—Å—Å—ã–ª–∫–∏", "–í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ –ú–°–ö", "–ö–∞–Ω–∞–ª", "–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ", "communication_id", "–ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Å—Ç—Ä–æ–∫–∏", "–¢—Ä–µ–∫"];
      const missingColumns = criticalColumns.filter(col => workHeaders.indexOf(col) === -1);
      if (missingColumns.length > 0) {
        Logger.log(`‚ùå –í –ª–∏—Å—Ç–µ '${sheetName}' –ö–ü '${kpName}' –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å—Ç–æ–ª–±—Ü—ã: ${missingColumns.join(", ")}`);
        sendErrorNotification(`–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å—Ç–æ–ª–±—Ü—ã –≤ –ö–ü ${kpName}, –ª–∏—Å—Ç ${sheetName}`, `–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ —Å—Ç–æ–ª–±—Ü—ã: ${missingColumns.join(", ")}`);
        return;
      }

      const statusCol = workHeaders.indexOf("–°—Ç–∞—Ç—É—Å —Ä–∞—Å—Å—ã–ª–∫–∏") + 1;
      const correctnessCol = workHeaders.indexOf("–ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Å—Ç—Ä–æ–∫–∏") + 1;
      const idCol = workHeaders.indexOf("communication_id") + 1;
      const trackColIdx = workHeaders.indexOf("–¢—Ä–µ–∫"); // 0-based
      if (statusCol < 1 || correctnessCol < 1 || idCol < 1 || trackColIdx < 0) return;

      const lastRow = workSheet.getLastRow();
      if (lastRow < 2) return;

      const width = workSheet.getLastColumn();
      const data = workSheet.getRange(2, 1, lastRow - 1, width).getValues();
      const correctnessValues = workSheet.getRange(2, correctnessCol, lastRow - 1, 1).getValues();

      // 4) –î—É–±–ª–∏ –≤ —Ä–∞–±–æ—á–µ–º –ª–∏—Å—Ç–µ ‚Äî –ø–æ –û–ß–ò–©–ï–ù–ù–û–ú–£ —Ç—Ä–µ–∫—É (–Ω–µ –±–ª–æ–∫–∏—Ä—É—é—Ç –ø–æ–≤—Ç–æ—Ä–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É; –±—É–¥—É—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω—ã)
      const trackMap = new Map(); // cleanTrack -> [rowIdx...]
      data.forEach((row, i) => {
        const status = String(row[statusCol - 1] || "").trim();
        const cleanTrack = normalizeTrackId(row[trackColIdx]);
        // –ë–µ—Ä—ë–º –≤ –∫–∞—Ä—Ç—É –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ "–í—ã–ø–æ–ª–Ω–µ–Ω–∞" –≤–Ω–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø—Ä–æ—à–ª—ã—Ö –æ—à–∏–±–æ–∫
        if (status === "–í—ã–ø–æ–ª–Ω–µ–Ω–∞" && cleanTrack) {
          if (!trackMap.has(cleanTrack)) trackMap.set(cleanTrack, [i]);
          else trackMap.get(cleanTrack).push(i);
        }
      });
      trackMap.forEach((rows, t) => {
        if (rows.length > 1) {
          Logger.log(`‚ö† –î—É–±–ª–∏ —Ç—Ä–µ–∫–∞ –≤ —Ä–∞–±–æ—á–µ–º (track_id=${t}) —Å—Ç—Ä–æ–∫–∏: ${rows.map(r => r + 2).join(", ")}`);
          rows.forEach(i => correctnessValues[i][0] = `‚ùå –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—Ä–µ–∫–∞ –≤ —Ä–∞–±–æ—á–µ–º (track_id=${t})`);
        }
      });

      // 5) –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª —Å –ª–æ–≥–∏–∫–æ–π (–ò–ó–ú–ï–ù–Å–ù –ü–û–†–Ø–î–û–ö –ü–†–û–í–ï–†–û–ö)
      const toTransfer = [];
      const timestamp = Utilities.formatDate(new Date(), tz, "dd.MM.yyyy HH:mm:ss");
      const batchIds = new Set();
      const batchTracks = new Set();
      let errorCount = 0;

      data.forEach((row, i) => {
        const communicationId = String(row[idCol - 1] || "").trim();
        const status = String(row[statusCol - 1] || "").trim();
        const existingCorrectness = String(correctnessValues[i][0] || "").trim();

        // –í –ø—Ä–æ–≥–æ–Ω –∏–¥—É—Ç –≤—Å–µ, –ö–†–û–ú–ï —É–∂–µ –ø–æ–º–µ—á–µ–Ω–Ω—ã—Ö "–ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –≤ –ë–î"
        if (existingCorrectness === "–ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –≤ –ë–î") return;

        // –ù–û–í–´–ô –ü–û–†–Ø–î–û–ö: –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è, –ø–æ—Ç–æ–º –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥—É–±–ª–µ–π
        
        // 5.1) –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑–æ–≤—ã—Ö —É—Å–ª–æ–≤–∏–π –¥–ª—è –ø–æ–ø–∞–¥–∞–Ω–∏—è –≤ –æ–±—Ä–∞–±–æ—Ç–∫—É
        if (!communicationId || status !== "–í—ã–ø–æ–ª–Ω–µ–Ω–∞") return; // –ù–µ –æ—à–∏–±–∫–∞, –ø—Ä–æ—Å—Ç–æ –Ω–µ –≥–æ—Ç–æ–≤–∞ –∫ –ø–µ—Ä–µ–Ω–æ—Å—É

        // 5.2) –ù–û–í–ê–Ø –£–°–ò–õ–ï–ù–ù–ê–Ø –í–ê–õ–ò–î–ê–¶–ò–Ø (–≤–∫–ª—é—á–∞—è –ø—Ä–æ–≤–µ—Ä–∫—É –∫–∞–Ω–∞–ª–∞ –ø–æ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫—É)
        const validationErrors = validateRowEnhanced(row, workHeaders, validChannels);
        if (validationErrors.length > 0) {
          correctnessValues[i][0] = validationErrors.join("; ");
          errorCount++;
          return;
        }

        const cleanTrack = normalizeTrackId(row[trackColIdx]);

        const idExists = cachedIds.has(communicationId);
        const trackExists = cleanTrack && cachedTracks.has(cleanTrack);

        // 5.3) –ü—Ä–æ–≤–µ—Ä–∫–∏ –¥—É–±–ª–µ–π –≤ —á–∏—Å—Ç–æ–≤–æ–º
        if (idExists && trackExists) {
          if (existingCorrectness !== "–ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –≤ –ë–î") correctnessValues[i][0] = "–ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –≤ –ë–î";
          return;
        }
        if (idExists && !trackExists) {
          correctnessValues[i][0] = `‚ùå –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ communication_id –≤ —á–∏—Å—Ç–æ–≤–æ–º (id=${communicationId})`;
          errorCount++;
          return;
        }
        if (!idExists && trackExists) {
          correctnessValues[i][0] = `‚ùå –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—Ä–µ–∫–∞ –≤ —á–∏—Å—Ç–æ–≤–æ–º (track_id=${cleanTrack})`;
          errorCount++;
          return;
        }

        // 5.4) –í–Ω—É—Ç—Ä–∏–ø–∞–∫–µ—Ç–Ω—ã–µ –¥—É–±–ª–∏ –≤ —Ä–∞–º–∫–∞—Ö –æ–¥–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
        if (batchIds.has(communicationId)) {
          correctnessValues[i][0] = `‚ùå –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ communication_id –≤ —Ç–µ–∫—É—â–µ–π –ø–∞—Ä—Ç–∏–∏ (${communicationId})`;
          errorCount++;
          return;
        }
        if (cleanTrack && batchTracks.has(cleanTrack)) {
          correctnessValues[i][0] = `‚ùå –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—Ä–µ–∫–∞ –≤ —Ç–µ–∫—É—â–µ–π –ø–∞—Ä—Ç–∏–∏ (track_id=${cleanTrack})`;
          errorCount++;
          return;
        }

        // 5.5) –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Å—ã–ª–∫–∏
        const expectedLink = constructLinkAndTrack(row, workHeaders, workSheet, i + 2);
        const linkIdx = workHeaders.indexOf("–°—Å—ã–ª–∫–∞ + —Ç—Ä–µ–∫");
        const actualLink = linkIdx >= 0 ? row[linkIdx] : "";
        if (actualLink && expectedLink && actualLink !== expectedLink) {
          correctnessValues[i][0] = "‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –°—Å—ã–ª–∫–∞ + —Ç—Ä–µ–∫";
          errorCount++;
          return;
        }

        // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É –¥–ª—è —á–∏—Å—Ç–æ–≤–æ–≥–æ (–¢—Ä–µ–∫ ‚Äî —É–∂–µ –æ—á–∏—â–µ–Ω–Ω—ã–π id)
        const newRow = cleanHeaders.map(header => {
          const idx = workHeaders.indexOf(header);
          if (idx > -1) {
            let value = row[idx];
            if (header === "–¢—Ä–µ–∫") value = normalizeTrackId(value);        // <-- —Ç–æ–ª—å–∫–æ id
            if (header === "process_lable") value = filterProcessLable(row, workHeaders);
            return value;
          } else if (header === "moving_date") {
            return timestamp;
          } else {
            return "";
          }
        });

        toTransfer.push(newRow);
        correctnessValues[i][0] = "–ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –≤ –ë–î";

        // –§–∏–∫—Å–∏—Ä—É–µ–º –≤ –±–∞—Ç—á–µ
        batchIds.add(communicationId);
        if (cleanTrack) batchTracks.add(cleanTrack);
      });

      // 6) –ó–∞–ø–∏—Å—å –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—ç—à–∞
      if (toTransfer.length > 0) {
        const startRow = Math.max(2, cleanSheet.getLastRow() + 1);
        cleanSheet.getRange(startRow, 1, toTransfer.length, cleanHeaders.length).setValues(toTransfer);
        SpreadsheetApp.flush();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à (—Ö—Ä–∞–Ω–∏–º –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π track)
        const idxId = cleanHeaders.indexOf("communication_id");
        const idxTrack = cleanHeaders.indexOf("–¢—Ä–µ–∫");
        const idxDate = cleanHeaders.indexOf("moving_date");
        toTransfer.forEach(r => {
          const id = String(r[idxId] || "").trim();
          const tr = normalizeTrackId(r[idxTrack]);
          const dt = r[idxDate];
          if (id && tr && dt) {
            enrichedCache[id] = { track: tr, date: dt };
            cachedIds.add(id);
            cachedTracks.add(tr);
          }
        });
        SP.setProperty(`clean_ids_${sheetName}`, JSON.stringify(enrichedCache));
      }

      // 7) –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏
      workSheet.getRange(2, correctnessCol, lastRow - 1, 1).setValues(correctnessValues);

      // 8) –ù–û–í–û–ï: –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–≤–æ–¥–∫–∏
      Logger.log(`üìä –ö–ü '${kpName}', –ª–∏—Å—Ç '${sheetName}': –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ ${data.length} —Å—Ç—Ä–æ–∫, –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ ${toTransfer.length}, –æ—à–∏–±–æ–∫ ${errorCount}`);

    } catch (error) {
      Logger.log(`‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–Ω–æ—Å–∞ –¥–ª—è –ö–ü '${kpName}', –ª–∏—Å—Ç '${sheetName}': ${error}`);
      sendErrorNotification(`–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–Ω–æ—Å–∞ –ö–ü ${kpName}, –ª–∏—Å—Ç ${sheetName}`, error.toString());
    }
  });
}

/* ===================== –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò ===================== */

/**
 * –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –¥–æ–ø—É—Å—Ç–∏–º—ã—Ö –∫–∞–Ω–∞–ª–æ–≤
 * @returns {Set|null} Set —Å –¥–æ–ø—É—Å—Ç–∏–º—ã–º–∏ –∫–∞–Ω–∞–ª–∞–º–∏ –∏–ª–∏ null –ø—Ä–∏ –æ—à–∏–±–∫–µ
 */
function loadValidChannels() {
  try {
    const referenceFileId = "1JHFCWOj4A82dSNeLHb68B5JHHPxfvHHxg8_e4tjjQtY";
    const referenceBook = SpreadsheetApp.openById(referenceFileId);
    const referenceSheet = referenceBook.getSheetByName("reference_channel_N");
    
    if (!referenceSheet) {
      throw new Error("–õ–∏—Å—Ç 'reference_channel_N' –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–æ–º —Ñ–∞–π–ª–µ");
    }
    
    const channelColIndex = referenceSheet.getRange(1, 1, 1, referenceSheet.getLastColumn())
      .getValues()[0].indexOf("–ö–∞–Ω–∞–ª");
    
    if (channelColIndex === -1) {
      throw new Error("–°—Ç–æ–ª–±–µ—Ü '–ö–∞–Ω–∞–ª' –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–æ–º –ª–∏—Å—Ç–µ");
    }
    
    const lastRow = referenceSheet.getLastRow();
    if (lastRow < 2) {
      throw new Error("–°–ø—Ä–∞–≤–æ—á–Ω—ã–π –ª–∏—Å—Ç –ø—É—Å—Ç (–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∫—Ä–æ–º–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞)");
    }
    
    const channelValues = referenceSheet.getRange(2, channelColIndex + 1, lastRow - 1, 1).getValues();
    const validChannels = new Set();
    
    channelValues.forEach(row => {
      const channel = String(row[0] || "").trim();
      if (channel) validChannels.add(channel);
    });
    
    Logger.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${validChannels.size} –¥–æ–ø—É—Å—Ç–∏–º—ã—Ö –∫–∞–Ω–∞–ª–æ–≤ –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞`);
    return validChannels;
    
  } catch (error) {
    Logger.log(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ –∫–∞–Ω–∞–ª–æ–≤: ${error}`);
    sendErrorNotification("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ –∫–∞–Ω–∞–ª–æ–≤", error.toString());
    return null;
  }
}

/**
 * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
 * @param {string} subject - –¢–µ–º–∞ –ø–∏—Å—å–º–∞
 * @param {string} body - –¢–µ–∫—Å—Ç –ø–∏—Å—å–º–∞
 */
function sendErrorNotification(subject, body) {
  try {
    const recipients = "alisa.rumyantseva@1win.pro,rostislav.shevchenko@1win.pro";
    const fullSubject = `[–ö–ü –°–∏—Å—Ç–µ–º–∞] ${subject}`;
    const fullBody = `–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –≤ —Å–∏—Å—Ç–µ–º–µ –ø–µ—Ä–µ–Ω–æ—Å–∞ –¥–∞–Ω–Ω—ã—Ö –ö–ü:

${body}

–í—Ä–µ–º—è: ${new Date()}
–§—É–Ω–∫—Ü–∏—è: transferCompletedRowsFor()

–¢—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º—ã.`;

    GmailApp.sendEmail(recipients, fullSubject, fullBody);
    Logger.log(`üìß –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ: ${subject}`);
  } catch (emailError) {
    Logger.log(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: ${emailError}`);
  }
}

/**
 * –ù–û–í–ê–Ø –£–°–ò–õ–ï–ù–ù–ê–Ø –í–ê–õ–ò–î–ê–¶–ò–Ø —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø–æ–ª–µ–π –∏ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ –∫–∞–Ω–∞–ª–æ–≤
 * @param {Array} row - –î–∞–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏
 * @param {Array} headers - –ó–∞–≥–æ–ª–æ–≤–∫–∏
 * @param {Set|null} validChannels - –ù–∞–±–æ—Ä –¥–æ–ø—É—Å—Ç–∏–º—ã—Ö –∫–∞–Ω–∞–ª–æ–≤
 * @returns {Array} –ú–∞—Å—Å–∏–≤ –æ—à–∏–±–æ–∫
 */
function validateRowEnhanced(row, headers, validChannels) {
  const errors = [];

  // 1) –ù–û–í–ê–Ø –ü–†–û–í–ï–†–ö–ê: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–ª—è (–¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω—ã)
  const criticalFields = ["–î–∞—Ç–∞", "–°—Ç–∞—Ç—É—Å —Ä–∞—Å—Å—ã–ª–∫–∏", "–í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ –ú–°–ö", "–ö–∞–Ω–∞–ª", "–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ"];
  
  criticalFields.forEach(field => {
    const idx = headers.indexOf(field);
    if (idx === -1) {
      errors.push(`‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–æ–ª–±–µ—Ü: ${field}`);
    } else if (!row[idx] || row[idx].toString().trim() === "") {
      errors.push(`‚ùå –ù–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ –ø–æ–ª–µ: ${field}`);
    }
  });

  // 2) –ù–û–í–ê–Ø –ü–†–û–í–ï–†–ö–ê: –ö–∞–Ω–∞–ª –ø–æ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫—É
  const channelIdx = headers.indexOf("–ö–∞–Ω–∞–ª");
  if (channelIdx > -1 && validChannels) {
    const channel = String(row[channelIdx] || "").trim();
    if (channel && !validChannels.has(channel)) {
      errors.push(`‚ùå –ù–µ–¥–æ–ø—É—Å—Ç–∏–º–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∫–∞–Ω–∞–ª–∞: ${channel}`);
    }
  }

  // 3) –û—Å—Ç–∞–ª—å–Ω—ã–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è (—Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –ª–æ–≥–∏–∫–∞)
  const remainingRequired = [
    "communication_id", "–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏", "–¢–µ–º–∞ —Ä–∞—Å—Å—ã–ª–∫–∏", "–ì–ï–û", "–ì—Ä—É–ø–ø–∞ —Å–µ–≥–º–µ–Ω—Ç–æ–≤",
    "–ü–æ–¥—Å–µ–≥–º–µ–Ω—Ç", "–¢–µ—Å—Ç—ã", "–¢—Ä–µ–∫", "–ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ–≥–º–µ–Ω—Ç–∞ –≤ CDP"
  ];

  remainingRequired.forEach(field => {
    const idx = headers.indexOf(field);
    if (idx === -1) {
      errors.push(`‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–æ–ª–±–µ—Ü: ${field}`);
    } else if (!row[idx] || row[idx].toString().trim() === "") {
      errors.push(`‚ùå –ü—Ä–æ–ø—É—â–µ–Ω–æ –ø–æ–ª–µ: ${field}`);
    }
  });

  // 4) –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è
  const chIdx = headers.indexOf("–ö–∞–Ω–∞–ª");
  const nIdx = headers.indexOf("–¢–∏–ø –Ω–æ—Ç–∏—Ñ–∞");
  const pIdx = headers.indexOf("process_lable");

  if (chIdx > -1) {
    const channel = row[chIdx]?.toString().trim();
    const notifType = nIdx > -1 ? row[nIdx]?.toString().trim() : "";
    const label = pIdx > -1 ? row[pIdx]?.toString().trim() : "";

    if (channel === "Notification" && !notifType) errors.push("‚ùå '–¢–∏–ø –Ω–æ—Ç–∏—Ñ–∞' –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω");
    if (channel !== "Notification" && notifType) errors.push("‚ùå '–¢–∏–ø –Ω–æ—Ç–∏—Ñ–∞' –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—É—Å—Ç—ã–º");
    // KakaoTalk –∑–¥–µ—Å—å —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –≤–∞—à–µ–º –∏—Å—Ö–æ–¥–Ω–æ–º —Å–∫—Ä–∏–ø—Ç–µ
    if ((channel === "Whatsapp" || channel === "SMS" || channel === "WA/TG/SMS" || channel === "Viber"|| channel === "KakaoTalk") && !label) errors.push("‚ùå 'process_lable' –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω");
    if (channel !== "Whatsapp" && channel !== "SMS" && channel !== "WA/TG/SMS" && channel !== "Viber"  && channel !== "KakaoTalk" && label) errors.push("‚ùå 'process_lable' –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—É—Å—Ç—ã–º");
  }

  return errors;
}

/* ===================== –ü–æ–¥–¥–µ—Ä–∂–∫–∞ (—Å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ –¥–ª—è KakaoTalk) ===================== */

// –ï–¥–∏–Ω–∞—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç—Ä–µ–∫–æ–≤: –≤—ã—Ç—è–≥–∏–≤–∞–µ–º trid=<id> –∏–∑ URL,
// –∏–Ω–∞—á–µ –±–µ—Ä—ë–º ¬´–ø–æ—Ö–æ–∂–∏–π –Ω–∞ id¬ª —Ç–æ–∫–µ–Ω (–±—É–∫–≤—ã+—Ü–∏—Ñ—Ä—ã), –∏–Ω–∞—á–µ ‚Äî —Å—Ç—Ä–æ–∫—É –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤.
function normalizeTrackId(track) {
  if (track == null) return "";
  const s = String(track).trim();

  const mUrl = s.match(/(?:[?&;])trid=([^&#;,\s]+)/i);
  if (mUrl && mUrl[1]) return decodeURIComponent(mUrl[1].trim());

  const mToken = s.match(/\b([A-Za-z]{2,12}\d{5,})\b/); // aztr072500001 / asia12591083
  if (mToken && mToken[1]) return mToken[1];

  return s.replace(/\s+/g, "");
}

// –û—Å—Ç–∞–≤–ª–µ–Ω–æ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏: —Ç–µ–ø–µ—Ä—å –ø—Ä–æ—Å—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç normalizeTrackId
function extractTrackIdTransfer(track) {
  return normalizeTrackId(track);
}

// üéØ –í–∞–ª–∏–¥–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π + —Å–ø–µ—Ü. —É—Å–ª–æ–≤–∏–π (–û–ë–ù–û–í–õ–ï–ù–û: –¥–æ–±–∞–≤–ª–µ–Ω KakaoTalk)
function validateRow(row, headers) {
  // –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –æ—Å—Ç–∞–≤–ª–µ–Ω–∞ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏, –Ω–æ —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è validateRowEnhanced
  const required = [
    "communication_id", "–î–∞—Ç–∞", "–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏", "–°—Ç–∞—Ç—É—Å —Ä–∞—Å—Å—ã–ª–∫–∏", "–í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ –ú–°–ö",
    "–ö–∞–Ω–∞–ª", "–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ", "–¢–µ–º–∞ —Ä–∞—Å—Å—ã–ª–∫–∏", "–ì–ï–û", "–ì—Ä—É–ø–ø–∞ —Å–µ–≥–º–µ–Ω—Ç–æ–≤",
    "–ü–æ–¥—Å–µ–≥–º–µ–Ω—Ç", "–¢–µ—Å—Ç—ã", "–¢—Ä–µ–∫", "–ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ–≥–º–µ–Ω—Ç–∞ –≤ CDP"
  ];

  const errors = [];

  required.forEach(field => {
    const idx = headers.indexOf(field);
    if (idx > -1 && (!row[idx] || row[idx].toString().trim() === "")) {
      errors.push("‚ùå –ü—Ä–æ–ø—É—â–µ–Ω–æ –ø–æ–ª–µ: " + field);
    }
  });

  const chIdx = headers.indexOf("–ö–∞–Ω–∞–ª");
  const nIdx = headers.indexOf("–¢–∏–ø –Ω–æ—Ç–∏—Ñ–∞");
  const pIdx = headers.indexOf("process_lable");

  if (chIdx > -1) {
    const channel = row[chIdx]?.toString().trim();
    const notifType = nIdx > -1 ? row[nIdx]?.toString().trim() : "";
    const label = pIdx > -1 ? row[pIdx]?.toString().trim() : "";

    if (channel === "Notification" && !notifType) errors.push("‚ùå '–¢–∏–ø –Ω–æ—Ç–∏—Ñ–∞' –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω");
    if (channel !== "Notification" && notifType) errors.push("‚ùå '–¢–∏–ø –Ω–æ—Ç–∏—Ñ–∞' –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—É—Å—Ç—ã–º");
    // –î–æ–±–∞–≤–ª–µ–Ω KakaoTalk
    if ((channel === "Whatsapp" || channel === "SMS" || channel === "WA/TG/SMS" || channel === "Viber" || channel === "KakaoTalk") && !label) errors.push("‚ùå 'process_lable' –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω");
    // –î–æ–±–∞–≤–ª–µ–Ω KakaoTalk
    if (channel !== "Whatsapp" && channel !== "SMS" && channel !== "WA/TG/SMS" && channel !== "Viber" && channel !== "KakaoTalk" && label) errors.push("‚ùå 'process_lable' –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—É—Å—Ç—ã–º");
  }

  return errors;
}

// üîß –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
function constructLinkAndTrack(row, headers, sheet, rowIndex) {
  const m = headers.indexOf("–ó–µ—Ä–∫–∞–ª–æ"),
        p = headers.indexOf("–ü—É—Ç—å"),
        t = headers.indexOf("–¢—Ä–µ–∫");

  const mirror = sheet.getRange(rowIndex, m + 1).getFormula() || row[m] || "";
  const path = row[p] || "";
  const track = row[t] || "";

  if (!mirror) return path + track;
  if (!path) return mirror + track;
  return mirror + path + track;
}

// üîß process_lable (–û–ë–ù–û–í–õ–ï–ù–û: –¥–æ–±–∞–≤–ª–µ–Ω KakaoTalk –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞ –∑–Ω–∞—á–µ–Ω–∏—è)
function filterProcessLable(row, headers) {
  const c = headers.indexOf("–ö–∞–Ω–∞–ª"),
        p = headers.indexOf("process_lable");

  if (c > -1 && p > -1) {
    const channel = row[c]?.toString().trim();
    const value = row[p];
    // –î–æ–±–∞–≤–ª–µ–Ω KakaoTalk
    if (channel === "Whatsapp" || channel === "SMS" || channel === "WA/TG/SMS" || channel === "Viber" || channel === "KakaoTalk") return value;
  }
  return "";
}

function transferCompletedRowsFor_TEST() {
  transferCompletedRowsFor("TEST");
}
