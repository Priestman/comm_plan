/**
 * –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–≤–æ–π—Å—Ç–≤ —Å–∫—Ä–∏–ø—Ç–∞.
 * –í—ã–¥–∞—Å—Ç –æ—à–∏–±–∫—É, –µ—Å–ª–∏ —Å–≤–æ–π—Å—Ç–≤–æ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ, –ø–æ–º–æ–≥–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—ã.
 * @param {string} key –ö–ª—é—á —Å–≤–æ–π—Å—Ç–≤–∞, –∫–æ—Ç–æ—Ä–æ–µ –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å.
 * @returns {string} –ó–Ω–∞—á–µ–Ω–∏–µ —Å–≤–æ–π—Å—Ç–≤–∞.
 * @throws {Error} –ï—Å–ª–∏ —Å–≤–æ–π—Å—Ç–≤–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.
 */
function getScriptProperty(key) {
  const properties = PropertiesService.getScriptProperties();
  const value = properties.getProperty(key);
  if (!value) {
    throw new Error(`–û—à–∏–±–∫–∞: –°–≤–æ–π—Å—Ç–≤–æ '${key}' –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –µ–≥–æ –≤ '–ù–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ø—Ä–æ–µ–∫—Ç–∞' -> '–°–≤–æ–π—Å—Ç–≤–∞ —Å–∫—Ä–∏–ø—Ç–∞'.`);
  }
  return value;
}

/**
 * –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç –∫–æ–ª–æ–Ω–∫—É "–ì–ï–û –ø–µ—Ä–µ–≤–æ–¥—ã" –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–∞–¥–∞–Ω–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π.
 * –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–º—É —Ç—Ä–∏–≥–≥–µ—Ä—É (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 2 –º–∏–Ω—É—Ç—ã).
 */
function autoFillGeoTranslations() {
  Logger.log(`üîó –ó–∞–ø—É—Å–∫ —Ñ—É–Ω–∫—Ü–∏–∏ autoFillGeoTranslations.`);

  // –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ PropertiesService
  const TARGET_SPREADSHEET_ID = getScriptProperty('TARGET_SPREADSHEET_ID');
  const GEO_LANG_MAP_FILE_ID = getScriptProperty('GEO_LANG_MAP_FILE_ID');
  const GEO_LANG_MAP_SHEET_NAME_IN_FILE = getScriptProperty('GEO_LANG_MAP_SHEET_NAME_IN_FILE');

  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ —è–≤–ª—è—é—Ç—Å—è "—á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏"
  const CHANNELS_ALLOWING_MANUAL_INPUT = new Set(["SMS", "Whatsapp"]);
  const GEO_LIST_DELIMITER = ",";

  let spreadsheet;
  try {
    spreadsheet = SpreadsheetApp.openById(TARGET_SPREADSHEET_ID);
    Logger.log(`‚úÖ –û—Ç–∫—Ä—ã—Ç —Ü–µ–ª–µ–≤–æ–π —Ñ–∞–π–ª: '${spreadsheet.getName()}' (ID: ${TARGET_SPREADSHEET_ID})`);
  } catch (e) {
    Logger.log(`‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å —Ü–µ–ª–µ–≤–æ–π —Ñ–∞–π–ª —Å ID '${TARGET_SPREADSHEET_ID}'. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ ID –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω –∏ —É —Å–∫—Ä–∏–ø—Ç–∞ –µ—Å—Ç—å –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞. ${e.message}`);
    return; // –ü—Ä–µ—Ä—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ, –µ—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ –æ—Ç–∫—Ä—ã–ª—Å—è
  }

  const now = new Date();
  const scriptTimeZone = Session.getScriptTimeZone();

  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–º–µ–Ω–∞ –ª–∏—Å—Ç–æ–≤ —Ç–µ–∫—É—â–µ–≥–æ –∏ —Å–ª–µ–¥—É—é—â–µ–≥–æ –º–µ—Å—è—Ü–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
  const currentMonthName = Utilities.formatDate(now, scriptTimeZone, "MMMM_yyyy");
  
  // üí° –ù–ê–î–ï–ñ–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï:
  // 1. –°–æ–∑–¥–∞–µ–º –¥–∞—Ç—É, –∫–æ—Ç–æ—Ä–∞—è —è–≤–ª—è–µ—Ç—Å—è –ø–µ—Ä–≤—ã–º —á–∏—Å–ª–æ–º *—Ç–µ–∫—É—â–µ–≥–æ* –º–µ—Å—è—Ü–∞.
  //    –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏–∑–±–µ–∂–∞—Ç—å —Å–¥–≤–∏–≥–∞ –∏–∑-–∑–∞ 31-–≥–æ —á–∏—Å–ª–∞ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –º–µ—Å—è—Ü—É.
  const dateForNextMonth = new Date(now.getFullYear(), now.getMonth(), 1); 
  // 2. –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –º–µ—Å—è—Ü –Ω–∞ 1.
  dateForNextMonth.setMonth(dateForNextMonth.getMonth() + 1);
  
  // 3. –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –Ω—É–∂–Ω–æ–π –≤—Ä–µ–º–µ–Ω–Ω–æ–π –∑–æ–Ω–µ.
  const nextMonthName = Utilities.formatDate(dateForNextMonth, scriptTimeZone, "MMMM_yyyy");

  Logger.log(`üëâ –ë—É–¥—É—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã –ª–∏—Å—Ç—ã: '${currentMonthName}' –∏ '${nextMonthName}'.`);

  try {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–∞—Ä—Ç—É —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π –ì–ï–û-–Ø–∑—ã–∫–æ–≤ –æ–¥–∏–Ω —Ä–∞–∑
    const geoDataFromMapping = getGeoLanguageMap(GEO_LANG_MAP_FILE_ID, GEO_LANG_MAP_SHEET_NAME_IN_FILE);
    const geoLanguageMap = geoDataFromMapping.geoLanguageMap;

    const currentMonthSheet = spreadsheet.getSheetByName(currentMonthName);
    if (currentMonthSheet) {
      processSheetForConditionalGeoTranslations(currentMonthSheet, geoLanguageMap, CHANNELS_ALLOWING_MANUAL_INPUT, GEO_LIST_DELIMITER);
    } else {
      Logger.log(`‚ÑπÔ∏è –õ–∏—Å—Ç '${currentMonthName}' –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ñ–∞–π–ª–µ '${spreadsheet.getName()}'. –ü—Ä–æ–ø—É—Å–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏.`);
    }

    const nextMonthSheet = spreadsheet.getSheetByName(nextMonthName);
    if (nextMonthSheet) {
      processSheetForConditionalGeoTranslations(nextMonthSheet, geoLanguageMap, CHANNELS_ALLOWING_MANUAL_INPUT, GEO_LIST_DELIMITER);
    } else {
      Logger.log(`‚ÑπÔ∏è –õ–∏—Å—Ç '${nextMonthName}' –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ñ–∞–π–ª–µ '${spreadsheet.getName()}'. –ü—Ä–æ–ø—É—Å–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏.`);
    }

    Logger.log("‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ '–ì–ï–û –ø–µ—Ä–µ–≤–æ–¥—ã' –∑–∞–≤–µ—Ä—à–µ–Ω–æ.");

  } catch (e) {
    Logger.log(`‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ–±—â–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ autoFillGeoTranslations: ${e.message}`);
  }
}

/**
 * –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å—Ç—Ä–æ–∫ –Ω–∞ –æ–¥–Ω–æ–º –ª–∏—Å—Ç–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–∞–¥–∞–Ω–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π.
 * @param {GoogleAppsScript.Spreadsheet.Sheet} sheet –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º—ã–π –ª–∏—Å—Ç.
 * @param {Map<string, string[]>} geoLanguageMap –ö–∞—Ä—Ç–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π –ì–ï–û –∏ —è–∑—ã–∫–æ–≤.
 * @param {Set<string>} channelsAllowingManualInput –ù–∞–±–æ—Ä –∫–∞–Ω–∞–ª–æ–≤, —Ä–∞–∑—Ä–µ—à–∞—é—â–∏—Ö —Ä—É—á–Ω–æ–π –≤–≤–æ–¥.
 * @param {string} geoListDelimiter –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –¥–ª—è —Å–ø–∏—Å–∫–∞ –ì–ï–û.
 */
function processSheetForConditionalGeoTranslations(sheet, geoLanguageMap, channelsAllowingManualInput, geoListDelimiter) {
  // –ó–∞—â–∏—Ç–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –æ–±—ä–µ–∫—Ç –ª–∏—Å—Ç–∞ –ø–æ –∫–∞–∫–æ–π-—Ç–æ –ø—Ä–∏—á–∏–Ω–µ –Ω–µ –±—ã–ª –ø–µ—Ä–µ–¥–∞–Ω.
  if (!sheet) {
    Logger.log(`‚ùå –û–®–ò–ë–ö–ê: –í —Ñ—É–Ω–∫—Ü–∏—é processSheetForConditionalGeoTranslations –ø–µ—Ä–µ–¥–∞–Ω –ø—É—Å—Ç–æ–π –æ–±—ä–µ–∫—Ç –ª–∏—Å—Ç–∞. –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å.`);
    return;
  }

  Logger.log(`‚öôÔ∏è –û–±—Ä–∞–±–æ—Ç–∫–∞ –ª–∏—Å—Ç–∞: '${sheet.getName()}' –¥–ª—è —É—Å–ª–æ–≤–Ω–æ–≥–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è "–ì–ï–û –ø–µ—Ä–µ–≤–æ–¥—ã"...`);

  const lastRow = sheet.getLastRow();
  if (lastRow <= 1) { // –ï—Å–ª–∏ –Ω–∞ –ª–∏—Å—Ç–µ —Ç–æ–ª—å–∫–æ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∏–ª–∏ –æ–Ω –ø—É—Å—Ç
    Logger.log(`‚ÑπÔ∏è –õ–∏—Å—Ç '${sheet.getName()}' –ø—É—Å—Ç –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ –∑–∞–≥–æ–ª–æ–≤–∫–∏. –ü—Ä–æ–ø—É—Å–∫.`);
    return;
  }

  // –ü–æ–ª—É—á–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤ –∫–æ–ª–æ–Ω–æ–∫
  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];

  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–Ω–¥–µ–∫—Å—ã –Ω—É–∂–Ω—ã—Ö –∫–æ–ª–æ–Ω–æ–∫ –ø–æ –∏—Ö –∑–∞–≥–æ–ª–æ–≤–∫–∞–º
  const statusColIndex = headers.indexOf("–°—Ç–∞—Ç—É—Å —Ä–∞—Å—Å—ã–ª–∫–∏");
  const geoColIndex = headers.indexOf("–ì–ï–û");
  const channelColIndex = headers.indexOf("–ö–∞–Ω–∞–ª");
  const translationsColIndex = headers.indexOf("–ì–ï–û –ø–µ—Ä–µ–≤–æ–¥—ã");

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –≤—Å–µ—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –∫–æ–ª–æ–Ω–æ–∫
  if (statusColIndex === -1) { Logger.log(`‚ùå –û—à–∏–±–∫–∞ –≤ –ª–∏—Å—Ç–µ '${sheet.getName()}': –ö–æ–ª–æ–Ω–∫–∞ '–°—Ç–∞—Ç—É—Å —Ä–∞—Å—Å—ã–ª–∫–∏' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.`); return; }
  if (geoColIndex === -1) { Logger.log(`‚ùå –û—à–∏–±–∫–∞ –≤ –ª–∏—Å—Ç–µ '${sheet.getName()}': –ö–æ–ª–æ–Ω–∫–∞ '–ì–ï–û' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.`); return; }
  if (channelColIndex === -1) { Logger.log(`‚ùå –û—à–∏–±–∫–∞ –≤ –ª–∏—Å—Ç–µ '${sheet.getName()}': –ö–æ–ª–æ–Ω–∫–∞ '–ö–∞–Ω–∞–ª' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.`); return; }
  if (translationsColIndex === -1) { Logger.log(`‚ùå –û—à–∏–±–∫–∞ –≤ –ª–∏—Å—Ç–µ '${sheet.getName()}': –ö–æ–ª–æ–Ω–∫–∞ '–ì–ï–û –ø–µ—Ä–µ–≤–æ–¥—ã' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.`); return; }

  // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —Å –ª–∏—Å—Ç–∞ (–Ω–∞—á–∏–Ω–∞—è —Å–æ –≤—Ç–æ—Ä–æ–π —Å—Ç—Ä–æ–∫–∏) –æ–¥–Ω–∏–º –∑–∞–ø—Ä–æ—Å–æ–º –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
  const dataRange = sheet.getRange(2, 1, lastRow - 1, headers.length);
  const values = dataRange.getValues();

  const translationsToUpdate = [];
  let updatesCount = 0;

  values.forEach((row, rowIndexInValues) => {
    const rowNumber = rowIndexInValues + 2; // –†–µ–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä —Å—Ç—Ä–æ–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å–æ 2)
    const status = row[statusColIndex]?.toString().trim(); // –ó–Ω–∞—á–µ–Ω–∏–µ –∏–∑ "–°—Ç–∞—Ç—É—Å —Ä–∞—Å—Å—ã–ª–∫–∏"
    const channel = row[channelColIndex]?.toString().trim(); // –ó–Ω–∞—á–µ–Ω–∏–µ –∏–∑ "–ö–∞–Ω–∞–ª"
    const geoCellContent = row[geoColIndex]; // –ó–Ω–∞—á–µ–Ω–∏–µ –∏–∑ "–ì–ï–û"
    const currentTranslations = row[translationsColIndex]?.toString().trim(); // –¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ "–ì–ï–û –ø–µ—Ä–µ–≤–æ–¥—ã"

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ª–æ–≤–∏–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
    const isStatusEligible = (status === "–í –æ–∂–∏–¥–∞–Ω–∏–∏" || status === "–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∞"); // –°—Ç–∞—Ç—É—Å = "–í –æ–∂–∏–¥–∞–Ω–∏–∏" –∏–ª–∏ "–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∞"
    const isChannelEligible = !channelsAllowingManualInput.has(channel); // –ö–∞–Ω–∞–ª != "SMS", "Whatsapp"
    const isTranslationsEmpty = !currentTranslations; // –ö–æ–ª–æ–Ω–∫–∞ "–ì–ï–û –ø–µ—Ä–µ–≤–æ–¥—ã" –ø—É—Å—Ç–∞

    // –ï—Å–ª–∏ –≤—Å–µ —É—Å–ª–æ–≤–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã, —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∏ –¥–æ–±–∞–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    if (isStatusEligible && isChannelEligible && isTranslationsEmpty) {
      let resultingLanguages = new Set(); // –ò—Å–ø–æ–ª—å–∑—É–µ–º Set –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —è–∑—ã–∫–æ–≤

      if (geoCellContent) {
        // –†–∞–∑–¥–µ–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–æ–ª–æ–Ω–∫–∏ "–ì–ï–û" –ø–æ –∑–∞–ø—è—Ç–æ–π –∏ –æ—á–∏—â–∞–µ–º –æ—Ç –ø—Ä–æ–±–µ–ª–æ–≤
        const individualGeos = geoCellContent.toString().split(geoListDelimiter)
          .map(g => g.trim())
          .filter(g => g !== ''); // –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤—ã–≤–∞–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –ø–æ—Å–ª–µ trim

        individualGeos.forEach(geo => {
          const languagesForGeo = geoLanguageMap.get(geo); // –ü–æ–ª—É—á–∞–µ–º —è–∑—ã–∫–∏ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ì–ï–û –∏–∑ –∫–∞—Ä—Ç—ã –º–∞–ø–ø–∏–Ω–≥–∞
          if (languagesForGeo) {
            languagesForGeo.forEach(lang => resultingLanguages.add(lang)); // –î–æ–±–∞–≤–ª—è–µ–º —è–∑—ã–∫–∏ –≤ Set
          } else {
            Logger.log(`‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –≤ –ª–∏—Å—Ç–µ '${sheet.getName()}', —Å—Ç—Ä–æ–∫–∞ ${rowNumber}: –î–ª—è –ì–ï–û '${geo}' –Ω–µ –Ω–∞–π–¥–µ–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π —è–∑—ã–∫–æ–≤ –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ –º–∞–ø–ø–∏–Ω–≥–∞.`);
          }
        });
      }
      // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º Set —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —è–∑—ã–∫–æ–≤ –≤ –º–∞—Å—Å–∏–≤, —Å–æ—Ä—Ç–∏—Ä—É–µ–º –∏ –æ–±—ä–µ–¥–∏–Ω—è–µ–º –≤ —Å—Ç—Ä–æ–∫—É —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é
      const finalLanguageString = Array.from(resultingLanguages).sort().join(', ');
      translationsToUpdate.push([finalLanguageString]); // –î–æ–±–∞–≤–ª—è–µ–º —Ä–∞—Å—Å—á–∏—Ç–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
      updatesCount++; // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
      Logger.log(`‚úÖ –°—Ç—Ä–æ–∫–∞ ${rowNumber} –Ω–∞ –ª–∏—Å—Ç–µ '${sheet.getName()}' –æ–±–Ω–æ–≤–ª–µ–Ω–∞: "–ì–ï–û –ø–µ—Ä–µ–≤–æ–¥—ã" —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ '${finalLanguageString}'`);
    } else {
      // –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –≤—Å–µ–º —É—Å–ª–æ–≤–∏—è–º, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ,
      // —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ç—Ä–æ–∫ –ø—Ä–∏ –º–∞—Å—Å–æ–≤–æ–º setValues.
      translationsToUpdate.push([currentTranslations]);
    }
  });

  // –ú–∞—Å—Å–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–ª–æ–Ω–∫–∏ "–ì–ï–û –ø–µ—Ä–µ–≤–æ–¥—ã" –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
  if (updatesCount > 0) {
    sheet.getRange(2, translationsColIndex + 1, translationsToUpdate.length, 1).setValues(translationsToUpdate);
    Logger.log(`‚úÖ –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ "–ì–ï–û –ø–µ—Ä–µ–≤–æ–¥—ã" –¥–ª—è –ª–∏—Å—Ç–∞ '${sheet.getName()}' –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –û–±–Ω–æ–≤–ª–µ–Ω–æ —Å—Ç—Ä–æ–∫: ${updatesCount}.`);
  } else {
    Logger.log(`‚ÑπÔ∏è –ù–∞ –ª–∏—Å—Ç–µ '${sheet.getName()}' –Ω–µ –Ω–∞–π–¥–µ–Ω–æ —Å—Ç—Ä–æ–∫, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö —É—Å–ª–æ–≤–∏—è–º –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è.`);
  }
}

/**
 * –ß–∏—Ç–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—É —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π –ì–ï–û –∏ —è–∑—ã–∫–æ–≤ —Å —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –ª–∏—Å—Ç–∞ –≤ –¥—Ä—É–≥–æ–º —Ñ–∞–π–ª–µ.
 * @param {string} mapFileId ID —Ñ–∞–π–ª–∞ Google –¢–∞–±–ª–∏—Ü—ã, —Å–æ–¥–µ—Ä–∂–∞—â–µ–≥–æ –∫–∞—Ä—Ç—É –º–∞–ø–ø–∏–Ω–≥–∞.
 * @param {string} mapSheetName –ò–º—è –ª–∏—Å—Ç–∞ –≤ —Ñ–∞–π–ª–µ –º–∞–ø–ø–∏–Ω–≥–∞.
 * @returns {{geoLanguageMap: Map<string, string[]>, allUniqueGeos: string[], allUniqueLanguages: string[]}} –û–±—ä–µ–∫—Ç, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π –∫–∞—Ä—Ç—É –º–∞–ø–ø–∏–Ω–≥–∞ –ì–ï–û-–Ø–∑—ã–∫–æ–≤, –∞ —Ç–∞–∫–∂–µ —Å–ø–∏—Å–∫–∏ –≤—Å–µ—Ö —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ì–ï–û –∏ —è–∑—ã–∫–æ–≤.
 * @throws {Error} –ï—Å–ª–∏ —Ñ–∞–π–ª –∏–ª–∏ –ª–∏—Å—Ç –º–∞–ø–ø–∏–Ω–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –∏–ª–∏ –æ–Ω–∏ –ø—É—Å—Ç—ã.
 */
function getGeoLanguageMap(mapFileId, mapSheetName) {
  let mapSpreadsheet;
  try {
    mapSpreadsheet = SpreadsheetApp.openById(mapFileId);
  } catch (e) {
    throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª –º–∞–ø–ø–∏–Ω–≥–∞ —Å ID '${mapFileId}'. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ ID –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω –∏ —É —Å–∫—Ä–∏–ø—Ç–∞ –µ—Å—Ç—å –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞. –û—à–∏–±–∫–∞: ${e.message}`);
  }

  const mapSheet = mapSpreadsheet.getSheetByName(mapSheetName);
  if (!mapSheet) {
    throw new Error(`–õ–∏—Å—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π –ì–ï–û –∏ —è–∑—ã–∫–æ–≤ ('${mapSheetName}') –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ñ–∞–π–ª–µ '${mapSpreadsheet.getName()}'. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–º—è –ª–∏—Å—Ç–∞.`);
  }

  const lastRow = mapSheet.getLastRow();
  if (lastRow <= 1) {
    throw new Error(`–õ–∏—Å—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π –ì–ï–û –∏ —è–∑—ã–∫–æ–≤ ('${mapSheetName}') –ø—É—Å—Ç –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ –∑–∞–≥–æ–ª–æ–≤–∫–∏.`);
  }

  // –ß–∏—Ç–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø–µ—Ä–≤—ã—Ö –¥–≤—É—Ö –∫–æ–ª–æ–Ω–æ–∫ (–ì–ï–û –∏ –Ø–∑—ã–∫–∏) —Å–æ 2-–π —Å—Ç—Ä–æ–∫–∏
  const mapData = mapSheet.getRange(2, 1, lastRow - 1, 2).getValues();

  const geoLangMap = new Map();
  const uniqueGeos = new Set();
  const uniqueLanguages = new Set();

  mapData.forEach(row => {
    const geo = row[0]?.toString().trim();
    const languagesString = row[1]?.toString().trim();

    if (geo) {
      uniqueGeos.add(geo);
    }

    if (languagesString) {
      const languages = languagesString.split(',').map(lang => lang.trim()).filter(lang => lang !== '');
      languages.forEach(lang => uniqueLanguages.add(lang));
    }

    if (geo && languagesString) {
      const languages = languagesString.split(',').map(lang => lang.trim()).filter(lang => lang !== '');
      if (languages.length > 0) {
        geoLangMap.set(geo, languages);
      }
    }
  });

  Logger.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–∞ –∫–∞—Ä—Ç–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–π –ì–ï–û-–Ø–∑—ã–∫–∏. –ó–∞–ø–∏—Å–µ–π: ${geoLangMap.size}`);
  Logger.log(`‚úÖ –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ì–ï–û: ${uniqueGeos.size}, —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —è–∑—ã–∫–æ–≤: ${uniqueLanguages.size}`);

  return {
    geoLanguageMap: geoLangMap,
    allUniqueGeos: Array.from(uniqueGeos).sort(),
    allUniqueLanguages: Array.from(uniqueLanguages).sort()
  };
}
