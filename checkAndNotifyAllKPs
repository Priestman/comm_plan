const MASTER_SPREADSHEET_ID = "1JHFCWOj4A82dSNeLHb68B5JHHPxfvHHxg8_e4tjjQtY";


function checkAndNotifyAllKPs() {
  const masterSpreadsheet = SpreadsheetApp.openById(MASTER_SPREADSHEET_ID);
  const masterSheet = masterSpreadsheet.getActiveSheet();
  const masterData = masterSheet.getDataRange().getValues();

  // –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –ª–∏—Å—Ç–∞ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "October_2025")
  const today = new Date();
  const currentMonthName = Utilities.formatDate(today, SpreadsheetApp.getActiveSpreadsheet().getSpreadsheetTimeZone(), "MMMM");
  const currentYear = today.getFullYear();
  const currentSheetName = `${currentMonthName}_${currentYear}`;

  // –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –ª–∏—Å—Ç–∞ –¥–ª—è –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞
  const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
  const lastMonthName = Utilities.formatDate(lastMonth, SpreadsheetApp.getActiveSpreadsheet().getSpreadsheetTimeZone(), "MMMM");
  const lastYear = lastMonth.getFullYear();
  const lastSheetName = `${lastMonthName}_${lastYear}`;

  const targetSheetNames = [currentSheetName, lastSheetName];

  Logger.log(`‚úÖ –ù–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É. –¶–µ–ª–µ–≤—ã–µ –ª–∏—Å—Ç—ã: ${targetSheetNames.join(', ')}`);

  // –ù–∞—á–∏–Ω–∞–µ–º —Å 1, —á—Ç–æ–±—ã –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫
  for (let i = 1; i < masterData.length; i++) {
    const row = masterData[i];
    const kpName = row[0]; // –°—Ç–æ–ª–±–µ—Ü A (name)
    const spreadsheetId = row[2]; // –°—Ç–æ–ª–±–µ—Ü C (id_clean)
    const activeStatus = row[4]; // –°—Ç–æ–ª–±–µ—Ü E (active)

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ö–ü –∞–∫—Ç–∏–≤–µ–Ω
    if (activeStatus && activeStatus.toUpperCase() === 'YES') {
      Logger.log(`‚û°Ô∏è –û–±—Ä–∞–±–æ—Ç–∫–∞ –ö–ü: ${kpName}`);
      try {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–∞ –ª–∏—Å—Ç–∞ (—Ç–µ–∫—É—â–∏–π –∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–π –º–µ—Å—è—Ü)
        for (const sheetName of targetSheetNames) {
          processSingleKP(spreadsheetId, kpName, sheetName);
        }
      } catch (e) {
        Logger.log(`‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ç–∞–±–ª–∏—Ü–µ ${kpName} (ID: ${spreadsheetId}): ${e.toString()}`);
      }
    } else {
      Logger.log(`‚û°Ô∏è –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ö–ü "${kpName}", —Ç–∞–∫ –∫–∞–∫ –æ–Ω –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω.`);
    }
  }
}

function processSingleKP(spreadsheetId, kpName, sheetName) {
  const kpSpreadsheet = SpreadsheetApp.openById(spreadsheetId);
  const kpSheet = kpSpreadsheet.getSheetByName(sheetName);

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ª–∏—Å—Ç —Å –Ω—É–∂–Ω—ã–º –∏–º–µ–Ω–µ–º
  if (!kpSheet) {
    Logger.log(`‚ö†Ô∏è –í —Ç–∞–±–ª–∏—Ü–µ "${kpName}" –Ω–µ –Ω–∞–π–¥–µ–Ω –ª–∏—Å—Ç "${sheetName}". –ü—Ä–æ–ø—É—Å–∫–∞–µ–º.`);
    return;
  }
  
  const kpValues = kpSheet.getDataRange().getValues();
  if (kpValues.length <= 1) {
    Logger.log(`‚ö†Ô∏è –õ–∏—Å—Ç "${sheetName}" –≤ —Ç–∞–±–ª–∏—Ü–µ "${kpName}" –ø—É—Å—Ç. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º.`);
    return;
  }

  let errorRows = [];
  const communicationIdCol = 0; // –°—Ç–æ–ª–±–µ—Ü A (–∏–Ω–¥–µ–∫—Å 0)
  const dateCol = 1; // –°—Ç–æ–ª–±–µ—Ü B (–∏–Ω–¥–µ–∫—Å 1)
  const timeCol = 4; // –°—Ç–æ–ª–±–µ—Ü E (–∏–Ω–¥–µ–∫—Å 4)

  // –ù–∞—á–∏–Ω–∞–µ–º —Å 1, —á—Ç–æ–±—ã –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫
  for (let i = 1; i < kpValues.length; i++) {
    const row = kpValues[i];
    const communicationId = row[communicationIdCol];
    const date = row[dateCol];
    const time = row[timeCol];

    if (communicationId && (!date || !time)) {
      errorRows.push(i + 1); // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–º–µ—Ä —Å—Ç—Ä–æ–∫–∏ (–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 1)
    }
  }
  
  if (errorRows.length > 0) {
    const subject = `–ù–µ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –≤ –ö–ü "${kpName}" (–ª–∏—Å—Ç ${sheetName})`;
    const body = `–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –æ—à–∏–±–∫–∏ –≤ —Å–ª–µ–¥—É—é—â–∏—Ö —Å—Ç—Ä–æ–∫–∞—Ö –≤ —Ç–∞–±–ª–∏—Ü–µ "${kpName}" –Ω–∞ –ª–∏—Å—Ç–µ "${sheetName}":\n
${errorRows.map(rowNum => `–°—Ç—Ä–æ–∫–∞ ${rowNum}`).join('\n')}

–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤ —Å—Ç–æ–ª–±—Ü–∞—Ö "–î–∞—Ç–∞" –∏ "–í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ –ú–°–ö".`;

    sendErrorNotification(subject, body, kpName, sheetName);
  } else {
    Logger.log(`‚úÖ –û—à–∏–±–æ–∫ –Ω–∞ –ª–∏—Å—Ç–µ "${sheetName}" –ö–ü "${kpName}" –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.`);
  }
}

function sendErrorNotification(subject, body, kpName, sheetName) {
  try {
    const recipients = "rostislav.shevchenko@1win.pro,alisa.rumyantseva@1win.pro"; 
    const fullSubject = `[–ö–ü Clean] ${subject}`;
    const fullBody = `–Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã—Ö (–î–∞—Ç–∞,–≤—Ä–µ–º—è) –≤ —á–∏—Å—Ç–æ–≤–æ–º –ö–ü:

${body}

–í—Ä–µ–º—è: ${new Date()}
–§—É–Ω–∫—Ü–∏—è: checkAndNotifyAllKPs()

–¢—Ä–µ–±—É–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º—ã.`;

    MailApp.sendEmail(recipients, fullSubject, fullBody);
    Logger.log(`üìß –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ: ${fullSubject}`);
  } catch (emailError) {
    Logger.log(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: ${emailError}`);
  }
}
