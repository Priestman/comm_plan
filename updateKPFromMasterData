function updateKPFromMasterData() {
  const MASTER_FILE_ID = '13mafABoV2ZRW8wazEMzcR8bTTWJ-5K7cYdwZruyUl5Y';
  const MASTER_SHEET_NAME = 'Report (Short)';

  const KP_FILE_IDS = [
    '1WfslprOxh0UTQhkr1qjTRIEeTG56moyAlAK3NAnffrg',
    '1yOC7lFlwFfXgthb5irjjoJt9tMY8bS7L4FE9Tn3-ESI',
    '1J1pHccWNU9Sq3r7AY4DpermWjEwsYljBYSnD5Zcf2i0',
    '1r07f6FGlwHjjaqiv1Ie5_C-Twh0e-LDFD9GHVjalm7k',
    '1qqQmC2MwZ-jF7imqUoZ4aoPzlE1HnpJQmjU3s7qqG6s',
    '1yKu2nuKGw5g9dsEKEhkxvWOEyAtWw1ExPM0O3xbY-bY',
    '10HDQmTTd_WzCAgss6Yw3qvo3ZLzyY--OXI_mQkYqx8Y',
    '1GYHa8LghjtRzhtYUpATYA2syCbQ8N5aNAq_dqzOcHyg',
    '1onT8LJwo2z1gpkCYvA64rrzBf2T6iAjkQB-O4AH6de8',
    '1WTBO6EXGYRg9twP2dD7_6ZRNYkER-fBsIBm3Wt_it0M'
  ];

  Logger.log("üöÄ –ó–∞–ø—É—Å–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ö–ü –∏–∑ –º–∞—Å—Ç–µ—Ä-—Ñ–∞–π–ª–∞.");

  const masterDataCache = loadMasterDataCache(MASTER_FILE_ID, MASTER_SHEET_NAME);

  if (Object.keys(masterDataCache).length === 0) {
    Logger.log("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –º–∞—Å—Ç–µ—Ä-—Ñ–∞–π–ª–∞ –∏–ª–∏ –∫—ç—à –ø—É—Å—Ç. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã.");
    return;
  }
  Logger.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${Object.keys(masterDataCache).length} –∑–∞–ø–∏—Å–µ–π Trid –∏–∑ –º–∞—Å—Ç–µ—Ä-—Ñ–∞–π–ª–∞.`);

  for (const kpFileId of KP_FILE_IDS) {
    processKPFile(kpFileId, masterDataCache);
  }

  Logger.log("üéâ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ö–ü –∑–∞–≤–µ—Ä—à–µ–Ω–æ.");
}

function loadMasterDataCache(fileId, sheetName) {
  const cache = {};
  try {
    const spreadsheet = SpreadsheetApp.openById(fileId);
    const sheet = spreadsheet.getSheetByName(sheetName);
    if (!sheet) return cache;

    const values = sheet.getDataRange().getValues();
    if (values.length < 2) return cache;

    const headers = values[0];
    const getColIndex = (headerName) => headers.indexOf(headerName);

    const colTrid = getColIndex('Trid');
    const colActualCalls = getColIndex('Actual Calls');
    const colLinks = getColIndex('Links');
    const colVisits = getColIndex('Visits');
    const colExpenses = getColIndex('Expenses');
    const colCostPerInterested = getColIndex('Cost per Interested');
    const colCostPerClick = getColIndex('Cost per Click');

    if ([colTrid, colActualCalls, colLinks, colVisits, colExpenses, colCostPerInterested, colCostPerClick].some(idx => idx === -1)) {
      Logger.log(`‚ùå –û—à–∏–±–∫–∞: –ù–µ –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –Ω–∞–π–¥–µ–Ω—ã –≤ –ª–∏—Å—Ç–µ "${sheetName}" –º–∞—Å—Ç–µ—Ä-—Ñ–∞–π–ª–∞.`);
      return cache;
    }

    for (let i = 1; i < values.length; i++) {
      const row = values[i];
      const trid = (row[colTrid] || '').toString().trim();

      if (trid) {
        cache[trid] = {
          actualCalls: normalizeNumber_zvonobot(row[colActualCalls]),
          links: normalizeNumber_zvonobot(row[colLinks]),
          visits: normalizeNumber_zvonobot(row[colVisits]),
          expenses: normalizeNumber_zvonobot(row[colExpenses]),
          costPerInterested: normalizeNumber_zvonobot(row[colCostPerInterested]),
          costPerClick: normalizeNumber_zvonobot(row[colCostPerClick])
        };
      }
    }
  } catch (e) {
    Logger.log(`‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–∞—Å—Ç–µ—Ä-—Ñ–∞–π–ª–∞ (ID: ${fileId}): ${e.message}`);
  }
  return cache;
}

function processKPFile(kpFileId, masterDataCache) {
  try {
    const spreadsheet = SpreadsheetApp.openById(kpFileId);
    Logger.log(`üìÑ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞ –ö–ü: ${spreadsheet.getName()}`);

    const currentDate = new Date();
    const currentMonth = currentDate.getMonth(); // 0-11
    const currentYear = currentDate.getFullYear();

    // –†–∞—Å—á–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞ –∏ –≥–æ–¥–∞
    let previousMonth = currentMonth - 1;
    let previousYear = currentYear;
    if (previousMonth < 0) {
      previousMonth = 11; // –î–µ–∫–∞–±—Ä—å
      previousYear--;
    }

    const sheetsToProcess = spreadsheet.getSheets();

    for (const sheet of sheetsToProcess) {
      const sheetName = sheet.getName();
      const parsed = parseSheetName_Zvonobot_(sheetName);

      // –£—Å–ª–æ–≤–∏–µ 1: –û–±–Ω–æ–≤–ª—è—Ç—å —Ç–æ–ª—å–∫–æ –ø—Ä–æ—à–ª—ã–π –∏ —Ç–µ–∫—É—â–∏–π –º–µ—Å—è—Ü
      if (!parsed ||
          !( (parsed.year === currentYear && parsed.month === currentMonth) ||
             (parsed.year === previousYear && parsed.month === previousMonth) ) )
      {
        Logger.log(`  ‚û°Ô∏è –ü—Ä–æ–ø—É—Å–∫ –ª–∏—Å—Ç–∞ "${sheetName}": –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç–µ–∫—É—â–µ–º—É –∏–ª–∏ –ø—Ä–æ—à–ª–æ–º—É –º–µ—Å—è—Ü—É/–≥–æ–¥—É.`);
        continue;
      }

      Logger.log(`  üîç –û–±—Ä–∞–±–æ—Ç–∫–∞ –ª–∏—Å—Ç–∞: ${sheetName}`);

      const values = sheet.getDataRange().getValues();
      if (values.length < 2) continue;

      const headers = values[0];
      const getColIndex = (headerName) => headers.indexOf(headerName);

      const colTrack = getColIndex('–¢—Ä–µ–∫');
      const colChannel = getColIndex('–ö–∞–Ω–∞–ª');
      const colStatus = getColIndex('–°—Ç–∞—Ç—É—Å —Ä–∞—Å—Å—ã–ª–∫–∏');
      
      const colActualCallsKP = getColIndex('–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
      const colLinksKP = getColIndex('–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ');
      const colVisitsKP = getColIndex('–ü—Ä–æ—á–∏—Ç–∞–Ω–æ');
      const colExpensesKP = getColIndex('–°–ø–µ–Ω–¥');
      const colCostPerInterestedKP = getColIndex('Cost per Interested');
      const colCostPerClickKP = getColIndex('Cost per Click');

      if ([colTrack, colChannel, colStatus, colActualCallsKP, colLinksKP, colVisitsKP, colExpensesKP, colCostPerInterestedKP, colCostPerClickKP].some(idx => idx === -1)) {
        Logger.log(`  ‚ùå –û—à–∏–±–∫–∞: –ù–µ –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –Ω–∞–π–¥–µ–Ω—ã –≤ –ª–∏—Å—Ç–µ "${sheetName}" —Ñ–∞–π–ª–∞ –ö–ü.`);
        continue;
      }

      const updates = [];
      const startRow = 1;

      for (let i = startRow; i < values.length; i++) {
        const row = values[i];
        const trackValue = (row[colTrack] || '').toString().trim();
        const channelValue = (row[colChannel] || '').toString().trim();
        const statusValue = (row[colStatus] || '').toString().trim();

        if (trackValue &&
            channelValue === '–ó–≤–æ–Ω–æ–±–æ—Ç' &&
            statusValue === '–í—ã–ø–æ–ª–Ω–µ–Ω–∞' &&
            masterDataCache.hasOwnProperty(trackValue)) {

          const masterRowData = masterDataCache[trackValue];

          const newActualCalls = masterRowData.actualCalls.toString().replace('.', ',');
          const newLinks = masterRowData.links.toString().replace('.', ',');
          const newVisits = masterRowData.visits.toString().replace('.', ',');
          const newExpenses = masterRowData.expenses.toFixed(3).replace('.', ',');
          const newCostPerInterested = masterRowData.costPerInterested.toFixed(2).replace('.', ',');
          const newCostPerClick = masterRowData.costPerClick.toFixed(2).replace('.', ',');

          // –£—Å–ª–æ–≤–∏–µ 2: –ù–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—Ç—å, –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏—è —Å–æ–≤–ø–∞–¥–∞—é—Ç
          let shouldUpdate = false;
          if (row[colActualCallsKP] != newActualCalls) shouldUpdate = true;
          if (row[colLinksKP] != newLinks) shouldUpdate = true;
          if (row[colVisitsKP] != newVisits) shouldUpdate = true;
          if (row[colExpensesKP] != newExpenses) shouldUpdate = true;
          if (row[colCostPerInterestedKP] != newCostPerInterested) shouldUpdate = true;
          if (row[colCostPerClickKP] != newCostPerClick) shouldUpdate = true;

          if (shouldUpdate) {
            updates.push({
              row: i + 1,
              colActualCalls: colActualCallsKP + 1,
              colLinks: colLinksKP + 1,
              colVisits: colVisitsKP + 1,
              colExpenses: colExpensesKP + 1,
              colCostPerInterested: colCostPerInterestedKP + 1,
              colCostPerClick: colCostPerClickKP + 1,
              
              actualCalls: newActualCalls,
              links: newLinks,
              visits: newVisits,
              expenses: newExpenses,
              costPerInterested: newCostPerInterested,
              costPerClick: newCostPerClick
            });
          }
        }
      }

      if (updates.length > 0) {
        Logger.log(`    üìä –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ ${updates.length} —Å—Ç—Ä–æ–∫ –≤ –ª–∏—Å—Ç–µ "${sheet.getName()}"...`);
        const batchUpdates = {};
        for(const update of updates) {
          if (!batchUpdates[update.colActualCalls]) batchUpdates[update.colActualCalls] = [];
          if (!batchUpdates[update.colLinks]) batchUpdates[update.colLinks] = [];
          if (!batchUpdates[update.colVisits]) batchUpdates[update.colVisits] = [];
          if (!batchUpdates[update.colExpenses]) batchUpdates[update.colExpenses] = [];
          if (!batchUpdates[update.colCostPerInterested]) batchUpdates[update.colCostPerInterested] = [];
          if (!batchUpdates[update.colCostPerClick]) batchUpdates[update.colCostPerClick] = [];

          batchUpdates[update.colActualCalls].push({row: update.row, value: update.actualCalls});
          batchUpdates[update.colLinks].push({row: update.row, value: update.links});
          batchUpdates[update.colVisits].push({row: update.row, value: update.visits});
          batchUpdates[update.colExpenses].push({row: update.row, value: update.expenses});
          batchUpdates[update.colCostPerInterested].push({row: update.row, value: update.costPerInterested});
          batchUpdates[update.colCostPerClick].push({row: update.row, value: update.costPerClick});
        }
        
        for (const colIndexStr in batchUpdates) {
          const colIndex = parseInt(colIndexStr);
          const updatesForCol = batchUpdates[colIndexStr].sort((a,b) => a.row - b.row);
          
          let currentBlockStartRow = updatesForCol[0].row;
          let currentBlockValues = [[updatesForCol[0].value]];

          for (let k = 1; k < updatesForCol.length; k++) {
              if (updatesForCol[k].row === currentBlockStartRow + currentBlockValues.length) {
                  currentBlockValues.push([updatesForCol[k].value]);
              } else {
                  sheet.getRange(currentBlockStartRow, colIndex, currentBlockValues.length, 1).setValues(currentBlockValues);
                  currentBlockStartRow = updatesForCol[k].row;
                  currentBlockValues = [[updatesForCol[k].value]];
              }
          }
          sheet.getRange(currentBlockStartRow, colIndex, currentBlockValues.length, 1).setValues(currentBlockValues);
        }
        
        Logger.log(`    ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ ${updates.length} —Å—Ç—Ä–æ–∫ –≤ –ª–∏—Å—Ç–µ "${sheet.getName()}".`);
      } else {
        Logger.log(`    ‚ÑπÔ∏è –ù–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö —Å—Ç—Ä–æ–∫ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ –ª–∏—Å—Ç–µ "${sheet.getName()}".`);
      }
    }
  } catch (e) {
    Logger.log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–∞ –ö–ü (ID: ${kpFileId}): ${e.message}`);
  }
}

function normalizeNumber_zvonobot(value) {
  if (typeof value === 'number') return value;
  if (typeof value === 'string') {
    const cleanedValue = value.replace(/\$/g, '').replace(/\s/g, '').replace(',', '.');
    const num = parseFloat(cleanedValue);
    return isNaN(num) ? 0 : num;
  }
  return 0;
}

function parseSheetName_Zvonobot_(sheetName) {
  const match = sheetName.match(/^(January|February|March|April|May|June|July|August|September|October|November|December)_(\d{4})$/);
  if (!match) return null;
  const months = {
    "January": 0, "February": 1, "March": 2, "April": 3, "May": 4,
    "June": 5, "July": 6, "August": 7, "September": 8,
    "October": 9, "November": 10, "December": 11
  };
  return { month: months[match[1]], year: parseInt(match[2]) };
}
