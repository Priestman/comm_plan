// ====================================================================
//                           –ö–û–ù–°–¢–ê–ù–¢–´
// ====================================================================

// 1. –°—Å—ã–ª–∫–∞ –Ω–∞ –û–ë–©–ò–ô –∫–∞–Ω–∞–ª (–∫—É–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ 11:00)
const GENERAL_SLACK_WEBHOOK_URL = "–∞–∞–∞–∞–∞";

// 2. –°—Å—ã–ª–∫–∞ –¥–ª—è –õ–ò–ß–ù–´–• –°–û–û–ë–©–ï–ù–ò–ô (–∫—É–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ 9:00)
const ADMIN_SLACK_WEBHOOK_URL = "fffff"; 

// –°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –∏ –µ–≥–æ Slack Member ID
const STATS_SLACK_MAP = {
  "–ê–Ω–Ω–∞": "U09AMHMPDFV",
  "–ë–æ–≥–¥–∞–Ω": "U08G21NDPJN",
  "–ú–∞—Ä–∞—Ç": "U09CF7SHHND",
  "–ù–∞—Ç–∞–ª—å—è": "U09A6Q1MH7T",
  "–°–µ–º–µ–Ω": "U095KJFP7L1",
  "–í–ª–∞–¥–∏—Å–ª–∞–≤": "U09CG6HGUMQ"
};

// –û–∂–∏–¥–∞–µ–º—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è —Å—Ç–æ–ª–±—Ü–æ–≤
const STATS_COLUMN_NAMES = {
  DATE: "–î–∞—Ç–∞",
  ROW_CORRECTNESS: "–ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Å—Ç—Ä–æ–∫–∏",
  DISTRIBUTION_STATUS: "–°—Ç–∞—Ç—É—Å —Ä–∞—Å—Å—ã–ª–∫–∏",
  CHANNEL: "–ö–∞–Ω–∞–ª", 
  PROCESS_LABEL: "process_lable",
  SENT: "–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ",
  DELIVERED: "–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ",
  SPEND: "–°–ø–µ–Ω–¥",
  MANAGER: "–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π campaign",
  SENDER: "–°–µ–Ω–¥–µ—Ä" // <--- –ò–°–ü–†–ê–í–õ–ï–ù–û: –∏—â–µ–º —Å—Ç–æ–ª–±–µ—Ü "–°–µ–Ω–¥–µ—Ä"
};

// ====================================================================
//                       –§–£–ù–ö–¶–ò–ò –î–õ–Ø –¢–†–ò–ì–ì–ï–†–û–í
// ====================================================================

// –¢–†–ò–ì–ì–ï–† –ù–ê 9:00 (–õ–∏—á–∫–∞)
function runStatsCheckForAdmin() {
  checkKPStatsMissing(true); 
}

// –¢–†–ò–ì–ì–ï–† –ù–ê 12:00 (–û–±—â–∏–π –∫–∞–Ω–∞–ª)
function runStatsCheckForAll() {
  checkKPStatsMissing(false); 
}

// ====================================================================
//                           –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê
// ====================================================================

function checkKPStatsMissing(isAdminMode = false) {
  const scriptProperties = PropertiesService.getScriptProperties();
  const activeKPs = JSON.parse(scriptProperties.getProperty("active_kps") || "[]");
  const dateRange = getStatsDateRangeForTuesday(); 
  const allErrorsByManager = {}; 

  const timeZone = SpreadsheetApp.getActiveSpreadsheet().getSpreadsheetTimeZone();
  const startSheetName = Utilities.formatDate(dateRange.start, timeZone, "MMMM_yyyy");
  const endSheetName = Utilities.formatDate(dateRange.end, timeZone, "MMMM_yyyy");
  
  const KPS_TO_SKIP = ["MASS", "EXTERNAL", "CC"];

  Logger.log(`‚úÖ –ù–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É. –†–µ–∂–∏–º: ${isAdminMode ? "–õ–ò–ß–ù–´–ô –û–¢–ß–ï–¢ (9:00)" : "–û–ë–©–ò–ô –ö–ê–ù–ê–õ (11:00)"}`);

  const sheetsToCheck = [startSheetName];
  if (startSheetName !== endSheetName) sheetsToCheck.push(endSheetName);

  for (const kp of activeKPs) {
    const kpName = kp.name;         
    const spreadsheetId = kp.id_work; 
    const normalizedKpName = kpName.trim().toUpperCase();
    
    if (KPS_TO_SKIP.includes(normalizedKpName)) continue;
    if (!spreadsheetId) continue;

    try {
      for (const sheetName of sheetsToCheck) {
        findStatsData(spreadsheetId, kpName, dateRange, allErrorsByManager, sheetName); 
      }
    } catch (e) {
      Logger.log(`‚ùå –û—à–∏–±–∫–∞ —Ç–∞–±–ª–∏—Ü—ã ${kpName}: ${e.toString()}`);
    }
  }
  
  sendStatsSlackAlerts(allErrorsByManager, dateRange, isAdminMode); 
}

// --- –§—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ –¥–∞–Ω–Ω—ã—Ö ---
function findStatsData(spreadsheetId, kpName, dateRange, allErrorsByManager, sheetName) {
  const kpSpreadsheet = SpreadsheetApp.openById(spreadsheetId);
  const sheet = kpSpreadsheet.getSheetByName(sheetName); 
  if (!sheet) return;
  
  const kpNameUpper = kpName.trim().toUpperCase();
  const sheetGid = sheet.getSheetId(); 
  const data = sheet.getDataRange().getValues();
  if (data.length < 2) return;
  
  const headers = data[0];
  const colIndexes = getStatsColumnIndexes(headers, STATS_COLUMN_NAMES); 
  const requiredCols = Object.keys(STATS_COLUMN_NAMES);
  
  let missingCols = requiredCols.filter(key => colIndexes[key] === undefined);
  if (kpNameUpper.includes("VIP")) missingCols = missingCols.filter(key => key !== 'MANAGER');
  
  // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –∫–∞–∫—É—é-—Ç–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—É—é –∫–æ–ª–æ–Ω–∫—É (–≤–∫–ª—é—á–∞—è –°–µ–Ω–¥–µ—Ä), –≤—ã—Ö–æ–¥–∏–º
  // –ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ, —á—Ç–æ–±—ã —Å–∫—Ä–∏–ø—Ç —Ä–∞–±–æ—Ç–∞–ª –¥–∞–∂–µ –±–µ–∑ –∫–æ–ª–æ–Ω–∫–∏ "–°–µ–Ω–¥–µ—Ä", —É–¥–∞–ª–∏—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∏–∂–µ –∏–ª–∏ —É–±–µ—Ä–∏—Ç–µ SENDER –∏–∑ requiredCols
  // –°–µ–π—á–∞—Å: –µ—Å–ª–∏ –∫–æ–ª–æ–Ω–∫–∏ "–°–µ–Ω–¥–µ—Ä" –Ω–µ—Ç -> —Å–∫—Ä–∏–ø—Ç –ø—Ä–æ–ø—É—Å—Ç–∏—Ç –ª–∏—Å—Ç.
  if (missingCols.length > 0) return;
  
  const sheetUrl = kpSpreadsheet.getUrl();
  const isEmpty = (val) => (val === '' || val === null || val === undefined);
  const isZero = (val) => (typeof val === 'number' && val === 0);
  
  for (let i = 1; i < data.length; i++) {
    const row = data[i];
    const dateValue = row[colIndexes.DATE];
    const managerName = (colIndexes.MANAGER !== undefined && row[colIndexes.MANAGER]) ? row[colIndexes.MANAGER].toString().trim() : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä';
    
    // –°—á–∏—Ç—ã–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ –∫–æ–ª–æ–Ω–∫–∏ "–°–µ–Ω–¥–µ—Ä"
    const senderValue = (colIndexes.SENDER !== undefined && row[colIndexes.SENDER]) ? row[colIndexes.SENDER].toString().trim() : '';

    // –ü—Ä–æ–≤–µ—Ä–∫–∏ –¥–∞—Ç—ã
    const rowDate = dateValue instanceof Date ? dateValue : null;
    if (!rowDate || rowDate < dateRange.start || rowDate > dateRange.end) continue;

    const correctness = row[colIndexes.ROW_CORRECTNESS] ? row[colIndexes.ROW_CORRECTNESS].toString().trim() : '';
    const status = row[colIndexes.DISTRIBUTION_STATUS] ? row[colIndexes.DISTRIBUTION_STATUS].toString().trim() : '';
    const channel = row[colIndexes.CHANNEL] ? row[colIndexes.CHANNEL].toString().trim() : '';
    const processLabel = row[colIndexes.PROCESS_LABEL] ? row[colIndexes.PROCESS_LABEL].toString().trim() : '';

    if (status !== "–í—ã–ø–æ–ª–Ω–µ–Ω–∞" || correctness !== "–ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –≤ –ë–î" || (channel !== "SMS" && channel !== "Whatsapp") || !processLabel) continue;

    const sentValue = row[colIndexes.SENT];
    const deliveredValue = row[colIndexes.DELIVERED];
    const spendValue = row[colIndexes.SPEND];

    let errorType = null;
    const allEmpty = isEmpty(sentValue) && isEmpty(deliveredValue) && isEmpty(spendValue);
    const hasZero = isZero(sentValue) || isZero(deliveredValue) || isZero(spendValue);
    const hasNonEmptyNonZero = (!isEmpty(sentValue) && !isZero(sentValue)) || (!isEmpty(deliveredValue) && !isZero(deliveredValue)) || (!isEmpty(spendValue) && !isZero(spendValue));

    if (allEmpty) errorType = "MISSING";
    else if (hasZero && !hasNonEmptyNonZero) errorType = "ZERO";
    
    if (!errorType) continue;
    
    if (!allErrorsByManager[managerName]) allErrorsByManager[managerName] = [];
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ—à–∏–±–∫—É –≤ –º–∞—Å—Å–∏–≤
    allErrorsByManager[managerName].push({
      kpName: kpName,
      link: `${sheetUrl}#gid=${sheetGid}&range=A${i + 1}`,
      rowNumber: i + 1,
      date: Utilities.formatDate(rowDate, kpSpreadsheet.getSpreadsheetTimeZone(), "dd.MM.yyyy"),
      processLabel: processLabel,
      campaignManager: managerName, 
      sender: senderValue, // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
      errorType: errorType
    });
  }
}

function getStatsColumnIndexes(headers, requiredColumns) {
  const indexes = {};
  const headerMap = {};
  headers.forEach((header, index) => headerMap[header.toString().trim().toLowerCase()] = index);
  for (const key in requiredColumns) indexes[key] = headerMap[requiredColumns[key].trim().toLowerCase()];
  return indexes;
}


/**
 * –§–û–†–ú–ò–†–û–í–ê–ù–ò–ï –ò –û–¢–ü–†–ê–í–ö–ê
 */
function sendStatsSlackAlerts(allErrorsByManager, dateRange, isAdminMode) {
  const allManagersWithErrors = Object.keys(allErrorsByManager).filter(manager => allErrorsByManager[manager].length > 0);
  const timeZone = SpreadsheetApp.getActiveSpreadsheet().getSpreadsheetTimeZone();
  const period = `${Utilities.formatDate(dateRange.start, timeZone, "dd.MM.yyyy")} - ${Utilities.formatDate(dateRange.end, timeZone, "dd.MM.yyyy")}`;
  
  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º URL
  const webhookUrl = isAdminMode ? ADMIN_SLACK_WEBHOOK_URL : GENERAL_SLACK_WEBHOOK_URL;

  // 1. –ï—Å–ª–∏ –æ—à–∏–±–æ–∫ –Ω–µ—Ç
  if (allManagersWithErrors.length === 0) {
    if (isAdminMode) {
        sendStatsSlackMessage(webhookUrl, { text: `üõ°Ô∏è *[–ü–†–û–í–ï–†–ö–ê 9:00]* –í—Å–µ —á–∏—Å—Ç–æ! –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –Ω–µ—Ç.` });
    } else {
        sendStatsSlackMessage(webhookUrl, { text: `:white_check_mark: *–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è–º –∑–∞ –ø–µ—Ä–∏–æ–¥ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ –≤ –ø–æ–ª–Ω–æ–º –æ–±—ä–µ–º–µ* (–ø–µ—Ä–∏–æ–¥: ${period})` });
    }
    return;
  }
  
  // 2. –ï—Å–ª–∏ —Ä–µ–∂–∏–º –ê–¥–º–∏–Ω–∞ ‚Äî —Å–Ω–∞—á–∞–ª–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º "–°–≤–æ–¥–∫—É"
  if (isAdminMode) {
      const summaryText = `üõ°Ô∏è *[–ü–†–ï–î–í–ê–†–ò–¢–ï–õ–¨–ù–´–ô –û–¢–ß–ï–¢]*\n–ü–µ—Ä–∏–æ–¥: ${period}\n–ù–∞–π–¥–µ–Ω—ã –æ—à–∏–±–∫–∏ —É –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ (${allManagersWithErrors.length}): *${allManagersWithErrors.join(', ')}*\n_–ù–∏–∂–µ –¥–µ—Ç–∞–ª—å–Ω–∞—è —Ä–∞–∑–±–∏–≤–∫–∞:_`;
      sendStatsSlackMessage(webhookUrl, { text: summaryText });
  }

  // 3. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–µ—Ç–∞–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
  for (const managerName of allManagersWithErrors) {
    const errors = allErrorsByManager[managerName];
    
    let header = "";
    if (isAdminMode) {
        header = `üë§ *–ú–µ–Ω–µ–¥–∂–µ—Ä: ${managerName}*`;
    } else {
        const slackId = STATS_SLACK_MAP[managerName]; 
        const mention = slackId ? `<@${slackId}>` : `*${managerName}*`;
        header = `${mention} üö® *–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞* –ø–æ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è–º –∑–∞ –ø–µ—Ä–∏–æ–¥ *${period}*.`;
    }

    let messageText = header + "\n\n"; 
    
    const missingErrors = errors.filter(e => e.errorType === 'MISSING');
    const zeroErrors = errors.filter(e => e.errorType === 'ZERO');

    // –ë–ª–æ–∫ —Å –ø—É—Å—Ç—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
    if (missingErrors.length > 0) {
        messageText += `:red_circle: *–ù–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ –æ—Ç–ø—Ä–∞–≤–∫–∞–º (–≤—Å–µ –ø–æ–ª—è –ø—É—Å—Ç—ã–µ):*\n`;
        missingErrors.forEach((err, index) => {
             let errorLine = `${index + 1}. *–ö–ü:* ${err.kpName}, *–î–∞—Ç–∞:* ${err.date}, <${err.link}|–°—Ç—Ä–æ–∫–∞ ${err.rowNumber}>`;
             
             if (err.processLabel) errorLine += `, *PL:* \`${err.processLabel}\``;
             
             // –í–´–í–û–î: –°–µ–Ω–¥–µ—Ä (Resp —É–¥–∞–ª–µ–Ω)
             if (err.sender) errorLine += `, *Sender:* \`${err.sender}\``;
             
             errorLine += `, *–û—à–∏–±–∫–∞:* \`–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ, –î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ, –°–ø–µ–Ω–¥\``;
             messageText += errorLine + '\n';
        });
        messageText += "\n";
    }

    // –ë–ª–æ–∫ —Å –Ω—É–ª—è–º–∏
    if (zeroErrors.length > 0) {
        messageText += `:large_yellow_circle: *–ù—É–ª–µ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –æ—Ç–ø—Ä–∞–≤–∫–∞–º (–µ—Å—Ç—å –Ω—É–ª–∏):*\n`;
        zeroErrors.forEach((err, index) => {
             let errorLine = `${index + 1}. *–ö–ü:* ${err.kpName}, *–î–∞—Ç–∞:* ${err.date}, <${err.link}|–°—Ç—Ä–æ–∫–∞ ${err.rowNumber}>`;
             
             if (err.processLabel) errorLine += `, *PL:* \`${err.processLabel}\``;
             
             // –í–´–í–û–î: –°–µ–Ω–¥–µ—Ä (Resp —É–¥–∞–ª–µ–Ω)
             if (err.sender) errorLine += `, *Sender:* \`${err.sender}\``;
             
             errorLine += `, *–û—à–∏–±–∫–∞:* \`–Ω—É–ª–µ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –æ—Ç–ø—Ä–∞–≤–∫–∞–º\``;
             messageText += errorLine + '\n';
        });
    }

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –º–µ–Ω–µ–¥–∂–µ—Ä—É
    sendStatsSlackMessage(webhookUrl, { text: messageText });
    
    Utilities.sleep(300); 
  }
}

/**
 * –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Slack –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É URL
 */
function sendStatsSlackMessage(webhookUrl, payload) {
  try {
    const options = {
      'method' : 'post',
      'contentType': 'application/json',
      'payload' : JSON.stringify(payload)
    };
    UrlFetchApp.fetch(webhookUrl, options); 
    Logger.log("‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ.");
  } catch (e) {
    Logger.log(`‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ${e.toString()}`);
  }
}

function getStatsDateRangeForTuesday() {
  const today = new Date();
  const timeZone = SpreadsheetApp.getActiveSpreadsheet().getSpreadsheetTimeZone();
  const currentMonth = today.getMonth();
  const dayOfWeek = today.getDay(); 

  const daysSinceLastSunday = dayOfWeek === 0 ? 7 : dayOfWeek;
  const lastSunday = new Date(today);
  lastSunday.setDate(today.getDate() - daysSinceLastSunday);
  const formattedEnd = Utilities.formatDate(lastSunday, timeZone, "yyyy-MM-dd");
  const end = new Date(formattedEnd + "T23:59:59"); 

  let start;
  let daysUntilNextTuesday = (2 + 7 - dayOfWeek) % 7;
  if (daysUntilNextTuesday === 0) daysUntilNextTuesday = 7; 
  const nextTuesday = new Date(today);
  nextTuesday.setDate(today.getDate() + daysUntilNextTuesday);
  
  if (nextTuesday.getMonth() !== currentMonth) {
    const firstDayOfMonth = new Date(today.getFullYear(), currentMonth, 1);
    start = new Date(Utilities.formatDate(firstDayOfMonth, timeZone, "yyyy-MM-dd") + "T00:00:00"); 
  } else {
    const lastMonday = new Date(lastSunday);
    lastMonday.setDate(lastSunday.getDate() - 6);
    if (lastMonday.getMonth() !== currentMonth) {
        const prevMonth = new Date(today.getFullYear(), currentMonth - 1, 1);
        start = new Date(Utilities.formatDate(prevMonth, timeZone, "yyyy-MM-dd") + "T00:00:00"); 
    } else {
        start = new Date(Utilities.formatDate(lastMonday, timeZone, "yyyy-MM-dd") + "T00:00:00"); 
    }
  }
  return { start, end };
}
