function transferCompletedRowsFor(kpName) {
  const kps = JSON.parse(PropertiesService.getScriptProperties().getProperty("active_kps") || "[]");
  const kp = kps.find(k => k.name === kpName);
  if (!kp) return Logger.log(`‚ö† –ö–ü '${kpName}' –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ ScriptProperties.`);

  const sheetName = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), "MMMM_yyyy");
  const cachedIdsRaw = PropertiesService.getScriptProperties().getProperty(`clean_ids_${sheetName}`);
  const cachedIds = new Set(cachedIdsRaw ? JSON.parse(cachedIdsRaw) : []);

  try {
    const workBook = SpreadsheetApp.openById(kp.id_work);
    const cleanBook = SpreadsheetApp.openById(kp.id_clean);

    const workSheet = workBook.getSheetByName(sheetName);
    let cleanSheet = cleanBook.getSheetByName(sheetName);
    if (!workSheet) return Logger.log(`‚ö† –õ–∏—Å—Ç '${sheetName}' –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ —Ä–∞–±–æ—á–µ–º –ö–ü ${kpName}`);
    if (!cleanSheet) cleanSheet = cleanBook.insertSheet(sheetName);

    const workHeaders = workSheet.getRange(1, 1, 1, workSheet.getLastColumn()).getValues()[0];
    const cleanHeaders = cleanSheet.getRange(1, 1, 1, cleanSheet.getLastColumn()).getValues()[0];

    const statusCol = workHeaders.indexOf("–°—Ç–∞—Ç—É—Å —Ä–∞—Å—Å—ã–ª–∫–∏") + 1;
    const correctnessCol = workHeaders.indexOf("–ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Å—Ç—Ä–æ–∫–∏") + 1;
    const idCol = workHeaders.indexOf("communication_id") + 1;
    if (statusCol < 1 || correctnessCol < 1 || idCol < 1) return;

    const lastRow = workSheet.getLastRow();
    if (lastRow < 2) return;

    const data = workSheet.getRange(2, 1, lastRow - 1, workSheet.getLastColumn()).getValues();
    const correctnessValues = workSheet.getRange(2, correctnessCol, lastRow - 1, 1).getValues();

    const toTransfer = [];
    const timestamp = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), "dd.MM.yyyy HH:mm:ss");

    data.forEach((row, i) => {
      const communicationId = row[idCol - 1]?.toString().trim();
      const status = row[statusCol - 1]?.toString().trim();
      const correctness = correctnessValues[i][0]?.toString().trim();

      if (!communicationId || status !== "–í—ã–ø–æ–ª–Ω–µ–Ω–∞") return;

      if (cachedIds.has(communicationId)) {
        if (!correctness || correctness !== "–ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –≤ –ë–î") {
          correctnessValues[i][0] = "–ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –≤ –ë–î";
        }
        return;
      }

      if (correctness && correctness !== "") return;

      const errors = validateRow(row, workHeaders);
      const expectedLink = constructLinkAndTrack(row, workHeaders, workSheet, i + 2);
      const actualLink = row[workHeaders.indexOf("–°—Å—ã–ª–∫–∞ + —Ç—Ä–µ–∫")];
      if (actualLink && expectedLink && actualLink !== expectedLink) {
        errors.push("‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –°—Å—ã–ª–∫–∞ + —Ç—Ä–µ–∫");
      }

      if (errors.length > 0) {
        correctnessValues[i][0] = errors.join("; ");
        return;
      }

      const newRow = cleanHeaders.map(header => {
        const index = workHeaders.indexOf(header);
        if (index > -1) {
          let value = row[index];
          if (header === "–¢—Ä–µ–∫") value = extractTrackId(value);
          if (header === "process_lable") value = filterProcessLable(row, workHeaders);
          return value;
        } else if (header === "moving_date") {
          return timestamp;
        } else {
          return "";
        }
      });

      toTransfer.push(newRow);
      correctnessValues[i][0] = "–ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –≤ –ë–î";
      cachedIds.add(communicationId);
    });

    if (toTransfer.length > 0) {
      cleanSheet.getRange(cleanSheet.getLastRow() + 1, 1, toTransfer.length, cleanHeaders.length).setValues(toTransfer);
      SpreadsheetApp.flush();
      Logger.log(`‚úÖ –ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ —Å—Ç—Ä–æ–∫ –≤ ${kpName}: ${toTransfer.length}`);
    }

    workSheet.getRange(2, correctnessCol, lastRow - 1, 1).setValues(correctnessValues);

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π Set –æ–±—Ä–∞—Ç–Ω–æ
    PropertiesService.getScriptProperties().setProperty(`clean_ids_${sheetName}`, JSON.stringify(Array.from(cachedIds)));

  } catch (error) {
    Logger.log(`‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–Ω–æ—Å–∞ –¥–ª—è –ö–ü '${kpName}': ${error}`);
  }
}


// üéØ –í–∞–ª–∏–¥–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π + —Å–ø–µ—Ü. —É—Å–ª–æ–≤–∏–π
function validateRow(row, headers) {
  const required = [
    "communication_id", "–î–∞—Ç–∞", "–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏", "–°—Ç–∞—Ç—É—Å —Ä–∞—Å—Å—ã–ª–∫–∏", "–í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ –ú–°–ö",
    "–ö–∞–Ω–∞–ª", "–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ", "–¢–µ–º–∞ —Ä–∞—Å—Å—ã–ª–∫–∏", "–ì–ï–û", "–ì—Ä—É–ø–ø–∞ —Å–µ–≥–º–µ–Ω—Ç–æ–≤",
    "–ü–æ–¥—Å–µ–≥–º–µ–Ω—Ç", "–¢–µ—Å—Ç—ã", "–¢—Ä–µ–∫", "–ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ–≥–º–µ–Ω—Ç–∞ –≤ CDP"
  ];

  const errors = [];

  required.forEach(field => {
    const idx = headers.indexOf(field);
    if (idx > -1 && (!row[idx] || row[idx].toString().trim() === "")) {
      errors.push("‚ùå –ü—Ä–æ–ø—É—â–µ–Ω–æ –ø–æ–ª–µ: " + field);
    }
  });

  const chIdx = headers.indexOf("–ö–∞–Ω–∞–ª");
  const nIdx = headers.indexOf("–¢–∏–ø –Ω–æ—Ç–∏—Ñ–∞");
  const pIdx = headers.indexOf("process_lable");

  if (chIdx > -1) {
    const channel = row[chIdx]?.toString().trim();
    const notifType = nIdx > -1 ? row[nIdx]?.toString().trim() : "";
    const label = pIdx > -1 ? row[pIdx]?.toString().trim() : "";

    if (channel === "Notification" && !notifType) errors.push("‚ùå '–¢–∏–ø –Ω–æ—Ç–∏—Ñ–∞' –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω");
    if (channel !== "Notification" && notifType) errors.push("‚ùå '–¢–∏–ø –Ω–æ—Ç–∏—Ñ–∞' –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—É—Å—Ç—ã–º");
    if ((channel === "Whatsapp" || channel === "SMS") && !label) errors.push("‚ùå 'process_lable' –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω");
    if (channel !== "Whatsapp" && channel !== "SMS" && label) errors.push("‚ùå 'process_lable' –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø—É—Å—Ç—ã–º");
  }

  return errors;
}

// üîß –ü–æ–¥–¥–µ—Ä–∂–∫–∞: —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Å—ã–ª–∫–∏
function constructLinkAndTrack(row, headers, sheet, rowIndex) {
  const m = headers.indexOf("–ó–µ—Ä–∫–∞–ª–æ"),
        p = headers.indexOf("–ü—É—Ç—å"),
        t = headers.indexOf("–¢—Ä–µ–∫");

  const mirror = sheet.getRange(rowIndex, m + 1).getFormula() || row[m] || "";
  const path = row[p] || "";
  const track = row[t] || "";

  if (!mirror) return path + track;
  if (!path) return mirror + track;
  return mirror + path + track;
}

// üîß –ü–æ–¥–¥–µ—Ä–∂–∫–∞: –æ–±—Ä–µ–∑–∫–∞ —Ç—Ä–µ–∫–∞ (–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ ID –ø–æ—Å–ª–µ ?trid= –∏–ª–∏ &trid=)
function extractTrackId(track) {
  if (!track) return "";
  const match = track.match(/(?:\?|&)trid=([^&]+)/);
  return match ? match[1] : track;
}

// üîß –ü–æ–¥–¥–µ—Ä–∂–∫–∞: –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–ª—è process_lable
function filterProcessLable(row, headers) {
  const c = headers.indexOf("–ö–∞–Ω–∞–ª"),
        p = headers.indexOf("process_lable");

  if (c > -1 && p > -1) {
    const channel = row[c]?.toString().trim();
    const value = row[p];

    if (channel === "Whatsapp" || channel === "SMS") return value;
  }
  return "";
}



function transferCompletedRowsFor_ASIA() {
  transferCompletedRowsFor("CC");
}


function transferCompletedRowsFor_VIP() {
  transferCompletedRowsFor("VIP");
}

function transferCompletedRowsFor_LATAM() {
  transferCompletedRowsFor("LATAM");
}

function transferCompletedRowsFor_AFRICA() {
  transferCompletedRowsFor("AFRICA");
}

function transferCompletedRowsFor_NIGERIA() {
  transferCompletedRowsFor("NIGERIA");
}

