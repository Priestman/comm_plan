const SLACK_WEBHOOK_URL = "nnnn";

// –ï–î–ò–ù–´–ô –ü–û–õ–£–ß–ê–¢–ï–õ–¨ –£–í–ï–î–û–ú–õ–ï–ù–ò–ô (–¥–ª—è –≤—Å–µ—Ö –ö–ü)
const GLOBAL_RECIPIENT_SLACK_ID = "U0765NHTV4M"; // –û—Å—Ç–∞–≤–ª–µ–Ω –∫–∞–∫ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞, –Ω–æ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏

// –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—É—á–∞—Ç–µ–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ö–ü
const CIS_RECIPIENT_SLACK_ID = "U06RJEU1USW";
const AZTR_RECIPIENT_SLACK_ID = "U09DX6ZRPC6";

// –û–∂–∏–¥–∞–µ–º—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è —Å—Ç–æ–ª–±—Ü–æ–≤ –≤ —Ä–∞–±–æ—á–∏—Ö —Ñ–∞–π–ª–∞—Ö –ö–ü
const COLUMN_NAMES = {
  DATE: "–î–∞—Ç–∞",
  ROW_CORRECTNESS: "–ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Å—Ç—Ä–æ–∫–∏",
  DISTRIBUTION_STATUS: "–°—Ç–∞—Ç—É—Å —Ä–∞—Å—Å—ã–ª–∫–∏",
  PROCESS_LABEL: "process_lable"
};


/**
 * –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Å–µ—Ö –ö–ü –Ω–∞ –æ—à–∏–±–∫–∏ –ø–µ—Ä–µ–Ω–æ—Å–∞ –¥–∞–Ω–Ω—ã—Ö.
 * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ö–ü –∏–∑ ScriptProperties ("active_kps").
 */
function checkKPErrors() {
  const scriptProperties = PropertiesService.getScriptProperties();
  const activeKPs = JSON.parse(scriptProperties.getProperty("active_kps") || "[]");
  
  const dateRange = getYesterdayDateRange();
  const allErrorsByKP = {};

  // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –ª–∏—Å—Ç–∞ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞ 
  const today = new Date();
  const currentSheetName = Utilities.formatDate(today, SpreadsheetApp.getActiveSpreadsheet().getSpreadsheetTimeZone(), "MMMM_yyyy");
  
  Logger.log(`‚úÖ –ù–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –æ—à–∏–±–æ–∫ –ø–µ—Ä–µ–Ω–æ—Å–∞ –∑–∞: ${dateRange.start.toLocaleString()}. –¶–µ–ª–µ–≤–æ–π –ª–∏—Å—Ç: ${currentSheetName}`);

  for (const kp of activeKPs) {
    const kpName = kp.name;        
    const spreadsheetId = kp.id_work; 

    Logger.log(`‚û°Ô∏è –û–±—Ä–∞–±–æ—Ç–∫–∞ –ö–ü: ${kpName}`);
    
    if (!spreadsheetId) {
       Logger.log(`‚ùå –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ö–ü "${kpName}": –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç id_work –≤ ScriptProperties.`);
       continue;
    }

    try {
      findErrorsInKP(spreadsheetId, kpName, dateRange, allErrorsByKP, currentSheetName);
    } catch (e) {
      Logger.log(`‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞/–æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç–∞–±–ª–∏—Ü—ã ${kpName} (ID: ${spreadsheetId}): ${e.toString()}`);
    }
  }
  
  sendSlackAlerts(allErrorsByKP);
}

// --------------------------------------------------------------------

/**
 * –ò—â–µ—Ç –æ—à–∏–±–∫–∏ –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ –ö–ü –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –∏—Ö –≤ –æ–±—â–∏–π –æ–±—ä–µ–∫—Ç.
 * @param {string} spreadsheetId ID —Ä–∞–±–æ—á–µ–≥–æ —Ñ–∞–π–ª–∞ –ö–ü.
 * @param {string} kpName –ò–º—è –ö–ü.
 * @param {object} dateRange –û–±—ä–µ–∫—Ç —Å –¥–∞—Ç–∞–º–∏ start –∏ end –¥–ª—è –≤—á–µ—Ä–∞—à–Ω–µ–≥–æ –¥–Ω—è.
 * @param {object} allErrorsByKP –û–±—â–∏–π –æ–±—ä–µ–∫—Ç –¥–ª—è –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è –æ—à–∏–±–æ–∫.
 * @param {string} sheetName –ò–º—è –ª–∏—Å—Ç–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏.
 */
function findErrorsInKP(spreadsheetId, kpName, dateRange, allErrorsByKP, sheetName) {
  const kpSpreadsheet = SpreadsheetApp.openById(spreadsheetId);
  const sheet = kpSpreadsheet.getSheetByName(sheetName); 

  if (!sheet) {
    Logger.log(`‚ùå –õ–∏—Å—Ç "${sheetName}" –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ö–ü "${kpName}".`);
    return;
  }
  
  // –ü–æ–ª—É—á–∞–µ–º —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–π GID –ª–∏—Å—Ç–∞ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Å—Å—ã–ª–∫–∏
  const sheetGid = sheet.getSheetId(); 

  const data = sheet.getDataRange().getValues();
  
  if (data.length < 2) return;
  
  const headers = data[0];
  const colIndexes = getColumnIndexes(headers, COLUMN_NAMES); 
  
  const missingCols = Object.keys(COLUMN_NAMES).filter(key => colIndexes[key] === undefined);
  if (missingCols.length > 0) {
    const missingNames = missingCols.map(c => COLUMN_NAMES[c]);
    Logger.log(`‚ùå –í –ö–ü ${kpName} (–ª–∏—Å—Ç: ${sheetName}) –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Å—Ç–æ–ª–±—Ü—ã: ${missingNames.join(', ')}`);
    return;
  }
  
  const sheetUrl = kpSpreadsheet.getUrl();
  
  if (!allErrorsByKP[kpName]) {
    allErrorsByKP[kpName] = [];
  }
  
  for (let i = 1; i < data.length; i++) {
    const row = data[i];
    
    const dateValue = row[colIndexes.DATE];
    const correctness = row[colIndexes.ROW_CORRECTNESS] ? row[colIndexes.ROW_CORRECTNESS].toString().trim() : '';
    const status = row[colIndexes.DISTRIBUTION_STATUS] ? row[colIndexes.DISTRIBUTION_STATUS].toString().trim() : '';
    const processLabel = row[colIndexes.PROCESS_LABEL] ? row[colIndexes.PROCESS_LABEL].toString().trim() : '';
    
    // 1. –§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ: –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤—á–µ—Ä–∞
    const rowDate = dateValue instanceof Date ? dateValue : null;
    if (!rowDate || rowDate < dateRange.start || rowDate > dateRange.end) {
      continue;
    }
    
    // 2. –§–∏–ª—å—Ç—Ä –ø–æ "–°—Ç–∞—Ç—É—Å —Ä–∞—Å—Å—ã–ª–∫–∏"
    if (status !== "–í—ã–ø–æ–ª–Ω–µ–Ω–∞") {
      continue;
    }
    
    // 3. –§–∏–ª—å—Ç—Ä –ø–æ "–ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Å—Ç—Ä–æ–∫–∏": –Ω–µ –ø—É—Å—Ç–æ –ò –Ω–µ "–ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –≤ –ë–î"
    if (correctness === "" || correctness === "–ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –≤ –ë–î") {
      continue;
    }
    
    // –°—Ç—Ä–æ–∫–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –≤—Å–µ–º —É—Å–ª–æ–≤–∏—è–º –æ—à–∏–±–∫–∏
    
    const rowNumber = i + 1;
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π sheetGid –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Å—Å—ã–ª–∫–∏
    const link = `${sheetUrl}#gid=${sheetGid}&range=A${rowNumber}`; 
    
    allErrorsByKP[kpName].push({
      link: link,
      rowNumber: rowNumber,
      error: correctness,
      processLabel: processLabel
    });
  }
}

/**
 * –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∏–Ω–¥–µ–∫—Å—ã —Å—Ç–æ–ª–±—Ü–æ–≤ –ø–æ –∏—Ö –Ω–∞–∑–≤–∞–Ω–∏—è–º –≤ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–µ.
 * @param {Array<string>} headers –ú–∞—Å—Å–∏–≤ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ —Å—Ç–æ–ª–±—Ü–æ–≤.
 * @param {object} requiredColumns –û–±—ä–µ–∫—Ç COLUMN_NAMES, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π –∏—Å–∫–æ–º—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è.
 * @returns {object} –û–±—ä–µ–∫—Ç, –≥–¥–µ –∫–ª—é—á ‚Äî —ç—Ç–æ –∫–ª—é—á –∏–∑ COLUMN_NAMES, –∞ –∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî –∏–Ω–¥–µ–∫—Å —Å—Ç–æ–ª–±—Ü–∞ (0-based).
 */
function getColumnIndexes(headers, requiredColumns) {
  const indexes = {};
  const headerMap = {};
  
  headers.forEach((header, index) => {
    headerMap[header.toString().trim().toLowerCase()] = index;
  });
  
  for (const key in requiredColumns) {
    const requiredName = requiredColumns[key].trim().toLowerCase();
    indexes[key] = headerMap[requiredName];
  }
  
  return indexes;
}


/**
 * –§–æ—Ä–º–∏—Ä—É–µ—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ–¥–Ω–æ –æ–±—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–∞—Ö –≤ Slack.
 * @param {object} allErrorsByKP –°–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ –ø–æ –ö–ü.
 */
function sendSlackAlerts(allErrorsByKP) {
  const allKPNames = Object.keys(allErrorsByKP).filter(kp => allErrorsByKP[kp].length > 0);
  
  if (allKPNames.length === 0) {
    Logger.log("‚úÖ –û—à–∏–±–∫–∏ –ø–µ—Ä–µ–Ω–æ—Å–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—á–µ—Ä–∞—à–Ω–∏–π –¥–µ–Ω—å –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.");
    return;
  }
  
  Logger.log(`üì£ –ù–∞–π–¥–µ–Ω–æ –æ—à–∏–±–æ–∫ –≤ ${allKPNames.length} –ö–ü. –°–æ–æ–±—â–µ–Ω–∏–µ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Slack.`);

  let messageText = ""; 
  let mentions = ""; // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —É–ø–æ–º–∏–Ω–∞–Ω–∏–π
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –æ—à–∏–±–∫–∏ –≤ –ö–ü "CIS" –∏–ª–∏ "AZTR", –∏ –¥–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è
  // –ò–º–µ–Ω–∞ –ö–ü –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å—Ç—Ä–æ–≥–æ "CIS" –∏ "AZTR" (—Ä–µ–≥–∏—Å—Ç—Ä–æ–∑–∞–≤–∏—Å–∏–º–æ)
  if (allErrorsByKP["CIS"] && allErrorsByKP["CIS"].length > 0) {
    mentions += `<@${CIS_RECIPIENT_SLACK_ID}> `;
  }
  if (allErrorsByKP["AZTR"] && allErrorsByKP["AZTR"].length > 0) {
    mentions += `<@${AZTR_RECIPIENT_SLACK_ID}> `;
  }
  
  // –î–æ–±–∞–≤–ª—è–µ–º —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –≤ –Ω–∞—á–∞–ª–æ —Å–æ–æ–±—â–µ–Ω–∏—è
  if (mentions.length > 0) {
    messageText += mentions.trim() + "\n\n";
  }
  
  messageText += "üö® *–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–Ω–æ—Å–µ –¥–∞–Ω–Ω—ã—Ö* –≤ —Å–≤—è–∑–∏ —Å –æ—à–∏–±–∫–æ–π –≤ –ø–æ–ª–µ `–ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Å—Ç—Ä–æ–∫–∏`.\n\n";
  
  for (const kpName of allKPNames) {
    const errors = allErrorsByKP[kpName];
    if (errors.length === 0) continue;
    
    messageText += `*${kpName}:*\n`;
    
    errors.forEach((err, index) => {
      // ‚ùó –ò–ó–ú–ï–ù–ï–ù–ò–ï: –§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞ –æ—à–∏–±–∫–∏ ‚ùó
      let errorLine = `${index + 1}. <${err.link}|–°—Ç—Ä–æ–∫–∞ ${err.rowNumber}>, –û—à–∏–±–∫–∞: \`${err.error}\``;
      
      // –£–±–∏—Ä–∞–µ–º –≤—ã–≤–æ–¥ Process Label, –µ—Å–ª–∏ –æ–Ω N/A –∏–ª–∏ –ø—É—Å—Ç–æ–π
      if (err.processLabel && err.processLabel.toUpperCase() !== 'N/A') {
          errorLine += `, Process Label: \`${err.processLabel}\``;
      }
      
      messageText += errorLine + '\n';
    });
    messageText += "\n"; 
  }

  sendSlackMessage({ text: messageText });
}


/**
 * –ê–ö–¢–ò–í–ò–†–û–í–ê–ù–û: –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Slack —á–µ—Ä–µ–∑ Webhook.
 * @param {object} payload –û–±—ä–µ–∫—Ç Slack payload —Å –ø–æ–ª–µ–º text.
 */
function sendSlackMessage(payload) {
  try {
    const options = {
      'method' : 'post',
      'contentType': 'application/json',
      'payload' : JSON.stringify(payload)
    };
    
    UrlFetchApp.fetch(SLACK_WEBHOOK_URL, options);
    Logger.log("‚úÖ –£—Å–ø–µ—à–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Slack.");
    
  } catch (e) {
    Logger.log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Slack: ${e.toString()}`);
  }
}

/**
 * –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ–π –¥–∏–∞–ø–∞–∑–æ–Ω –¥–ª—è –≤—á–µ—Ä–∞—à–Ω–µ–≥–æ –¥–Ω—è (—Å 00:00:00 –¥–æ 23:59:59).
 * @returns {object} –û–±—ä–µ–∫—Ç —Å –¥–∞—Ç–∞–º–∏ start –∏ end.
 */
function getYesterdayDateRange() {
  const today = new Date();
  const timeZone = SpreadsheetApp.getActiveSpreadsheet().getSpreadsheetTimeZone();

  const yesterday = new Date(today);
  yesterday.setDate(today.getDate() - 1);
  
  const formattedYesterday = Utilities.formatDate(yesterday, timeZone, "yyyy-MM-dd");
  
  const start = new Date(formattedYesterday + "T00:00:00");
  const end = new Date(formattedYesterday + "T23:59:59");
  
  return { start, end };
}
